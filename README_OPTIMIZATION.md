# Smart Factory - Оптимизация для Production

## Обзор оптимизаций

Данный проект был оптимизирован для стабильной работы с высокой нагрузкой (500+ пользователей) и включает в себя:

- **Production настройки Django** с оптимизированными параметрами
- **Кэширование** на всех уровнях (Redis, Django cache, view cache)
- **Оптимизация базы данных** с индексами и настройками PostgreSQL
- **Фоновые задачи** через Celery для тяжелых операций
- **Оптимизированный веб-сервер** (Gunicorn + Nginx)
- **Мониторинг и логирование** для отслеживания производительности

## Структура оптимизаций

### 1. Production Settings (`core/settings_production.py`)
- Отключение DEBUG режима
- Настройка PostgreSQL вместо SQLite
- Конфигурация Redis для кэширования
- Оптимизированные настройки безопасности
- Настройка логирования и мониторинга

### 2. WSGI оптимизация (`core/wsgi_production.py`)
- Оптимизированный WSGI файл для production
- Интеграция с WhiteNoise для статических файлов
- Настройка путей для production

### 3. Gunicorn конфигурация (`gunicorn.conf.py`)
- Оптимальное количество воркеров
- Настройки таймаутов и производительности
- Логирование и мониторинг процессов

### 4. Nginx конфигурация (`nginx.conf`)
- Reverse proxy для Gunicorn
- Gzip сжатие
- Rate limiting для API
- Оптимизация статических файлов
- Безопасность и SSL готовность

### 5. Celery конфигурация (`core/celery.py`)
- Фоновые задачи для тяжелых операций
- Очереди для разных типов задач
- Мониторинг и логирование
- Автоматические задачи (очистка логов, бэкапы)

### 6. Оптимизированные модели (`apps/orders/models_optimized.py`)
- Кэширование на уровне моделей
- Оптимизированные QuerySet'ы
- Автоматическая очистка кэша
- Индексы для быстрого поиска

### 7. Оптимизированные views (`apps/orders/views_optimized.py`)
- Кэширование на уровне views
- Оптимизированные запросы к БД
- Пагинация и фильтрация
- API с кэшированием

### 8. Системные задачи (`core/tasks.py`)
- Автоматическая очистка логов
- Обслуживание базы данных
- Мониторинг системы
- Резервное копирование

### 9. Скрипт оптимизации БД (`scripts/optimize_database.py`)
- Создание индексов
- Анализ таблиц
- Оптимизация настроек PostgreSQL
- Сбор статистики производительности

## Ключевые оптимизации

### Производительность базы данных
- **Индексы** для всех часто используемых полей
- **Connection pooling** для эффективного использования соединений
- **Query optimization** с select_related и prefetch_related
- **Database maintenance** через Celery задачи

### Кэширование
- **Redis** для сессий и кэша
- **Django cache** для моделей и views
- **View-level caching** для часто запрашиваемых страниц
- **Model-level caching** для вычисляемых полей

### Веб-сервер
- **Gunicorn** с оптимальным количеством воркеров
- **Nginx** как reverse proxy с оптимизациями
- **Static files** через WhiteNoise с сжатием
- **Rate limiting** для защиты от DDoS

### Фоновые задачи
- **Celery** для тяжелых операций
- **Queue management** для разных типов задач
- **Automatic maintenance** (очистка логов, бэкапы)
- **System monitoring** и алерты

## Установка и настройка

### 1. Установка зависимостей
```bash
pip install -r requirements_production.txt
```

### 2. Настройка переменных окружения
Создайте файл `.env` с настройками для production:
```env
DB_NAME=smart_factory
DB_USER=smart_factory_user
DB_PASSWORD=your_password
REDIS_URL=redis://127.0.0.1:6379/0
DJANGO_SETTINGS_MODULE=core.settings_production
```

### 3. Миграция базы данных
```bash
python manage.py migrate --settings=core.settings_production
```

### 4. Сбор статических файлов
```bash
python manage.py collectstatic --settings=core.settings_production
```

### 5. Оптимизация базы данных
```bash
python scripts/optimize_database.py
```

## Запуск в production

### 1. Запуск Gunicorn
```bash
gunicorn --config gunicorn.conf.py core.wsgi_production:application
```

### 2. Запуск Celery
```bash
celery -A core.celery worker --loglevel=info
celery -A core.celery beat --loglevel=info
```

### 3. Запуск Nginx
```bash
sudo systemctl start nginx
```

## Мониторинг производительности

### 1. Логи Django
```bash
tail -f logs/django.log
```

### 2. Логи Gunicorn
```bash
sudo journalctl -u smart_factory -f
```

### 3. Логи Celery
```bash
tail -f /var/log/celery/worker1.log
```

### 4. Статистика базы данных
```bash
sudo -u postgres psql -d smart_factory -c "SELECT * FROM pg_stat_activity;"
```

### 5. Статистика Redis
```bash
redis-cli info memory
redis-cli info stats
```

## Настройка для высокой нагрузки

### 1. Масштабирование по горизонтали
- Добавление дополнительных серверов приложений
- Настройка балансировщика нагрузки
- Репликация базы данных

### 2. Масштабирование по вертикали
- Увеличение ресурсов сервера
- Оптимизация кода и запросов
- Настройка кэширования

### 3. Оптимизация кэша
- Увеличение размера Redis
- Настройка TTL для разных типов данных
- Мониторинг hit/miss ratio

## Безопасность

### 1. Настройки Django
- Отключение DEBUG режима
- Настройка ALLOWED_HOSTS
- Безопасные настройки сессий
- CSRF защита

### 2. Настройки Nginx
- Rate limiting
- Безопасные заголовки
- Ограничение размера файлов
- SSL/TLS готовность

### 3. Настройки базы данных
- Ограничение подключений
- Логирование медленных запросов
- Регулярные обновления

## Резервное копирование

### 1. Автоматические бэкапы
- Ежедневные бэкапы базы данных
- Еженедельные бэкапы медиа файлов
- Автоматическая очистка старых бэкапов

### 2. Мониторинг бэкапов
- Проверка успешности бэкапов
- Уведомления об ошибках
- Логирование всех операций

## Troubleshooting

### 1. Медленные запросы
- Анализ логов PostgreSQL
- Проверка индексов
- Оптимизация QuerySet'ов

### 2. Проблемы с памятью
- Мониторинг использования Redis
- Настройка TTL для кэша
- Очистка неиспользуемых данных

### 3. Проблемы с производительностью
- Анализ логов Gunicorn
- Проверка количества воркеров
- Мониторинг системных ресурсов

## Заключение

Данная оптимизация обеспечивает:

- **Высокую производительность** при нагрузке до 500+ пользователей
- **Стабильную работу** системы без сбоев
- **Эффективное использование ресурсов** сервера
- **Автоматическое обслуживание** и мониторинг
- **Возможность масштабирования** для роста нагрузки

Для дальнейшей оптимизации рекомендуется:
- Регулярный анализ производительности
- Мониторинг использования ресурсов
- Оптимизация на основе реальных метрик
- Планирование масштабирования 