<!DOCTYPE html>
<html lang="ru" x-data="masterDashboard()" x-init="init()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель мастера — Smart Factory</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1); }
        .workshop-card { transition: all 0.3s ease; }
        .workshop-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1); }
        .progress-bar { transition: width 0.6s ease; }
        .chart-container { position: relative; height: 300px; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                        <span class="text-white font-bold text-2xl">M</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold text-gray-900">Панель мастера</h1>
                        <p class="text-sm text-gray-600" x-text="userName"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button @click="refreshData()" class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    </button>
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm font-medium" x-text="userInitial"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <template x-if="loading">
            <div class="flex items-center justify-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        </template>

        <!-- Dashboard Content -->
        <template x-if="!loading">
            <div class="space-y-8">
                <!-- Overview Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="stat-card card bg-white rounded-xl p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i data-lucide="factory" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Цеха</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="overview.total_workshops"></p>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card card bg-white rounded-xl p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <i data-lucide="users" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Сотрудники</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="overview.total_employees"></p>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card card bg-white rounded-xl p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <i data-lucide="clipboard-list" class="w-6 h-6 text-purple-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Активные заказы</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="overview.total_active_orders"></p>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card card bg-white rounded-xl p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-orange-100 rounded-lg">
                                <i data-lucide="target" class="w-6 h-6 text-orange-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Задач в день</p>
                                <p class="text-2xl font-bold text-gray-900" x-text="overview.tasks_per_day"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quality and Production Stats -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card bg-white rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Производство за 30 дней</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">Произведено</span>
                                <span class="text-lg font-semibold text-green-600" x-text="overview.products_made_30_days + ' шт.'"></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">Брак</span>
                                <span class="text-lg font-semibold text-red-600" x-text="overview.defective_products_30_days + ' шт.'"></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600">Качество</span>
                                <span class="text-lg font-semibold text-blue-600" x-text="overview.quality_rate + '%'"></span>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-white rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">График производительности</h3>
                        <div class="chart-container">
                            <canvas id="productivityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Workshops List -->
                <div class="card bg-white rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Мои цеха</h3>
                        <span class="text-sm text-gray-500" x-text="`${workshops.length} цехов`"></span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <template x-for="workshop in workshops" :key="workshop.id">
                            <div class="workshop-card bg-gray-50 rounded-xl p-6 border border-gray-200 cursor-pointer"
                                 @click="selectWorkshop(workshop)">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900 mb-1" x-text="workshop.name"></h4>
                                        <p class="text-sm text-gray-600" x-text="workshop.description"></p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <template x-if="workshop.is_main_manager">
                                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Главный</span>
                                        </template>
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="text-center">
                                        <div class="text-lg font-semibold text-gray-900" x-text="workshop.employees_count"></div>
                                        <div class="text-xs text-gray-600">Сотрудников</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-semibold text-gray-900" x-text="workshop.active_tasks"></div>
                                        <div class="text-xs text-gray-600">Задач</div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-600">Активные заказы</span>
                                        <span class="font-medium text-gray-900" x-text="workshop.active_orders"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </main>

    <!-- Workshop Details Modal -->
    <template x-if="selectedWorkshop">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-gray-900" x-text="selectedWorkshop.name"></h3>
                        <button @click="selectedWorkshop = null" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <template x-if="workshopDetailsLoading">
                        <div class="flex items-center justify-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        </div>
                    </template>
                    
                    <template x-if="!workshopDetailsLoading && workshopDetails">
                        <div class="space-y-6">
                            <!-- Workshop Summary -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-gray-900" x-text="workshopDetails.workshop.employees_count"></div>
                                    <div class="text-sm text-gray-600">Сотрудников</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-gray-900" x-text="workshopDetails.workshop.active_orders"></div>
                                    <div class="text-sm text-gray-600">Заказов</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-600" x-text="workshopDetails.workshop.products_made_30_days"></div>
                                    <div class="text-sm text-gray-600">Произведено</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-600" x-text="workshopDetails.workshop.quality_rate + '%'"></div>
                                    <div class="text-sm text-gray-600">Качество</div>
                                </div>
                            </div>
                            
                            <!-- Active Orders -->
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Активные заказы</h4>
                                <div class="space-y-3">
                                    <template x-for="order in workshopDetails.orders" :key="order.id">
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <h5 class="font-medium text-gray-900" x-text="order.order_name"></h5>
                                                <span class="text-sm text-gray-500" x-text="order.operation"></span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-3" x-text="order.product_name"></p>
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1 mr-4">
                                                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                                                        <span>Прогресс</span>
                                                        <span x-text="`${order.completed_quantity}/${order.plan_quantity}`"></span>
                                                    </div>
                                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                                        <div class="bg-blue-500 h-2 rounded-full progress-bar" 
                                                             :style="`width: ${order.progress_percent}%`"></div>
                                                    </div>
                                                </div>
                                                <span class="text-sm text-gray-500" x-text="order.progress_percent + '%'"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- Employees Performance -->
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Производительность сотрудников</h4>
                                <div class="space-y-3">
                                    <template x-for="employee in workshopDetails.employees" :key="employee.id">
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <h5 class="font-medium text-gray-900" x-text="employee.name"></h5>
                                                <span class="text-sm text-green-600 font-medium" x-text="employee.quality_rate + '%'"></span>
                                            </div>
                                            <div class="grid grid-cols-3 gap-4 text-sm">
                                                <div>
                                                    <span class="text-gray-600">Выполнено:</span>
                                                    <span class="font-medium text-gray-900 ml-1" x-text="employee.completed_quantity"></span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-600">Брак:</span>
                                                    <span class="font-medium text-red-600 ml-1" x-text="employee.defective_quantity"></span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-600">Заработок:</span>
                                                    <span class="font-medium text-gray-900 ml-1" x-text="employee.earnings + ' ₽'"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>

    <script>
        function masterDashboard() {
            return {
                loading: true,
                overview: {},
                workshops: [],
                selectedWorkshop: null,
                workshopDetails: null,
                workshopDetailsLoading: false,
                userName: '',
                userInitial: '',
                productivityChart: null,
                
                async init() {
                    lucide.createIcons();
                    await this.loadData();
                    this.initChart();
                },
                
                async loadData() {
                    try {
                        this.loading = true;
                        
                        // Загружаем данные параллельно
                        const [overviewResponse, workshopsResponse] = await Promise.all([
                            fetch('/workshops/api/master/overview/'),
                            fetch('/workshops/api/master/workshops/')
                        ]);
                        
                        if (overviewResponse.ok) {
                            this.overview = await overviewResponse.json();
                        }
                        
                        if (workshopsResponse.ok) {
                            this.workshops = await workshopsResponse.json();
                        }
                        
                        // Получаем информацию о пользователе
                        this.userName = '{{ request.user.get_full_name }}' || '{{ request.user.username }}';
                        this.userInitial = this.userName.charAt(0).toUpperCase();
                        
                    } catch (error) {
                        console.error('Ошибка загрузки данных:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                async refreshData() {
                    await this.loadData();
                },
                
                async selectWorkshop(workshop) {
                    this.selectedWorkshop = workshop;
                    this.workshopDetails = null;
                    this.workshopDetailsLoading = true;
                    
                    try {
                        const response = await fetch(`/workshops/api/master/workshop/${workshop.id}/stats/`);
                        if (response.ok) {
                            this.workshopDetails = await response.json();
                        }
                    } catch (error) {
                        console.error('Ошибка загрузки деталей цеха:', error);
                    } finally {
                        this.workshopDetailsLoading = false;
                    }
                },
                
                initChart() {
                    const ctx = document.getElementById('productivityChart');
                    if (!ctx) return;
                    
                    this.productivityChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                            datasets: [{
                                label: 'Производительность',
                                data: [65, 78, 90, 85, 95, 70, 88],
                                borderColor: '#3B82F6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#3B82F6',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
</body>
</html>