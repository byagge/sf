<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Браки — Список дефектов</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #e0e7ef; border-radius: 4px; }
        aside::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 py-4 fixed top-0 left-0 right-0 z-30">
        <div class="flex items-center justify-between px-4 sm:px-6">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-xl">S</span>
                </div>
                <span class="text-xl font-semibold text-gray-900">Smart Factory</span>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/notifications/" class="text-gray-600 hover:text-gray-900 relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                </a>
                <a href="/settings/" class="text-gray-600 hover:text-gray-900">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </a>
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm">С</span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 p-4 space-y-6 fixed left-0 top-20 bottom-0 overflow-y-auto scrollbar-none z-20" style="scrollbar-width: none; -ms-overflow-style: none;">
        <div>
            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Навигация</h3>
            <nav class="space-y-1">
                <a href="/dashboard/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span>Главная</span>
                </a>
                <a href="/employees/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span>Сотрудники</span>
                </a>
                <a href="/clients/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="user-plus" class="w-5 h-5"></i>
                    <span>Клиенты</span>
                </a>
                <a href="/inventory/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="package" class="w-5 h-5"></i>
                    <span>Склад/Материалы</span>
                </a>
                <a href="/defects/" class="flex items-center space-x-3 px-3 py-2 rounded-lg bg-red-50 text-red-600">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                    <span>Браки</span>
                </a>
                <a href="/schedules/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    <span>Записи</span>
                </a>
                <a href="/services/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="scissors" class="w-5 h-5"></i>
                    <span>Услуги</span>
                </a>
                <a href="/settings/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span>Настройки</span>
                </a>
            </nav>
        </div>
    </aside>
    <!-- Main Content -->
    <main class="flex-1 overflow-auto ml-64 p-6 pt-28" x-data="defectsData()" x-init="init()">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6 flex flex-col lg:flex-row lg:items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Браки (дефекты)</h1>
                <p class="text-gray-600">Управление браками и их восстановлением</p>
            </div>
            <div class="flex items-center space-x-4 mt-4 lg:mt-0">
                <input type="text" placeholder="Поиск..." x-model="searchTerm"
                    class="pl-4 pr-4 py-2 w-full lg:w-64 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select x-model="statusFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Все статусы</option>
                    <option value="pending_master_review">Ожидает проверки мастера</option>
                    <option value="master_confirmed">Подтвержден мастером</option>
                    <option value="can_be_fixed">Можно починить</option>
                    <option value="sent_to_workshop">Отправлен в цех</option>
                    <option value="fixed">Исправлен</option>
                    <option value="unrepairable">Не подлежит восстановлению</option>
                </select>
            </div>
        </div>
        <!-- Статистика браков -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-red-50 rounded-xl p-6 flex items-center justify-between">
                <div>
                    <p class="text-sm text-red-600">Всего браков</p>
                    <p class="text-2xl font-bold text-red-900" x-text="stats().totalDefects"></p>
                </div>
                <i data-lucide="alert-triangle" class="text-red-600 w-8 h-8"></i>
            </div>
            <div class="bg-yellow-50 rounded-xl p-6 flex items-center justify-between">
                <div>
                    <p class="text-sm text-yellow-600">Ожидают проверки</p>
                    <p class="text-2xl font-bold text-yellow-900" x-text="stats().pendingReview"></p>
                </div>
                <i data-lucide="clock" class="text-yellow-600 w-8 h-8"></i>
            </div>
            <div class="bg-blue-50 rounded-xl p-6 flex items-center justify-between">
                <div>
                    <p class="text-sm text-blue-600">В восстановлении</p>
                    <p class="text-2xl font-bold text-blue-900" x-text="stats().inRepair"></p>
                </div>
                <i data-lucide="wrench" class="text-blue-600 w-8 h-8"></i>
            </div>
            <div class="bg-green-50 rounded-xl p-6 flex items-center justify-between">
                <div>
                    <p class="text-sm text-green-600">Исправлено</p>
                    <p class="text-2xl font-bold text-green-900" x-text="stats().fixed"></p>
                </div>
                <i data-lucide="check-circle" class="text-green-600 w-8 h-8"></i>
            </div>
        </div>
        
        <!-- Список браков -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left">Продукт</th>
                            <th class="px-4 py-3 text-left">Сотрудник</th>
                            <th class="px-4 py-3 text-left">Статус</th>
                            <th class="px-4 py-3 text-left">Тип брака</th>
                            <th class="px-4 py-3 text-left">Дата</th>
                            <th class="px-4 py-3 text-left">Действия</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="defect in filteredDefects()" :key="defect.id">
                            <tr>
                                <td class="px-4 py-3">
                                    <div class="flex items-center">
                                        <span x-text="defect.product && defect.product.name ? defect.product.name : 'N/A'"></span>
                                    </div>
                                </td>
                                <td class="px-4 py-3" x-text="defect.user && defect.user.full_name ? defect.user.full_name : 'N/A'"></td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs rounded-full" 
                                          :class="getStatusClass(defect.status)"
                                          x-text="getStatusText(defect.status)"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span x-text="defect.defect_type ? getDefectTypeText(defect.defect_type) : '-'"></span>
                                </td>
                                <td class="px-4 py-3" x-text="formatDate(defect.created_at)"></td>
                                <td class="px-4 py-3">
                                    <div class="flex space-x-2">
                                        <!-- Кнопка для мастера -->
                                        <template x-if="defect.status === 'pending_master_review' && isMaster()">
                                            <button @click="showMasterReviewModal(defect)" 
                                                    class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                                Проверить
                                            </button>
                                        </template>
                                        
                                        <!-- Кнопка для рабочего -->
                                        <template x-if="defect.status === 'sent_to_workshop' && isWorker()">
                                            <button @click="markAsFixed(defect)" 
                                                    class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                                Исправлено
                                            </button>
                                        </template>
                                        
                                        <!-- Информация о подтверждении -->
                                        <template x-if="defect.master_confirmed_by">
                                            <span class="text-xs text-gray-500" 
                                                  x-text="'Подтвержден: ' + defect.master_confirmed_by.full_name"></span>
                                        </template>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div x-show="filteredDefects().length === 0" class="text-center py-12">
                <i data-lucide="alert-triangle" class="mx-auto text-gray-400 mb-4" style="width: 48px; height: 48px;"></i>
                <p class="text-gray-500 text-lg">Браки не найдены</p>
            </div>
        </div>
    </main>

    <!-- Модальное окно подтверждения проверки -->
    <div x-show="showConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" @click="showConfirmationModal = false">
        <div class="bg-white rounded-lg max-w-md w-full p-6" @click.stop>
            <h3 class="text-lg font-semibold mb-4">Подтверждение проверки</h3>
            <p class="text-gray-600 mb-4">Вы подтверждаете, что подошли и тщательно проверили брак?</p>
            <div class="flex space-x-3">
                <button @click="confirmInspection()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Да, подтверждаю
                </button>
                <button @click="showConfirmationModal = false" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    Отмена
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно оценки возможности восстановления -->
    <div x-show="showRepairabilityModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" @click="showRepairabilityModal = false">
        <div class="bg-white rounded-lg max-w-md w-full p-6" @click.stop>
            <h3 class="text-lg font-semibold mb-4">Оценка восстановления</h3>
            <p class="text-gray-600 mb-4">Можно ли починить брак?</p>
            <div class="flex space-x-3">
                <button @click="setRepairability(true)" 
                        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    Да, можно починить
                </button>
                <button @click="setRepairability(false)" 
                        class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                    Нет, нельзя починить
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно выбора цеха для восстановления -->
    <div x-show="showWorkshopModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" @click="showWorkshopModal = false">
        <div class="bg-white rounded-lg max-w-md w-full p-6" @click.stop>
            <h3 class="text-lg font-semibold mb-4">Выбор цеха</h3>
            <p class="text-gray-600 mb-4">В какой цех перевести брак для восстановления?</p>
            <select x-model="selectedWorkshop" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-4">
                <option value="">Выберите цех</option>
                <template x-for="workshop in availableWorkshops" :key="workshop.id">
                    <option :value="workshop.id" x-text="workshop.name"></option>
                </template>
            </select>
            <div class="flex space-x-3">
                <button @click="sendToWorkshop()" 
                        :disabled="!selectedWorkshop"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">
                    Отправить в цех
                </button>
                <button @click="showRepairabilityModal = true; showWorkshopModal = false" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    Назад
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно выбора типа брака -->
    <div x-show="showDefectTypeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" @click="showDefectTypeModal = false">
        <div class="bg-white rounded-lg max-w-md w-full p-6" @click.stop>
            <h3 class="text-lg font-semibold mb-4">Тип брака</h3>
            <p class="text-gray-600 mb-4">Выберите вид брака:</p>
            <div class="space-y-3 mb-4">
                <label class="flex items-center">
                    <input type="radio" x-model="selectedDefectType" value="technical" class="mr-2">
                    <span>Технический — штраф не списывается</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" x-model="selectedDefectType" value="manual" class="mr-2">
                    <span>Ручной — штраф списывается с сотрудника</span>
                </label>
            </div>
            <div class="flex space-x-3">
                <button @click="setDefectType()" 
                        :disabled="!selectedDefectType"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">
                    Подтвердить
                </button>
                <button @click="showRepairabilityModal = true; showDefectTypeModal = false" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    Назад
                </button>
            </div>
        </div>
    </div>

    <script>
    function defectsData() {
        return {
            defects: [],
            searchTerm: '',
            statusFilter: '',
            showConfirmationModal: false,
            showRepairabilityModal: false,
            showWorkshopModal: false,
            showDefectTypeModal: false,
            currentDefect: null,
            canBeFixed: null,
            selectedWorkshop: '',
            selectedDefectType: '',
            availableWorkshops: [],
            
            async fetchDefects() {
                try {
                    const resp = await fetch('/defects/api/defects/');
                    const data = await resp.json();
                    this.defects = data.results || data;
                } catch (error) {
                    console.error('Ошибка загрузки браков:', error);
                }
            },
            
            async fetchWorkshops() {
                try {
                    const resp = await fetch('/operations/workshops/api/workshops/');
                    const data = await resp.json();
                    this.availableWorkshops = data.results || data;
                } catch (error) {
                    console.error('Ошибка загрузки цехов:', error);
                }
            },
            
            filteredDefects() {
                let filtered = this.defects;
                
                if (this.statusFilter) {
                    filtered = filtered.filter(d => d.status === this.statusFilter);
                }
                
                if (this.searchTerm) {
                    const term = this.searchTerm.toLowerCase();
                    filtered = filtered.filter(d =>
                        (d.product && d.product.name ? d.product.name : '').toLowerCase().includes(term) ||
                        (d.user && d.user.full_name ? d.user.full_name : '').toLowerCase().includes(term)
                    );
                }
                
                return filtered;
            },
            
            formatDate(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return d.toLocaleString('ru-RU');
            },
            
            getStatusText(status) {
                const statusMap = {
                    'pending_master_review': 'Ожидает проверки',
                    'master_confirmed': 'Подтвержден мастером',
                    'can_be_fixed': 'Можно починить',
                    'sent_to_workshop': 'Отправлен в цех',
                    'fixed': 'Исправлен',
                    'unrepairable': 'Не подлежит восстановлению'
                };
                return statusMap[status] || status;
            },
            
            getStatusClass(status) {
                const classMap = {
                    'pending_master_review': 'bg-yellow-100 text-yellow-800',
                    'master_confirmed': 'bg-blue-100 text-blue-800',
                    'can_be_fixed': 'bg-green-100 text-green-800',
                    'sent_to_workshop': 'bg-purple-100 text-purple-800',
                    'fixed': 'bg-green-100 text-green-800',
                    'unrepairable': 'bg-red-100 text-red-800'
                };
                return classMap[status] || 'bg-gray-100 text-gray-800';
            },
            
            getDefectTypeText(type) {
                const typeMap = {
                    'technical': 'Технический',
                    'manual': 'Ручной'
                };
                return typeMap[type] || type;
            },
            
            isMaster() {
                // Проверяем роль пользователя (нужно будет передать с сервера)
                return true; // Временно для демонстрации
            },
            
            isWorker() {
                // Проверяем роль пользователя
                return true; // Временно для демонстрации
            },
            
            showMasterReviewModal(defect) {
                this.currentDefect = defect;
                this.showConfirmationModal = true;
            },
            
            async confirmInspection() {
                try {
                    const response = await fetch(`/defects/api/defects/${this.currentDefect.id}/confirm_by_master/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCSRFToken()
                        }
                    });
                    
                    if (response.ok) {
                        this.showConfirmationModal = false;
                        this.showRepairabilityModal = true;
                    } else {
                        const error = await response.json();
                        alert('Ошибка: ' + error.error);
                    }
                } catch (error) {
                    console.error('Ошибка подтверждения:', error);
                    alert('Ошибка при подтверждении');
                }
            },
            
            setRepairability(canBeFixed) {
                this.canBeFixed = canBeFixed;
                this.showRepairabilityModal = false;
                
                if (canBeFixed) {
                    this.showWorkshopModal = true;
                } else {
                    this.showDefectTypeModal = true;
                }
            },
            
            async sendToWorkshop() {
                if (!this.selectedWorkshop) return;
                
                try {
                    const response = await fetch(`/defects/api/defects/${this.currentDefect.id}/review_defect/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCSRFToken()
                        },
                        body: JSON.stringify({
                            can_be_fixed: true,
                            target_workshop_id: this.selectedWorkshop,
                            notes: ''
                        })
                    });
                    
                    if (response.ok) {
                        this.showWorkshopModal = false;
                        this.resetMasterReview();
                        await this.fetchDefects();
                        alert('Брак отправлен в цех для восстановления');
                    } else {
                        const error = await response.json();
                        alert('Ошибка: ' + error.error);
                    }
                } catch (error) {
                    console.error('Ошибка отправки в цех:', error);
                    alert('Ошибка при отправке в цех');
                }
            },
            
            async setDefectType() {
                if (!this.selectedDefectType) return;
                
                try {
                    const response = await fetch(`/defects/api/defects/${this.currentDefect.id}/review_defect/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCSRFToken()
                        },
                        body: JSON.stringify({
                            can_be_fixed: false,
                            defect_type: this.selectedDefectType,
                            notes: ''
                        })
                    });
                    
                    if (response.ok) {
                        this.showDefectTypeModal = false;
                        this.resetMasterReview();
                        await this.fetchDefects();
                        alert('Тип брака установлен');
                    } else {
                        const error = await response.json();
                        alert('Ошибка: ' + error.error);
                    }
                } catch (error) {
                    console.error('Ошибка установки типа:', error);
                    alert('Ошибка при установке типа брака');
                }
            },
            
            async markAsFixed(defect) {
                if (!confirm('Подтвердите, что брак исправлен')) return;
                
                try {
                    const response = await fetch(`/defects/api/defects/${defect.id}/mark_as_fixed/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCSRFToken()
                        }
                    });
                    
                    if (response.ok) {
                        await this.fetchDefects();
                        alert('Брак отмечен как исправленный');
                    } else {
                        const error = await response.json();
                        alert('Ошибка: ' + error.error);
                    }
                } catch (error) {
                    console.error('Ошибка отметки исправления:', error);
                    alert('Ошибка при отметке исправления');
                }
            },
            
            resetMasterReview() {
                this.currentDefect = null;
                this.canBeFixed = null;
                this.selectedWorkshop = '';
                this.selectedDefectType = '';
            },
            
            getCSRFToken() {
                return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            },
            
            stats() {
                const totalDefects = this.defects.length;
                const pendingReview = this.defects.filter(d => d.status === 'pending_master_review').length;
                const inRepair = this.defects.filter(d => d.status === 'sent_to_workshop').length;
                const fixed = this.defects.filter(d => d.status === 'fixed').length;
                
                return { totalDefects, pendingReview, inRepair, fixed };
            },
            
            async init() {
                await this.fetchDefects();
                await this.fetchWorkshops();
                this.$nextTick(() => lucide.createIcons());
            }
        }
    }
    
        document.addEventListener('alpine:init', () => {
        Alpine.data('defectsData', defectsData);
        });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
</body>
</html>