<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заявки — Бухгалтерия</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #e0e7ef; border-radius: 4px; }
        aside::-webkit-scrollbar { display: none; }
        .modal-bg { background: rgba(0,0,0,0.35); }
        .animate-slide-up { animation: slideUp 0.25s cubic-bezier(.4,0,.2,1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes success-pop {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.15); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-success-pop {
            animation: success-pop 0.5s cubic-bezier(.4,0,.2,1);
        }
        /* Убираем стрелки у input[type="number"] */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Стили для кнопок количества */
        .quantity-btn {
            transition: all 0.2s ease;
            user-select: none;
        }
        .quantity-btn:hover {
            background-color: #f3f4f6;
        }
        .quantity-btn:active {
            transform: scale(0.95);
        }

        /* Скрытие элементов до инициализации Alpine.js */
        [x-cloak] {
            display: none !important;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <!-- Header -->
    <header style="position:fixed; top:0; left:0; right:0; z-index:30; background:#fff; border-bottom:1px solid #e5e7eb; margin:0;">
        <div style="display:flex; align-items:center; justify-content:space-between; height:56px; padding:0 24px;">
            <div style="display:flex; align-items:center; gap:8px;">
                <div style="width:40px; height:40px; background:#2563eb; border-radius:8px; display:flex; align-items:center; justify-content:center;">
                    <span style="color:#fff; font-weight:bold; font-size:20px;">S</span>
                </div>
                <span style="font-size:20px; font-weight:600; color:#111827;">Заявки</span>
            </div>
            <div style="display:flex; align-items:center; gap:16px;">
                <a href="/notifications/" style="color:#4b5563;">
                    <i data-lucide="bell" style="width:20px; height:20px;"></i>
                </a>
                <a href="/settings/" style="color:#4b5563;">
                    <i data-lucide="settings" style="width:20px; height:20px;"></i>
                </a>
                <div style="width:32px; height:32px; background:#2563eb; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <span style="color:#fff; font-size:14px;">{{ user.username|first|upper }}</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 p-4 space-y-6 fixed left-0 top-20 bottom-0 overflow-y-auto scrollbar-none z-20" style="scrollbar-width: none; -ms-overflow-style: none;">
        <!-- Навигация -->
        <div>
            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Финансы</h3>
            <nav class="space-y-1">
                <a href="{% url 'finance:dashboard' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if request.resolver_match.url_name == 'dashboard' %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span>Дашборд</span>
                </a>
                <a href="{% url 'finance:expenses' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'expense' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="minus-circle" class="w-5 h-5"></i>
                    <span>Расходы</span>
                </a>
                <a href="{% url 'finance:incomes' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'income' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    <span>Доходы</span>
                </a>
                <a href="{% url 'finance:money_movements' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'money' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="arrow-right-left" class="w-5 h-5"></i>
                    <span>Движение денег</span>
                </a>
                <a href="{% url 'finance:debts' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'debt' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="wallet" class="w-5 h-5"></i>
                    <span>Долги</span>
                </a>
            </nav>
        </div>

        <!-- Бухгалтерия -->
        <div>
            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Бухгалтерия</h3>
            <nav class="space-y-1">
                <a href="{% url 'finance:accounts' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'account' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="book-open" class="w-5 h-5"></i>
                    <span>План счетов</span>
                </a>
                <a href="{% url 'finance:analytical_accounts' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'analytical_account' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="layers" class="w-5 h-5"></i>
                    <span>Аналитические счета</span>
                </a>
                <a href="{% url 'finance:journal_entries' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'journal' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    <span>Журнал операций</span>
                </a>
                <a href="{% url 'finance:standard_operations' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'standard_operation' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                    <span>Типовые операции</span>
                </a>
                <a href="{% url 'finance:account_correspondences' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'correspondence' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="arrow-left-right" class="w-5 h-5"></i>
                    <span>Корреспонденции</span>
                </a>
                <a href="{% url 'finance:trial_balance' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'trial_balance' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="calculator" class="w-5 h-5"></i>
                    <span>Оборотно-сальдовая</span>
                </a>
                <a href="{% url 'finance:financial_periods' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'financial_period' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    <span>Финансовые периоды</span>
                </a>
            </nav>
        </div>

        <!-- Справочники -->
        <div>
            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Справочники</h3>
            <nav class="space-y-1">
                <a href="{% url 'finance:expense_categories' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'category' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="tag" class="w-5 h-5"></i>
                    <span>Категории расходов</span>
                </a>
                <a href="{% url 'finance:suppliers' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'supplier' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="truck" class="w-5 h-5"></i>
                    <span>Поставщики</span>
                </a>
                <a href="{% url 'finance:factory_assets' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'asset' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="building" class="w-5 h-5"></i>
                    <span>Имущество завода</span>
                </a>
            </nav>
        </div>

        <!-- Отчетность -->
        <div>
            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Отчетность</h3>
            <nav class="space-y-1">
                <a href="{% url 'finance:financial_reports' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg {% if 'report' in request.resolver_match.url_name %}bg-blue-50 text-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                    <i data-lucide="bar-chart" class="w-5 h-5"></i>
                    <span>Финансовые отчеты</span>
                </a>
            </nav>
        </div>

        <!-- Заявки -->
        <div>
            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Заявки</h3>
            <nav class="space-y-1">
                <a href="{% url 'finance:requests' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg bg-blue-50 text-blue-600">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    <span>Управление заявками</span>
                </a>
            </nav>
        </div>
    </aside>

    <!-- Main Content (Desktop split view) -->
    <main class="flex-1 overflow-hidden ml-64 p-6 pt-20" x-data="requestsData()" x-init="init()" @keydown.window="handleKeydown($event)">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-semibold text-gray-900">Заявки</h1>
                <p class="text-gray-600 text-sm">Создание и управление заявками для администратора</p>
            </div>
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <input x-ref="searchInput" type="text" placeholder="Поиск..." x-model="searchTerm"
                        class="pl-10 pr-4 py-2 w-72 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                </div>
                <button @click="openCreate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex items-center space-x-2 hover:bg-blue-700 transition-colors">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span>Создать заявку</span>
                </button>
            </div>
        </div>
        
        <!-- Loading State -->
        <template x-if="loading">
            <div class="space-y-3 animate-pulse">
                <div class="h-16 rounded-xl bg-gray-200"></div>
                <div class="h-16 rounded-xl bg-gray-200"></div>
                <div class="h-16 rounded-xl bg-gray-200"></div>
            </div>
        </template>

        <!-- Split View -->
        <template x-if="!loading">
            <div class="grid gap-2" x-ref="split" :style="'grid-template-columns:' + listPaneWidth + 'px 1fr'">
                <!-- Requests List Pane -->
                <section class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-4 py-2 border-b border-gray-200 flex items-center justify-between">
                        <div class="text-xs text-gray-500">Всего: <span x-text="requests.length"></span></div>
                        <div class="flex items-center gap-1">
                            <button @click="sortBy('created_at')" class="px-2 py-1 text-gray-600 hover:text-gray-900 rounded">
                                <i data-lucide="clock" class="w-4 h-4"></i>
                            </button>
                            <button @click="sortBy('name')" class="px-2 py-1 text-gray-600 hover:text-gray-900 rounded">
                                <i data-lucide="arrow-up-narrow-wide" class="w-4 h-4"></i>
                            </button>
                            <button @click="toggleDensity()" class="px-2 py-1 text-gray-600 hover:text-gray-900 rounded">
                                <i data-lucide="list" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="divide-y divide-gray-100 overflow-auto" :class="density === 'compact' ? 'max-h-[calc(100vh-220px)]' : 'max-h-[calc(100vh-240px)]'">
                        <template x-if="sortedFilteredRequests().length === 0">
                            <div class="text-center py-8">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <i data-lucide="file-text" class="w-8 h-8 text-gray-400"></i>
                                </div>
                                <div class="text-gray-600">Нет заявок</div>
                            </div>
                        </template>
                        <template x-for="(request, idx) in sortedFilteredRequests()" :key="request.id">
                            <div @click="selectRequest(request, idx)" :class="selectedRequest && selectedRequest.id === request.id ? 'bg-blue-50' : 'bg-white hover:bg-gray-50'" class="px-4 cursor-default" :style="density === 'compact' ? 'padding-top:6px;padding-bottom:6px' : 'padding-top:10px;padding-bottom:10px'">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                            <h3 class="font-medium text-gray-900 truncate" x-text="request.name"></h3>
                                            <span class="text-[10px] text-blue-600 font-semibold bg-blue-50 px-2 py-0.5 rounded-full" x-text="request.status_display"></span>
                                        </div>
                                        <div class="text-xs text-gray-600 mt-1 truncate">
                                            <span x-text="request.client && request.client.name ? request.client.name : 'Клиент: —'"></span>
                                            • <span x-text="formatDate(request.created_at)"></span>
                                            • <span x-text="(request.items && request.items.length ? request.items.length : 0) + ' поз.'"></span>
                                        </div>
                                    </div>
                                    <div class="text-sm text-gray-900 font-semibold whitespace-nowrap" x-text="(request.total_amount || 0).toLocaleString() + ' ⃀'"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </section>

                <!-- Details/Create Pane with Resizer -->
                <div class="relative">
                    <div class="absolute left-[-4px] top-0 bottom-0 w-2 cursor-col-resize z-10" @mousedown.prevent="startResize"></div>
                    <section class="bg-white rounded-xl shadow-sm border border-gray-200 h-[calc(100vh-210px)] overflow-auto">
                        <template x-if="showCreatePane">
                            <div class="p-6">
                                <h2 class="text-lg font-semibold text-gray-900 mb-4">Создать заявку</h2>
                                <form @submit.prevent="submitRequest" class="space-y-6">
                                    <!-- Step navigation -->
                                    <div class="flex space-x-1 mb-2">
                                        <template x-for="step in 3" :key="step">
                                            <button type="button" @click="createStep = step" :class="createStep === step ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">
                                                <span x-text="step === 1 ? 'Основное' : step === 2 ? 'Клиент' : 'Товары'"></span>
                                            </button>
                                        </template>
                                    </div>
                                    
                                    <template x-if="createStep === 1">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Название заявки <span class="text-red-500">*</span></label>
                                            <input type="text" x-model="newRequest.name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </div>
                                    </template>

                                    <template x-if="createStep === 2">
                                        <div class="space-y-4">
                                            <div class="flex gap-2 mb-2">
                                                <button type="button" @click="clientMode = 'existing'; clearClientForm()" :class="clientMode === 'existing' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'" class="flex-1 py-2 rounded-lg font-semibold transition-colors">Клиент уже покупал</button>
                                                <button type="button" @click="clientMode = 'new'; clearClientForm()" :class="clientMode === 'new' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'" class="flex-1 py-2 rounded-lg font-semibold transition-colors">Новый клиент</button>
                                            </div>
                                            <template x-if="clientMode === 'existing'">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Выберите клиента</label>
                                                    <div class="relative">
                                                        <input type="text" 
                                                               x-model="clientSearchTerm" 
                                                               @input="filterClients()"
                                                               placeholder="Начните вводить имя или компанию..." 
                                                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                        <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute right-3 top-1/2 transform -translate-y-1/2"></i>
                                                    </div>
                                                    
                                                    <!-- Dropdown с клиентами -->
                                                    <div x-show="filteredClients.length > 0 && clientSearchTerm.length > 0" 
                                                         x-transition 
                                                         class="mt-2 border border-gray-200 rounded-lg bg-white shadow-lg max-h-60 overflow-y-auto z-10">
                                                        <template x-for="client in filteredClients" :key="client.id">
                                                            <div @click="selectClient(client)" 
                                                                 class="px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                                                                <div class="flex items-center justify-between">
                                                                    <div>
                                                                        <div class="font-medium text-gray-900" x-text="client.name"></div>
                                                                        <div x-show="client.company" class="text-sm text-gray-600" x-text="client.company"></div>
                                                                        <div x-show="client.phone" class="text-xs text-gray-500" x-text="client.phone"></div>
                                                                    </div>
                                                                    <div class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded-full">
                                                                        Выбрать
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                    
                                                    <!-- Предложение создать нового клиента -->
                                                    <div x-show="clientSearchTerm.length > 2 && filteredClients.length === 0" 
                                                         x-transition 
                                                         class="mt-2 border border-blue-200 rounded-lg bg-blue-50 p-3">
                                                        <div class="flex items-center justify-between">
                                                            <div class="flex-1">
                                                                <p class="text-sm text-blue-800 font-medium">Клиент не найден</p>
                                                                <p class="text-xs text-blue-600 mt-1">Создать нового клиента "<span x-text="clientSearchTerm"></span>"?</p>
                                                            </div>
                                                            <button @click="createNewClientFromSearch()" 
                                                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                                                                Создать
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Выбранный клиент -->
                                                    <div x-show="newRequest.client_id" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                                        <div class="flex items-center justify-between">
                                                            <div>
                                                                <div class="font-medium text-blue-900" x-text="getSelectedClientName()"></div>
                                                                <div class="text-sm text-blue-700" x-text="getSelectedClientCompany()"></div>
                                                            </div>
                                                            <button @click="clearSelectedClient()" class="text-blue-600 hover:text-blue-800">
                                                                <i data-lucide="x" class="w-4 h-4"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                            <template x-if="clientMode === 'new'">
                                                <div class="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700 mb-2">Имя *</label>
                                                        <input type="text" x-model="clientForm.name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                    </div>
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                                                        <input type="tel" x-model="clientForm.phone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                    </div>
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                                        <input type="email" x-model="clientForm.email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                    </div>
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700 mb-2">Компания</label>
                                                        <input type="text" x-model="clientForm.company" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                    </div>
                                                    <div class="col-span-2">
                                                        <label class="block text-sm font-medium text-gray-700 mb-2">Адрес</label>
                                                        <input type="text" x-model="clientForm.address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>

                                    <template x-if="createStep === 3">
                                        <div class="space-y-4">
                                            <label class="block text-sm font-medium text-gray-700 mb-3">Товары <span class="text-red-500">*</span></label>
                                            
                                            <!-- Список товаров -->
                                            <div class="space-y-4">
                                                <template x-for="(item, idx) in newRequest.items" :key="idx">
                                                    <div class="border border-gray-200 rounded-lg p-4 bg-white shadow-sm">
                                                        <div class="grid grid-cols-12 gap-4">
                                                            <!-- Выбор товара через select -->
                                                            <div class="col-span-6">
                                                                <label class="block text-sm font-medium text-gray-700 mb-2">Товар <span class="text-red-500">*</span></label>
                                                                <select x-model="item.product_id" @change="onProductChange(idx)" required class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                                    <option value="">— Выберите товар —</option>
                                                                    <template x-for="product in products" :key="product.id">
                                                                        <option :value="product.id" x-text="product.name"></option>
                                                                    </template>
                                                                </select>
                                                            </div>
                                                            
                                                            <!-- Количество с кнопками -->
                                                            <div class="col-span-3">
                                                                <label class="block text-sm font-medium text-gray-700 mb-2">Количество <span class="text-red-500">*</span></label>
                                                                <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                                                                    <button type="button" @click="decreaseQuantity(idx)" 
                                                                            class="quantity-btn px-3 py-3 text-gray-600 hover:text-gray-900 border-r border-gray-300">
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                                                        </svg>
                                                                    </button>
                                                                    <input type="text" 
                                                                           x-model="item.quantity" 
                                                                           @input="validateQuantity(idx)"
                                                                           class="flex-1 px-3 py-3 border-0 text-center focus:outline-none focus:ring-0 bg-white"
                                                                           style="-webkit-appearance: none; -moz-appearance: textfield;">
                                                                    <button type="button" @click="increaseQuantity(idx)" 
                                                                            class="quantity-btn px-3 py-3 text-gray-600 hover:text-gray-900 border-l border-gray-300">
                                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Размер с подсказками -->
                                                            <div class="col-span-3">
                                                                <label class="block text-sm font-medium text-gray-700 mb-2">Размер</label>
                                                                <div class="relative">
                                                                    <input type="text" 
                                                                           x-model="item.size" 
                                                                           @input="filterSizes(idx)"
                                                                           @focus="item.show_size_dropdown = true"
                                                                           @click.away="item.show_size_dropdown = false"
                                                                           placeholder="40-200, 60-200..." 
                                                                           class="w-full px-3 py-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                                    <svg class="w-4 h-4 text-gray-400 absolute right-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                    </svg>
                                                                    
                                                                    <!-- Dropdown с размерами -->
                                                                    <div x-show="item.show_size_dropdown && item.filtered_sizes && item.filtered_sizes.length > 0" 
                                                                         x-transition 
                                                                         class="absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                                                        <template x-for="size in item.filtered_sizes" :key="size">
                                                                            <div @click="selectSize(idx, size)" 
                                                                                 class="px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                                                                                <div class="font-medium text-gray-900" x-text="size"></div>
                                                                            </div>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Цвет с подсказками -->
                                                            <div class="col-span-6">
                                                                <label class="block text-sm font-medium text-gray-700 mb-2">Цвет</label>
                                                                <div class="relative">
                                                                    <input type="text" 
                                                                           x-model="item.color" 
                                                                           @input="filterColors(idx)"
                                                                           @focus="item.show_color_dropdown = true"
                                                                           @click.away="item.show_color_dropdown = false"
                                                                           placeholder="Введите цвет или выберите из списка..." 
                                                                           class="w-full px-3 py-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                                    <svg class="w-4 h-4 text-gray-400 absolute right-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                    </svg>
                                                                    
                                                                    <!-- Dropdown с цветами -->
                                                                    <div x-show="item.show_color_dropdown && item.filtered_colors && item.filtered_colors.length > 0" 
                                                                         x-transition 
                                                                         class="absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                                                        <template x-for="color in item.filtered_colors" :key="color">
                                                                            <div @click="selectColor(idx, color)" 
                                                                                 class="px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                                                                                <div class="font-medium text-gray-900" x-text="color"></div>
                                                                            </div>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- Быстрые кнопки цветов -->
                                                                <div class="mt-2 flex flex-wrap gap-2">
                                                                    <template x-for="quickColor in quickColors" :key="quickColor">
                                                                        <button type="button" @click="selectColor(idx, quickColor)" 
                                                                                class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-blue-100 hover:text-blue-700 transition-colors">
                                                                            <span x-text="quickColor"></span>
                                                                        </button>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Кнопка удаления -->
                                                            <div class="col-span-6 flex items-end justify-end">
                                                                <button type="button" @click="removeItem(idx)" 
                                                                        x-show="newRequest.items.length > 1"
                                                                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-red-300 text-red-700 bg-red-50 hover:bg-red-100 transition-colors">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                    </svg>
                                                                    <span>Удалить</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Дополнительные поля для стеклянных изделий -->
                                                        <template x-if="getProductById(item.product_id) && getProductById(item.product_id).is_glass">
                                                            <div class="mt-4 pt-4 border-t border-gray-200">
                                                                <h4 class="text-sm font-medium text-gray-700 mb-3">Параметры стекла</h4>
                                                                <div class="grid grid-cols-12 gap-4">
                                                                    <div class="col-span-4">
                                                                        <label class="block text-sm font-medium text-gray-700 mb-2">Тип стекла</label>
                                                                        <select x-model="item.glass_type" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                                            <option value="sandblasted">Пескоструйный</option>
                                                                            <option value="uv">УФ</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-span-4">
                                                                        <label class="block text-sm font-medium text-gray-700 mb-2">Тип краски</label>
                                                                        <input type="text" x-model="item.paint_type" placeholder="Акрил, эмаль" 
                                                                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                                    </div>
                                                                    <div class="col-span-4">
                                                                        <label class="block text-sm font-medium text-gray-700 mb-2">Цвет краски</label>
                                                                        <input type="text" x-model="item.paint_color" placeholder="Белый" 
                                                                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </template>
                                                        
                                                        <!-- Дополнительные поля для всех изделий -->
                                                        <div class="mt-4 pt-4 border-t border-gray-200">
                                                            <h4 class="text-sm font-medium text-gray-700 mb-3">Дополнительные спецификации</h4>
                                                            <div class="grid grid-cols-12 gap-4">
                                                                <div class="col-span-6">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Спецификации для ЧПУ</label>
                                                                    <textarea x-model="item.cnc_specs" placeholder="Детали для обработки на станках" rows="2" 
                                                                              class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                                                </div>
                                                                <div class="col-span-6">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Спецификации для распила</label>
                                                                    <textarea x-model="item.cutting_specs" placeholder="Детали для распила" rows="2" 
                                                                              class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                                                </div>
                                                                <div class="col-span-6">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Спецификации для цеха заготовки</label>
                                                                    <textarea x-model="item.preparation_specs" placeholder="Комментарии и спецификации для цеха заготовки (ID 4)" rows="2" 
                                                                              class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                                                </div>
                                                                <div class="col-span-12">
                                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Заметки для упаковки</label>
                                                                    <textarea x-model="item.packaging_notes" placeholder="Особенности упаковки, маркировки" rows="2" 
                                                                              class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                            
                                            <!-- Кнопка добавления товара внизу -->
                                            <div class="flex justify-center pt-4">
                                                <button type="button" @click="addItem()" class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                    </svg>
                                                    <span>Добавить товар</span>
                                                </button>
                                            </div>
                                        </div>
                                    </template>

                                    <div class="flex justify-between pt-2">
                                        <button type="button" @click="prevStep" :disabled="createStep === 1" :class="createStep === 1 ? 'opacity-50 cursor-not-allowed' : ''" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">Назад</button>
                                        <button type="button" @click="nextStep" x-show="createStep < 3" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Далее</button>
                                        <button type="submit" x-show="createStep === 3" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Создать заявку</button>
                                    </div>
                                </form>
                            </div>
                        </template>

                        <template x-if="!showCreatePane && selectedRequest && Object.keys(selectedRequest).length">
                            <div class="p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg font-bold text-gray-900">Заявка: <span x-text="selectedRequest.name"></span></h2>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-blue-600 font-semibold bg-blue-50 px-2 py-1 rounded-full" x-text="selectedRequest.status_display"></span>
                                        <button @click="clearSelection()" class="text-gray-400 hover:text-gray-600">
                                            <i data-lucide="x" class="w-6 h-6"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Tabs -->
                                <div class="flex space-x-1 mb-4">
                                    <template x-for="step in 3" :key="step">
                                        <button @click="requestStep = step" :class="requestStep === step ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">
                                            <span x-text="step === 1 ? 'Основное' : step === 2 ? 'Клиент' : 'Товары'"></span>
                                        </button>
                                    </template>
                                </div>
                                
                                <!-- Step 1 -->
                                <template x-if="requestStep === 1">
                                    <div class="space-y-4">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">ID заявки</label>
                                                <p class="text-sm text-gray-900" x-text="selectedRequest.id"></p>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Статус</label>
                                                <p class="text-sm text-blue-600 font-semibold" x-text="selectedRequest.status_display"></p>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Дата создания</label>
                                                <p class="text-sm text-gray-900" x-text="formatDate(selectedRequest.created_at)"></p>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Общая сумма</label>
                                                <p class="text-sm text-gray-900" x-text="(selectedRequest.total_amount || 0).toLocaleString() + ' ⃀'"></p>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Комментарий</label>
                                            <p class="text-sm text-gray-900" x-text="selectedRequest.comment || 'Нет комментария'"></p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Итого шт.</label>
                                            <p class="text-sm text-gray-900" x-text="selectedRequest.items ? selectedRequest.items.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0"></p>
                                        </div>
                                    </div>
                                </template>
                                
                                <!-- Step 2 -->
                                <template x-if="requestStep === 2">
                                    <div class="space-y-6">
                                        <div>
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Клиент</h3>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">Имя</label>
                                                    <p class="text-sm text-gray-900" x-text="selectedRequest.client && selectedRequest.client.name"></p>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">Компания</label>
                                                    <p class="text-sm text-gray-900" x-text="selectedRequest.client && selectedRequest.client.company"></p>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">Телефон</label>
                                                    <p class="text-sm text-gray-900" x-text="selectedRequest.client && selectedRequest.client.phone"></p>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                                    <p class="text-sm text-gray-900" x-text="selectedRequest.client && selectedRequest.client.email"></p>
                                                </div>
                                                <div class="col-span-2">
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">Адрес</label>
                                                    <p class="text-sm text-gray-900" x-text="selectedRequest.client && selectedRequest.client.address"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                
                                <!-- Step 3 -->
                                <template x-if="requestStep === 3">
                                    <div class="space-y-4">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Товары</h3>
                                        <template x-if="selectedRequest.items && selectedRequest.items.length">
                                            <div class="space-y-3">
                                                <template x-for="item in selectedRequest.items" :key="item.id">
                                                    <div class="border border-gray-200 rounded-lg p-3">
                                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                                            <div>
                                                                <label class="block text-sm font-medium text-gray-700 mb-1">Название</label>
                                                                <p class="text-gray-900" x-text="item.product && item.product.name ? item.product.name : 'Товар'"></p>
                                                            </div>
                                                            <div>
                                                                <label class="block text-sm font-medium text-gray-700 mb-1">Количество</label>
                                                                <p class="text-gray-900" x-text="item.quantity"></p>
                                                            </div>
                                                            <div>
                                                                <label class="block text-sm font-medium text-gray-700 mb-1">Цена</label>
                                                                <p class="text-gray-900" x-text="(item.price || 0).toLocaleString() + ' ⃀'"></p>
                                                            </div>
                                                            <div>
                                                                <label class="block text-sm font-medium text-gray-700 mb-1">Размер</label>
                                                                <p class="text-gray-900" x-text="item.size || 'Не указан'"></p>
                                                            </div>
                                                            <div>
                                                                <label class="block text-sm font-medium text-gray-700 mb-1">Цвет</label>
                                                                <p class="text-gray-900" x-text="item.color || 'Не указан'"></p>
                                                            </div>
                                                            <div>
                                                                <label class="block text-sm font-medium text-gray-700 mb-1">Тип стекла</label>
                                                                <p class="text-gray-900" x-text="item.glass_type || 'Не указан'"></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                        <template x-if="!selectedRequest.items || !selectedRequest.items.length">
                                            <div class="text-gray-500 text-center py-8">
                                                <i data-lucide="package" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
                                                <p>Товары не добавлены</p>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <template x-if="!showCreatePane && (!selectedRequest || !Object.keys(selectedRequest).length)">
                            <div class="h-full flex items-center justify-center text-gray-400">
                                Выберите заявку слева или нажмите "Создать заявку".
                            </div>
                        </template>
                    </section>
                </div>
            </div>
        </template>
                            
        <!-- Success Toast -->
        <div x-show="showSuccess" x-transition class="fixed top-24 right-6 bg-white rounded-xl shadow-lg p-4 border border-green-200 z-40">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8 text-green-500 animate-success-pop" fill="none" viewBox="0 0 48 48" stroke="currentColor" stroke-width="3">
                    <circle cx="24" cy="24" r="22" stroke="currentColor" stroke-opacity="0.15" fill="#fff"/>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 25l6 6 10-13"/>
                </svg>
                <div class="text-sm font-medium text-gray-900">Заявка успешно создана!</div>
                <button @click="showSuccess = false" class="text-gray-400 hover:text-gray-600 ml-2"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="fixed bottom-0 right-0 bg-white border-t border-gray-200 px-4 py-2 text-xs text-gray-600 flex items-center justify-between" style="left: 16rem;">
            <div>Заявки: <span x-text="requests.length"></span> • Выбрано: <span x-text="selectedRequest && selectedRequest.id ? selectedRequest.id : '—'"></span></div>
            <div>Горячие клавиши: F — поиск, N — новый, ↑/↓ — навигация, Enter — открыть, Esc — очистить</div>
        </div>
    </main>

    <script>
    function requestsData() {
        return {
            loading: true,
            requests: [],
            searchTerm: '',
            selectedRequest: {},
            selectedIndex: -1,
            requestStep: 1,
            // Desktop layout state
            showCreatePane: false,
            listPaneWidth: 420,
            isResizing: false,
            density: 'comfortable', // or 'compact'
            sortKey: 'created_at',
            sortAsc: false,

            // Create form state
            createStep: 1,
            clientMode: 'existing',
            clients: [],
            products: [],
            clientForm: { name: '', phone: '', email: '', company: '', address: '' },
            newRequest: { name: '', client_id: '', items: [{ product_id: '', quantity: 1, size: '', color: '', price: 0, preparation_specs: '' }] },
            showSuccess: false,
            
            // Улучшенный выбор клиента
            clientSearchTerm: '',
            filteredClients: [],
            
            // Цвета и подсказки
            quickColors: [
                'Белый', 'Черный', 'Серый (1966)', 'Коричневый', 'Бежевый',
                'Красный', 'Синий', 'Зеленый', 'Желтый', 'Оранжевый',
                'Фиолетовый', 'Розовый', 'Голубой', 'Темно-синий', 'Темно-зеленый'
            ],
            allColors: [
                'Белый', 'Черный', 'Серый (1966)', 'Коричневый', 'Бежевый',
                'Красный', 'Синий', 'Зеленый', 'Желтый', 'Оранжевый',
                'Фиолетовый', 'Розовый', 'Голубой', 'Темно-синий', 'Темно-зеленый',
                'Серый (RAL 7035)', 'Коричневый (RAL 8004)', 'Красный (RAL 3000)',
                'Синий (RAL 5002)', 'Зеленый (RAL 6001)', 'Желтый (RAL 1003)',
                'Оранжевый (RAL 2000)', 'Фиолетовый (RAL 4005)', 'Розовый (RAL 4003)',
                'Голубой (RAL 5012)', 'Темно-синий (RAL 5004)', 'Темно-зеленый (RAL 6007)',
                'Светло-серый', 'Темно-серый', 'Светло-коричневый', 'Темно-коричневый',
                'Светло-красный', 'Темно-красный', 'Светло-синий', 'Темно-синий',
                'Светло-зеленый', 'Темно-зеленый', 'Светло-желтый', 'Темно-желтый'
            ],

            openCreate() {
                this.showCreatePane = true;
                this.selectedRequest = {};
                this.selectedIndex = -1;
                this.createStep = 1;
                this.clientMode = 'existing';
                this.$nextTick(() => lucide.createIcons());
            },
            
            clearSelection() {
                this.selectedRequest = {};
                this.selectedIndex = -1;
                this.requestStep = 1;
            },
            
            selectRequest(request, idx) {
                this.selectedRequest = request;
                this.selectedIndex = idx;
                this.showCreatePane = false;
                this.requestStep = 1;
                this.$nextTick(() => lucide.createIcons());
            },

            startResize(e) {
                this.isResizing = true;
                this._onMouseMove = (ev) => this.onMouseMove(ev);
                this._onMouseUp = () => this.onMouseUp();
                window.addEventListener('mousemove', this._onMouseMove);
                window.addEventListener('mouseup', this._onMouseUp);
            },
            onMouseMove(e) {
                if (!this.isResizing) return;
                const min = 280, max = 700;
                const newW = Math.min(max, Math.max(min, e.clientX - 16 * 4)); // minus sidebar width (16rem)
                this.listPaneWidth = newW;
            },
            onMouseUp() {
                if (!this.isResizing) return;
                this.isResizing = false;
                window.removeEventListener('mousemove', this._onMouseMove);
                window.removeEventListener('mouseup', this._onMouseUp);
                try { localStorage.setItem('requests_list_pane_w', String(this.listPaneWidth)); } catch {}
            },

            handleKeydown(e) {
                if (e.key === 'f' || (e.ctrlKey && e.key.toLowerCase() === 'f')) {
                    e.preventDefault();
                    this.$refs.searchInput && this.$refs.searchInput.focus();
                } else if (e.key.toLowerCase() === 'n') {
                    e.preventDefault();
                    this.openCreate();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    if (this.showCreatePane) {
                        this.showCreatePane = false;
                    } else {
                        this.clearSelection();
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    const list = this.sortedFilteredRequests();
                    if (!list.length) return;
                    this.selectedIndex = Math.min(list.length - 1, this.selectedIndex + 1);
                    this.selectedRequest = list[this.selectedIndex] || {};
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    const list = this.sortedFilteredRequests();
                    if (!list.length) return;
                    this.selectedIndex = Math.max(0, this.selectedIndex - 1);
                    this.selectedRequest = list[this.selectedIndex] || {};
                } else if (e.key === 'Enter') {
                    if (this.selectedRequest && this.selectedRequest.id) {
                        e.preventDefault();
                        // ensure details pane is visible (no-op in split view)
                    }
                }
            },

            toggleDensity() {
                this.density = this.density === 'comfortable' ? 'compact' : 'comfortable';
            },

            sortBy(key) {
                if (this.sortKey === key) {
                    this.sortAsc = !this.sortAsc;
                } else {
                    this.sortKey = key;
                    this.sortAsc = key === 'name';
                }
            },
            
            async fetchRequests() {
                const resp = await fetch('/finance/api/requests/');
                const data = await resp.json();
                this.requests = data;
            },
            
            async fetchClients() {
                const resp = await fetch('/clients/api/clients/');
                const data = await resp.json();
                this.clients = Array.isArray(data) ? data : (data.results || []);
            },
            
            async fetchProducts() {
                // Fetch all products across paginated API
                try {
                    let url = '/products/api/products/';
                    const all = [];
                    while (url) {
                        const resp = await fetch(url);
                        const data = await resp.json();
                        if (Array.isArray(data)) {
                            // Pagination disabled; data already full list
                            this.products = data;
                            return;
                        }
                        const results = data.results || [];
                        for (const p of results) all.push(p);
                        url = data.next;
                    }
                    this.products = all;
                } catch (e) {
                    this.products = [];
                }
            },
            
            filteredRequests() {
                const term = this.searchTerm.toLowerCase();
                return this.requests.filter(r =>
                    (r.name || '').toLowerCase().includes(term) ||
                    (r.client && r.client.name ? r.client.name : '').toLowerCase().includes(term) ||
                    (r.status || '').toLowerCase().includes(term)
                );
            },

            sortedFilteredRequests() {
                const list = this.filteredRequests().slice();
                const key = this.sortKey;
                const asc = this.sortAsc ? 1 : -1;
                list.sort((a, b) => {
                    const av = (a[key] ?? '').toString().toLowerCase();
                    const bv = (b[key] ?? '').toString().toLowerCase();
                    if (key === 'created_at') {
                        const at = new Date(a[key] || 0).getTime();
                        const bt = new Date(b[key] || 0).getTime();
                        return (at - bt) * asc;
                    }
                    if (av < bv) return -1 * asc;
                    if (av > bv) return 1 * asc;
                    return 0;
                });
                return list;
            },
            
            formatDate(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return d.toLocaleString('ru-RU');
            },
            
            nextStep() {
                if (this.createStep === 1 && !this.newRequest.name) return;
                if (this.createStep === 2) {
                    if (this.clientMode === 'existing' && !this.newRequest.client_id) {
                        alert('Выберите клиента!');
                        return;
                    }
                    if (this.clientMode === 'new' && !this.clientForm.name) {
                        alert('Введите имя клиента!');
                        return;
                    }
                }
                if (this.createStep === 3) {
                    const validItems = this.newRequest.items.filter(it => it.product_id && it.quantity > 0);
                    if (!validItems.length) {
                        alert('Добавьте хотя бы один товар!');
                        return;
                    }
                }
                this.createStep++;
            },
            
            prevStep() {
                if (this.createStep > 1) this.createStep--;
            },
            
            // Функции для модального окна товаров
            openProductModal(idx) {
                console.log('Opening product modal for index:', idx); // Для отладки
                this.currentItemIndex = idx;
                this.showProductModal = true;
                this.productSearchTerm = '';
                this.filteredProducts = this.products.slice(0, 20);
                
                // Принудительно обновляем отображение
                this.$nextTick(() => {
                    console.log('Modal should be visible now');
                });
            },

            closeProductModal() {
                this.showProductModal = false;
                this.currentItemIndex = -1;
                this.productSearchTerm = '';
                this.filteredProducts = [];
            },

            selectProductFromModal(product) {
                if (this.currentItemIndex >= 0) {
                    const item = this.newRequest.items[this.currentItemIndex];
                    item.product_id = product.id;
                    this.onProductChange(this.currentItemIndex);
                }
                this.closeProductModal();
            },

            filterProducts() {
                const term = this.productSearchTerm.toLowerCase();
                if (term.length < 2) {
                    this.filteredProducts = this.products.slice(0, 20);
                    return;
                }
                
                this.filteredProducts = this.products.filter(product => 
                    product.name.toLowerCase().includes(term) ||
                    (product.description && product.description.toLowerCase().includes(term))
                ).slice(0, 20);
            },

            // Функции для работы с цветами
            filterColors(idx) {
                const item = this.newRequest.items[idx];
                const term = item.color.toLowerCase();
                if (term.length < 1) {
                    item.filtered_colors = [];
                    return;
                }
                
                item.filtered_colors = this.allColors.filter(color => 
                    color.toLowerCase().includes(term)
                ).slice(0, 10);
            },

            selectColor(idx, color) {
                const item = this.newRequest.items[idx];
                item.color = color;
                item.show_color_dropdown = false;
                item.filtered_colors = [];
            },

            // Обновленная функция addItem
            addItem() {
                this.newRequest.items.push({ 
                    product_id: '', 
                    quantity: 1, 
                    size: '', 
                    color: '',
                    price: 0,
                    glass_type: 'sandblasted',
                    paint_type: '',
                    paint_color: '',
                    cnc_specs: '',
                    cutting_specs: '',
                    preparation_specs: '',
                    packaging_notes: '',
                    show_color_dropdown: false,
                    filtered_colors: [],
                    show_size_dropdown: false,
                    filtered_sizes: []
                });
            },

            // Остальные функции
            increaseQuantity(idx) {
                const item = this.newRequest.items[idx];
                item.quantity = Math.max(1, parseInt(item.quantity) || 0) + 1;
            },

            decreaseQuantity(idx) {
                const item = this.newRequest.items[idx];
                item.quantity = Math.max(1, (parseInt(item.quantity) || 1) - 1);
            },

            validateQuantity(idx) {
                const item = this.newRequest.items[idx];
                const value = parseInt(item.quantity);
                if (isNaN(value) || value < 1) {
                    item.quantity = 1;
                } else {
                    item.quantity = value;
                }
            },

            clearProductSelection(idx) {
                const item = this.newRequest.items[idx];
                item.product_id = '';
            },
            
            getProductById(id) {
                return this.products.find(p => p.id === id);
            },
            
            // Функции для работы с клиентами
            filterClients() {
                if (!this.clientSearchTerm || this.clientSearchTerm.length < 2) {
                    this.filteredClients = [];
                    return;
                }
                
                const term = this.clientSearchTerm.toLowerCase();
                this.filteredClients = this.clients.filter(client => 
                    client.name.toLowerCase().includes(term) ||
                    (client.company && client.company.toLowerCase().includes(term)) ||
                    (client.phone && client.phone.includes(term))
                ).slice(0, 10); // Ограничиваем до 10 результатов
            },
            
            selectClient(client) {
                this.newRequest.client_id = client.id;
                this.clientSearchTerm = client.name;
                this.filteredClients = [];
            },
            
            clearSelectedClient() {
                this.newRequest.client_id = '';
                this.clientSearchTerm = '';
                this.filteredClients = [];
            },
            
            getSelectedClientName() {
                const client = this.clients.find(c => c.id === this.newRequest.client_id);
                return client ? client.name : '';
            },
            
            getSelectedClientCompany() {
                const client = this.clients.find(c => c.id === this.newRequest.client_id);
                return client && client.company ? client.company : '';
            },
            
            createNewClientFromSearch() {
                // Переключаемся на режим создания нового клиента
                this.clientMode = 'new';
                // Заполняем форму данными из поиска
                this.clientForm.name = this.clientSearchTerm;
                this.clientForm.phone = '';
                this.clientForm.email = '';
                this.clientForm.company = '';
                this.clientForm.address = '';
                // Очищаем поиск
                this.clientSearchTerm = '';
                this.filteredClients = [];
                // Сбрасываем выбранного клиента
                this.newRequest.client_id = '';
                this.$nextTick(() => lucide.createIcons());
            },
            
            // Очистка формы при смене режима
            clearClientForm() {
                this.clientForm = { name: '', phone: '', email: '', company: '', address: '' };
                this.newRequest.client_id = '';
                this.clientSearchTerm = '';
                this.filteredClients = [];
            },
            
            async submitRequest() {
                let clientId = this.newRequest.client_id;
                
                if (this.clientMode === 'new') {
                    if (this.clientForm.email && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(this.clientForm.email)) {
                        alert('Введите корректный email!');
                        return;
                    }
                    
                    const resp = await fetch('/clients/api/clients/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify(this.clientForm)
                    });
                    
                    if (resp.ok) {
                        const client = await resp.json();
                        clientId = client.id;
                    } else {
                        alert('Ошибка создания клиента');
                        return;
                    }
                }
                
                if (!clientId) {
                    alert('Клиент не выбран или не создан!');
                    return;
                }
                
                const payload = {
                    name: this.newRequest.name,
                    client_id: clientId,
                    items_data: this.newRequest.items.filter(it => it.product_id && it.quantity > 0),
                    comment: ''
                };
                
                const resp = await fetch('/finance/api/requests/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });
                
                if (resp.ok) {
                    const created = await resp.json();
                    this.requests.unshift(created);
                    this.showSuccess = true;
                    this.showCreatePane = false;
                    this.selectRequest(created, 0);
                    this.$nextTick(() => lucide.createIcons());
                } else {
                    alert('Ошибка создания заявки');
                }
            },
            
            getCsrfToken() {
                const name = 'csrftoken';
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        return decodeURIComponent(cookie.substring(name.length + 1));
                    }
                }
                return '';
            },
            
            async init() {
                try {
                    const saved = localStorage.getItem('requests_list_pane_w');
                    if (saved) this.listPaneWidth = parseInt(saved, 10) || this.listPaneWidth;
                } catch {}

                await this.fetchRequests();
                await this.fetchClients();
                await this.fetchProducts();
                this.loading = false;
                
                // URL param to open create view
                const params = new URLSearchParams(window.location.search);
                if (params.get('create') === 'true' || params.get('create') === '1') {
                    this.showCreatePane = true;
                }
                
                this.$nextTick(() => lucide.createIcons());
            },

            // Дополнительные функции для улучшенного интерфейса товаров
            onProductChange(idx) {
                const item = this.newRequest.items[idx];
                if (item.product_id) {
                    const product = this.products.find(p => p.id === item.product_id);
                    if (product) {
                        // Автоматически заполняем тип стекла для стеклянных изделий
                        if (product.is_glass && !item.glass_type) {
                            item.glass_type = 'sandblasted';
                        }
                    }
                }
            },
            
            removeItem(idx) {
                this.newRequest.items.splice(idx, 1);
                if (this.newRequest.items.length === 0) {
                    this.addItem();
                }
            },

            // Размеры и подсказки (только 5 вариантов)
            allSizes: [
                '40-200', '60-200', '70-200', '80-200', '90-200'
            ],

            // Функции для работы с размерами
            filterSizes(idx) {
                const item = this.newRequest.items[idx];
                const term = item.size.toLowerCase();
                if (term.length < 1) {
                    item.filtered_sizes = [];
                    return;
                }
                
                item.filtered_sizes = this.allSizes.filter(size => 
                    size.toLowerCase().includes(term)
                );
            },

            selectSize(idx, size) {
                const item = this.newRequest.items[idx];
                item.size = size;
                item.show_size_dropdown = false;
                item.filtered_sizes = [];
            },
        }
    }
    
    document.addEventListener('alpine:init', () => {
        Alpine.data('requestsData', requestsData);
    });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
</body>
</html> 