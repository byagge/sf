<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>Директор — Обзор</title>
	<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
	<script src="https://unpkg.com/lucide@latest"></script>
	<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<style>
		body { background: linear-gradient(135deg, #f3f4f6 0%, #dbeafe 100%); }
		.card { box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
		.mobile-nav { box-shadow: 0 -2px 12px rgba(0,0,0,0.06); }
	</style>
</head>
<body class="min-h-screen flex flex-col" style="font-family: system-ui, -apple-system, sans-serif;">
	<header class="fixed top-0 left-0 right-0 z-20 bg-white border-b border-gray-200 flex items-center justify-between px-4 h-14">
		<div class="flex items-center gap-2">
			<div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center">
				<span class="text-white font-bold text-lg">S</span>
			</div>
			<span class="font-semibold text-lg text-gray-900">Директор</span>
		</div>
		<a href="/director/" class="text-gray-500 hover:text-gray-700" title="Десктоп">
			<i data-lucide="layout" class="w-5 h-5"></i>
		</a>
	</header>
	<main class="pt-16 pb-20 px-4 max-w-md mx-auto w-full" x-data="directorMobile()" x-init="init()">
		<!-- KPIs (основные) -->
		<div class="grid grid-cols-2 gap-3 mb-4">
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Доход</p>
				<p class="text-xl font-semibold text-gray-900" x-text="formatCurrency(overview.total_income || 0)"></p>
			</div>
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Продажи</p>
				<p class="text-xl font-semibold text-gray-900" x-text="overview.product_sales || 0"></p>
			</div>
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Сотрудники</p>
				<p class="text-xl font-semibold text-gray-900" x-text="overview.total_employees || 0"></p>
			</div>
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Брак</p>
				<p class="text-xl font-semibold text-gray-900" x-text="overview.defective_products || 0"></p>
			</div>
		</div>

		<!-- Вторичные показатели -->
		<div class="grid grid-cols-2 gap-3 mb-4">
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Клиенты</p>
				<p class="text-xl font-semibold text-gray-900" x-text="overview.total_clients || 0"></p>
			</div>
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Услуги</p>
				<p class="text-xl font-semibold text-gray-900" x-text="overview.total_services || 0"></p>
			</div>
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Материалы</p>
				<p class="text-xl font-semibold text-gray-900" x-text="overview.total_materials || 0"></p>
			</div>
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Заказы</p>
				<p class="text-xl font-semibold text-gray-900" x-text="overview.total_orders || 0"></p>
			</div>
		</div>

		<!-- Финансовые показатели -->
		<div class="grid grid-cols-2 gap-3 mb-4">
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Баланс</p>
				<p class="text-xl font-semibold text-blue-600" x-text="formatCurrency(overview.total_balance || 0)"></p>
			</div>
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Расходы</p>
				<p class="text-xl font-semibold text-red-600" x-text="formatCurrency(overview.monthly_expenses || 0)"></p>
			</div>
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Активы</p>
				<p class="text-xl font-semibold text-purple-600" x-text="formatCurrency(overview.total_assets || 0)"></p>
			</div>
			<div class="card bg-white rounded-xl p-4">
				<p class="text-xs text-gray-500">Чистая прибыль</p>
				<p class="text-xl font-semibold text-green-700" x-text="formatCurrency(overview.net_profit || 0)"></p>
			</div>
		</div>

		<!-- Графики -->
		<div class="bg-white rounded-xl p-4 border mb-4">
			<div class="flex items-center justify-between mb-2">
				<h3 class="text-base font-semibold text-gray-900">График показателей</h3>
				<select x-model="period" @change="updateChart()" class="border rounded px-2 py-1 text-xs">
					<option value="week">Неделя</option>
					<option value="month">Месяц</option>
					<option value="year">Год</option>
				</select>
			</div>
			<div class="h-40 relative">
				<div x-show="loading" class="absolute inset-0 bg-white/70 flex items-center justify-center z-10">
					<div class="w-5 h-5 border-2 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div>
					<span class="ml-2 text-gray-600 text-xs">Загрузка...</span>
				</div>
				<canvas id="dirMobileChart"></canvas>
			</div>
		</div>

		<!-- Статус системы -->
		<div class="bg-white rounded-xl p-4 border mb-4">
			<h3 class="text-base font-semibold text-gray-900 mb-2">Статус системы</h3>
			<div class="space-y-2 text-sm">
				<div class="flex justify-between items-center">
					<span class="text-gray-600">Низкий запас материалов</span>
					<span class="px-2 py-0.5 rounded-full" :class="overview.low_stock_count>0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'" x-text="overview.low_stock_count || 0"></span>
				</div>
				<div class="flex justify-between items-center">
					<span class="text-gray-600">Активные заказы</span>
					<span class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-800" x-text="overview.active_orders || 0"></span>
				</div>
				<div class="flex justify-between items-center">
					<span class="text-gray-600">Средняя эффективность</span>
					<span class="px-2 py-0.5 rounded-full bg-green-100 text-green-800" x-text="(overview.avg_efficiency || 0) + '%' "></span>
				</div>
				<div class="flex justify-between items-center">
					<span class="text-gray-600">Стоимость материалов</span>
					<span class="px-2 py-0.5 rounded-full bg-purple-100 text-purple-800" x-text="formatCurrency(overview.total_materials_value || 0)"></span>
				</div>
			</div>
		</div>

		<!-- Топ сотрудники -->
		<div class="bg-white rounded-xl p-4 border mb-4">
			<h3 class="text-base font-semibold text-gray-900 mb-2">Топ сотрудники</h3>
			<div>
				<template x-for="emp in topEmployees" :key="emp.id">
					<div class="flex items-center justify-between py-2 border-b last:border-0">
						<div class="flex items-center">
							<div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
								<span class="text-blue-600 text-sm font-medium" x-text="(emp.full_name || emp.name).charAt(0).toUpperCase()"></span>
							</div>
							<div>
								<p class="text-sm font-medium text-gray-900" x-text="emp.full_name || emp.name"></p>
								<p class="text-xs text-gray-500">Вып: <span x-text="emp.completed_works || 0"></span> · Брак: <span x-text="emp.defects || 0"></span></p>
							</div>
						</div>
						<span class="inline-flex px-2 py-0.5 text-xs font-semibold rounded-full" :class="emp.efficiency>=80 ? 'bg-green-100 text-green-800' : emp.efficiency>=60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'" x-text="(emp.efficiency || 0) + '%' "></span>
					</div>
				</template>
				<div x-show="topEmployees.length===0" class="text-center py-4 text-gray-500 text-sm">Нет данных о сотрудниках</div>
			</div>
		</div>

		<!-- Последние заказы -->
		<div class="bg-white rounded-xl p-4 border mb-4">
			<h3 class="text-base font-semibold text-gray-900 mb-2">Последние заказы</h3>
			<div>
				<template x-for="order in recentOrders" :key="order.id">
					<div class="flex items-center justify-between py-2 border-b last:border-0">
						<div>
							<p class="text-sm font-medium text-gray-900" x-text="order.name"></p>
							<p class="text-xs text-gray-500" x-text="order.client && order.client.name"></p>
						</div>
						<div class="text-right">
							<span class="inline-flex px-2 py-0.5 text-[10px] font-semibold rounded-full" :class="getStatusClass(order.status)" x-text="order.status_display"></span>
							<p class="text-[10px] text-gray-500 mt-1" x-text="formatDate(order.created_at)"></p>
						</div>
					</div>
				</template>
				<div x-show="recentOrders.length===0" class="text-center py-4 text-gray-500 text-sm">Нет данных о заказах</div>
			</div>
		</div>

		<!-- Быстрые ссылки -->
		<div class="grid grid-cols-3 gap-3 mb-4">
			<a href="/orders/" class="card bg-white rounded-xl p-3 text-center">
				<i data-lucide="clipboard-list" class="w-5 h-5 text-blue-600 mx-auto mb-1"></i>
				<span class="text-xs font-semibold text-gray-900">Заказы</span>
			</a>
			<a href="/inventory/" class="card bg-white rounded-xl p-3 text-center">
				<i data-lucide="archive" class="w-5 h-5 text-gray-600 mx-auto mb-1"></i>
				<span class="text-xs font-semibold text-gray-900">Склад</span>
			</a>
			<a href="/defects/" class="card bg-white rounded-xl p-3 text-center">
				<i data-lucide="alert-triangle" class="w-5 h-5 text-red-600 mx-auto mb-1"></i>
				<span class="text-xs font-semibold text-gray-900">Браки</span>
			</a>
		</div>
	</main>
	{% include 'partials/bottom_nav_mobile.html' %}
	<script>
	function directorMobile(){
		return {
			overview: {},
			topEmployees: [],
			recentOrders: [],
			period: 'month',
			chart: null,
			loading: false,
			async init(){
				await this.loadDashboardData();
				await this.drawChart();
				if (window.lucide) lucide.createIcons();
			},
			async loadDashboardData(){
				try{
					this.loading = true;
					const overviewRes = await fetch('/orders/dashboard/overview/', {headers:{'X-Requested-With':'XMLHttpRequest'}});
					if (overviewRes.ok) this.overview = await overviewRes.json();
					await this.loadFinanceData();
					await Promise.all([
						this.loadClientsData(),
						this.loadServicesData(),
						this.loadInventoryData(),
						this.loadOrdersData(),
						this.loadEmployeesData()
					]);
				} catch(e) {
					this.overview={}; this.topEmployees=[]; this.recentOrders=[];
				} finally { this.loading = false; }
			},
			async loadFinanceData(){
				try{ const r=await fetch('/finance/api/dashboard-stats/'); if(r.ok){ const d=await r.json(); this.overview.total_income=d.monthly_income||0; this.overview.total_balance=d.total_balance||0; this.overview.monthly_expenses=d.monthly_expenses||0; this.overview.total_assets=d.total_assets||0; this.overview.net_profit=d.monthly_profit||0; } }catch{}
			},
			async loadClientsData(){
				try{ const r=await fetch('/clients/api/clients/'); if(r.ok){ const d=await r.json(); this.overview.total_clients = d.results? d.results.length : (Array.isArray(d)? d.length : (d.clients||[]).length); } }catch{}
			},
			async loadServicesData(){
				try{ const r=await fetch('/services/api/services/'); if(r.ok){ const d=await r.json(); if(d.status==='success'){ this.overview.total_services = d.data.length; } } }catch{}
			},
			async loadInventoryData(){
				try{ const r=await fetch('/inventory/api/materials/'); if(r.ok){ const d=await r.json(); if(d.status==='success'){ this.overview.total_materials=d.data.length; this.overview.low_stock_count=d.data.filter(m=>m.quantity<=m.min_quantity).length; this.overview.total_materials_value=d.data.reduce((s,m)=>s+(m.quantity*(m.price||0)),0); } } }catch{}
			},
			async loadOrdersData(){
				try{ const r=await fetch('/orders/api/orders/?ordering=-created_at&limit=10'); if(r.ok){ const d=await r.json(); this.recentOrders = d.results || d; this.overview.total_orders = d.count || (Array.isArray(d)? d.length : 0); this.overview.active_orders=(this.recentOrders||[]).filter(o=>o.status==='production'||o.status==='new').length; } }catch{ this.recentOrders=[]; }
			},
			async loadEmployeesData(){
				try{ const r=await fetch('/employees/api/employees/'); if(r.ok){ const data=await r.json(); const emps=data.results||data; const enriched = await Promise.all((emps||[]).map(async (emp)=>{ try{ const sr=await fetch(`/employees/api/employees/${emp.id}/stats/`); if(sr.ok){ const s=await sr.json(); return { ...emp, full_name: emp.first_name && emp.last_name ? `${emp.first_name} ${emp.last_name}` : emp.username, completed_works:s.completed_tasks||0, defects:s.defective_quantity||0, efficiency:s.efficiency||0 }; } }catch{} return { ...emp, full_name: emp.first_name && emp.last_name ? `${emp.first_name} ${emp.last_name}` : emp.username, completed_works:0, defects:0, efficiency:0 }; })); this.topEmployees = enriched.sort((a,b)=>(b.completed_works||0)-(a.completed_works||0)).slice(0,10); const totalEff = enriched.reduce((s,e)=>s+(e.efficiency||0),0); this.overview.avg_efficiency = enriched.length ? Math.round(totalEff/enriched.length) : 0; } }catch{ this.topEmployees=[]; this.overview.avg_efficiency=0; }
			},
			async drawChart(){
				try{ const r=await fetch(`/orders/dashboard/revenue-chart/?period=${this.period}`, {headers:{'X-Requested-With':'XMLHttpRequest'}, credentials:'same-origin'}); const data= r.ok ? await r.json() : {labels:[], revenue:[], defects:[], orders_count:[], sales:[]};
					const existing = window.Chart && window.Chart.getChart ? window.Chart.getChart('dirMobileChart') : null; if(existing){ existing.destroy(); }
					if(this.chart) this.chart.destroy(); const ctxEl=document.getElementById('dirMobileChart');
					const ctx = ctxEl && ctxEl.getContext ? ctxEl.getContext('2d') : null;
					if (!data.labels || data.labels.length === 0) {
						const days = this.period === 'month' ? 30 : this.period === 'year' ? 365 : 7;
						const labels = [];
						for (let i = days - 1; i >= 0; i--) {
							const d = new Date();
							d.setDate(d.getDate() - i);
							labels.push(('0' + d.getDate()).slice(-2) + '.' + ('0' + (d.getMonth() + 1)).slice(-2));
						}
						data.labels = labels;
						data.revenue = new Array(days).fill(0);
						data.defects = new Array(days).fill(0);
						data.orders_count = new Array(days).fill(0);
						data.sales = new Array(days).fill(0);
					}
					['revenue','sales','defects','orders_count'].forEach(k=>{ if(!Array.isArray(data[k])||data[k].length!==data.labels.length){ data[k]=new Array(data.labels.length).fill(0);} });
					if(ctx && Array.isArray(data.labels)) {
						if (!window.Chart) { for (let i = 0; i < 60; i++) { await new Promise(r => setTimeout(r, 50)); if (window.Chart) break; } }
						this.chart=new Chart(ctx,{ type:'line', data:{ labels:data.labels, datasets:[
							{ label:'Доход (₽)', data:(data.revenue||[]).map(Number), borderColor:'#3B82F6', backgroundColor:'#3B82F622', borderWidth:2, tension:.35, pointRadius:2, yAxisID:'y1' },
							{ label:'Продажи (шт)', data:(data.sales||[]).map(Number), borderColor:'#10B981', backgroundColor:'#10B98122', borderWidth:2, tension:.35, pointRadius:2, yAxisID:'y2' },
							{ label:'Брак (шт)', data:(data.defects||[]).map(Number), borderColor:'#EF4444', backgroundColor:'#EF444422', borderWidth:2, tension:.35, pointRadius:2, yAxisID:'y2' },
							{ label:'Заказы (шт)', data:(data.orders_count||[]).map(Number), borderColor:'#6366F1', backgroundColor:'#6366F122', borderWidth:2, tension:.35, pointRadius:2, yAxisID:'y2' }
						]}, options:{ plugins:{legend:{display:true}}, responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}}, y1:{type:'linear', position:'left', grid:{color:'rgba(0,0,0,.07)'}}, y2:{type:'linear', position:'right', grid:{display:false}}}} });
					}
				}catch(e){ console.error('Ошибка загрузки графика:', e); }
			},
			async updateChart(){ await this.drawChart(); },
			formatCurrency(v){ return new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB', minimumFractionDigits:0, maximumFractionDigits:0}).format(v||0); },
			formatDate(s){ if(!s) return ''; const d=new Date(s); return d.toLocaleDateString('ru-RU',{day:'2-digit', month:'2-digit', year:'2-digit'}); },
			getStatusClass(status){ const m={ 'new':'bg-blue-100 text-blue-800', 'production':'bg-yellow-100 text-yellow-800', 'completed':'bg-green-100 text-green-800', 'cancelled':'bg-red-100 text-red-800' }; return m[status]||'bg-gray-100 text-gray-800'; }
		}
	}
	document.addEventListener('DOMContentLoaded', () => { if (window.lucide) lucide.createIcons(); });
	</script>
</body>
</html> 