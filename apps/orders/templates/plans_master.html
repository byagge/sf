<!DOCTYPE html>
<html lang="ru" x-data="masterPlansPage()" x-init="init()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Smart Factory">
    <title>Планы по цехам (Мастер)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { background: linear-gradient(135deg, #f3f4f6 0%, #dbeafe 100%); }
        .nav-active { color: #2563eb; }
        .nav-bar { box-shadow: 0 -2px 16px 0 rgba(37,99,235,0.08); }
        .card { box-shadow: 0 2px 12px 0 rgba(0,0,0,0.04); }
        .modal-bg { background: rgba(0,0,0,0.35); backdrop-filter: blur(4px); animation: fadeInBg 0.2s; }
        .skeleton { background: linear-gradient(90deg, #e0e7ef 25%, #f3f4f6 50%, #e0e7ef 75%); background-size: 200% 100%; animation: skeleton 1.2s infinite linear; }
        @keyframes skeleton { 0% {background-position: 200% 0;} 100% {background-position: -200% 0;} }
        @media (max-width: 640px) {
            .responsive-btn-row { flex-direction: column; gap: 0.5rem; }
            .modal-content { width: 95vw; max-width: 95vw; border-radius: 1.25rem; }
            .mobile-touch-target { min-height: 44px; min-width: 44px; }
            .mobile-button { padding: 0.75rem; font-size: 0.875rem; }
        }
        @media (min-width: 641px) {
            .responsive-btn-row { flex-direction: row; gap: 0.5rem; }
            .modal-content { width: 100%; max-width: 24rem; border-radius: 0.75rem; }
        }
        .modal-content { animation: scaleIn 0.2s; }
        @keyframes fadeInBg {
            from { background: rgba(0,0,0,0); }
            to   { background: rgba(0,0,0,0.35); }
        }
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to   { transform: scale(1); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to   { transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideUp 0.25s cubic-bezier(.4,0,.2,1);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col" style="font-family: system-ui, -apple-system, sans-serif;" x-data="masterPlansPage()" x-init="init()">
    <!-- Offline Banner -->
    <div x-show="!isOnline" x-transition class="fixed top-0 left-0 right-0 z-50 bg-red-600 text-white text-center py-2 font-semibold shadow-lg" style="letter-spacing:0.02em;">Нет соединения с интернетом. Данные могут быть неактуальны.</div>
    <!-- Toast Notification -->
    <div x-show="toast.show"
         x-transition:enter="transition ease-out duration-400"
         x-transition:enter-start="opacity-0 scale-95 translate-y-6"
         x-transition:enter-end="opacity-100 scale-100 translate-y-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100 scale-100 translate-y-0"
         x-transition:leave-end="opacity-0 scale-95 translate-y-6"
         class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 bg-white border border-gray-200 shadow-lg rounded-xl px-6 py-4 flex items-center space-x-3 text-base font-semibold text-gray-800"
         style="min-width: 220px; max-width: 90vw;" x-cloak>
        <template x-if="toast.type === 'success'">
            <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
        </template>
        <template x-if="toast.type === 'error'">
            <i data-lucide="alert-circle" class="w-6 h-6 text-red-500"></i>
        </template>
        <span x-text="toast.message"></span>
    </div>
    <!-- AppBar -->
    <header class="fixed top-0 left-0 right-0 z-20 bg-white/90 backdrop-blur border-b border-gray-200 flex items-center justify-between px-4 h-16">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                <span class="text-white font-bold text-2xl">O</span>
            </div>
            <span class="text-lg font-semibold text-gray-900">Планы по цехам</span>
        </div>
    </header>
{% if request.session.impersonator_id %}
<div class="bg-yellow-200 text-yellow-900 text-xs text-center py-1">
    Режим имперсонации. <a href="{% url 'release_impersonation' %}" class="underline font-semibold">Вернуться</a>
</div>
{% endif %}
    <!-- Main Content -->
    <main class="flex-1 pt-20 pb-20 px-2 max-w-2xl mx-auto w-full">
        <!-- Tabs for workshops -->
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
            <template x-for="(workshop, idx) in workshops" :key="workshop.id">
                <button @click="tabChanged(idx)"
                        class="relative w-full rounded-xl overflow-hidden shadow card border"
                        :class="selectedWorkshopIdx === idx ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-800 border-gray-200'"
                        style="padding-top: 50%;">
                    <div class="absolute inset-0 flex flex-col items-center justify-center p-2">
                        <div class="text-sm font-bold" x-text="workshop.name"></div>
                    </div>
                </button>
            </template>
        </div>
        <!-- Stages for selected workshop -->
        <template x-if="loading">
            <div class="space-y-4 animate-pulse">
                <div class="h-20 rounded-xl skeleton"></div>
                <div class="h-20 rounded-xl skeleton"></div>
            </div>
        </template>
        <template x-if="!loading && stages.length === 0">
            <div class="text-center py-12">
                <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="check-square" class="w-10 h-10 text-gray-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Нет активных этапов</h3>
                <p class="text-gray-600">В этом цеху пока нет задач</p>
            </div>
        </template>
        <template x-if="!loading && stages.length > 0">
            <div class="space-y-6">
                <template x-for="stage in stages" :key="stage.id">
                    <div class="card bg-white rounded-xl p-3 cursor-pointer transition-all duration-200 hover:shadow-lg active:scale-[0.98]" 
                         :data-stage-id="stage.id" style="margin-top: 10px;"
                         @click="openStageModal(stage)">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <!-- Заголовок и основная информация -->
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-bold text-gray-900 text-base" x-text="stage.order_name"></div>
                                    <template x-if="stage.status">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" 
                                              :class="stage.status === 'done' ? 'bg-green-100 text-green-800' : stage.status === 'in_progress' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'">
                                            <span x-text="stage.status === 'done' ? 'Завершен' : stage.status === 'in_progress' ? 'В работе' : stage.status"></span>
                                        </span>
                                    </template>
                                </div>
                                
                                <!-- Клиент и операция -->
                                <div class="flex items-center space-x-3 text-xs text-gray-600 mb-2">
                                    <template x-if="stage.order_item && stage.order_item.order && stage.order_item.order.client">
                                            <span class="text-blue-600">
                                                <i data-lucide="user" class="w-3 h-3 inline mr-1"></i>
                                                <span x-text="stage.order_item.order.client.name"></span>
                                            </span>
                                        </template>
                                    <span class="font-medium" x-text="stage.operation"></span>
                                    <template x-if="stage.sequence && stage.sequence > 1">
                                        <span class="text-gray-500">#<span x-text="stage.sequence"></span></span>
                                    </template>
                                </div>
                                
                                <!-- Товар и фото -->
                                <div class="flex items-center space-x-3 mb-3 cursor-pointer" @click.stop="openProductsModal(stage)">
                                    <template x-if="stage.order_item && stage.order_item.product && stage.order_item.product.img">
                                                <img :src="stage.order_item.product.img" 
                                                     :alt="stage.order_item.product.name"
                                             class="w-12 h-12 object-cover rounded border border-gray-200">
                                        </template>
                                        <template x-if="!stage.order_item && stage.aggregated_items && stage.aggregated_items.length && stage.aggregated_items[0].product && stage.aggregated_items[0].product.img">
                                            <img :src="stage.aggregated_items[0].product.img"
                                                 :alt="stage.aggregated_items[0].product.name"
                                                 class="w-12 h-12 object-cover rounded border border-gray-200">
                                        </template>
                                                                        <div class="flex-1">
                                        <div class="text-sm font-medium text-gray-900" x-text="stage.order_item && stage.order_item.product ? stage.order_item.product.name : (stage.products || 'Товары не указаны')"></div>
                                        <div class="text-xs text-gray-500">
                                            <template x-if="stage.order_item && stage.order_item.size">
                                                <span x-text="stage.order_item.size"></span>
                                            </template>
                                            <template x-if="stage.order_item && stage.order_item.color">
                                                <span class="ml-1">• <span x-text="stage.order_item.color"></span></span>
                                            </template>
                                            <template x-if="stage.order_item && stage.order_item.quantity && stage.order_item.quantity > 1">
                                                <span class="ml-1">• <span x-text="stage.order_item.quantity"></span> шт.</span>
                                            </template>
                                            <template x-if="!stage.order_item && stage.total_quantity">
                                                <span class="ml-1">• <span x-text="stage.total_quantity"></span> шт.</span>
                                            </template>
                                        </div>
                                        <template x-if="!stage.order_item && stage.aggregated_items && stage.aggregated_items.length">
                                            <div class="mt-1 space-y-0.5">
                                                <template x-for="it in stage.aggregated_items" :key="it.id">
                                                    <div class="text-xs text-gray-600">
                                                        <span class="font-medium" x-text="it.product && it.product.name ? it.product.name : 'Товар'"></span>
                                                        — <span x-text="it.quantity"></span> шт.
                                                        <template x-if="it.size">• <span x-text="it.size"></span></template>
                                                        <template x-if="it.color">• <span x-text="it.color"></span></template>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="text-blue-600">
                                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                    </div>
                                </div>
                                
                                <!-- Компактная статистика -->
                                <div class="grid grid-cols-4 gap-2 text-xs mb-2">
                                    <div class="text-center">
                                        <div class="text-gray-500">План</div>
                                        <div class="font-semibold text-gray-900" x-text="getPlanQuantity(stage)"></div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-gray-500">Назначено</div>
                                        <div class="font-semibold" :class="(stage.assigned && stage.assigned.length > 0 ? stage.assigned.reduce((sum, a) => sum + a.quantity, 0) >= stage.plan_quantity ? 'text-red-600' : 'text-green-600' : 'text-gray-400')">
                                            <span x-text="stage.assigned && stage.assigned.length > 0 ? stage.assigned.reduce((sum, a) => sum + a.quantity, 0) : 0"></span>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-gray-500">Выполнено</div>
                                        <div class="font-semibold text-green-600" x-text="stage.done_count || 0"></div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-gray-500">Брак</div>
                                        <div class="font-semibold text-red-600" x-text="stage.defective_count || 0"></div>
                                    </div>
                                </div>
                                
                                <!-- Прогресс выполнения -->
                                <div class="mb-2">
                                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                                        <span>Выполнение</span>
                                        <span x-text="Math.round(((stage.done_count || 0) / getPlanQuantity(stage)) * 100) + '%'"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-green-600 h-1.5 rounded-full transition-all duration-300" 
                                             :style="'width: ' + Math.min(100, Math.max(0, ((stage.done_count || 0) / getPlanQuantity(stage)) * 100)) + '%'"></div>
                                    </div>
                                </div>
                                
                                <!-- Индикатор назначений -->
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <div class="flex items-center space-x-2">
                                        <template x-if="stage.assigned && stage.assigned.length > 0">
                                            <span class="text-gray-600">
                                                <i data-lucide="users" class="w-3 h-3 inline mr-1"></i>
                                                <span x-text="stage.assigned.length"></span> сотрудников
                                            </span>
                                            <!-- Быстрые кнопки управления назначениями -->
                                            <div class="flex space-x-1 ml-2">
                                                <button @click.stop="openAssignModal(stage)" 
                                                        class="text-blue-600 hover:text-blue-700 p-1 rounded hover:bg-blue-50 transition-colors mobile-touch-target" 
                                                        title="Добавить назначение">
                                                    <i data-lucide="user-plus" class="w-3 h-3"></i>
                                                </button>
                                                <button @click.stop="openQuickAssignmentsModal(stage)" 
                                                        class="text-green-600 hover:text-green-700 p-1 rounded hover:bg-green-50 transition-colors mobile-touch-target" 
                                                        title="Управлять назначениями">
                                                    <i data-lucide="settings" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                        </template>
                                        <template x-if="stage.assigned && stage.assigned.length === 0">
                                            <div class="flex items-center space-x-2">
                                                <span class="text-gray-400">
                                                    <i data-lucide="user-x" class="w-3 h-3 inline mr-1"></i>
                                                    Не назначено
                                                </span>
                                                <!-- Кнопка добавления для неназначенных этапов -->
                                                <button @click.stop="openAssignModal(stage)" 
                                                        class="text-blue-600 hover:text-blue-700 p-1 rounded hover:bg-blue-50 transition-colors mobile-touch-target" 
                                                        title="Добавить назначение">
                                                    <i data-lucide="user-plus" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="text-gray-500">
                                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                        Нажмите для подробностей
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Кнопки действий -->
                            <div class="flex flex-col space-y-1 ml-3">
                                <button @click.stop="openAssignModal(stage)" 
                                        class="px-2 py-1.5 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 bg-blue-600 text-white flex items-center space-x-1 font-semibold text-xs">
                                    <i data-lucide="user-plus" class="w-3 h-3"></i>
                                    <span>Распределить</span>
                                </button>
                                <!-- Кнопки перевода - скрываем для цеха 4 (Пресс) -->
                                <template x-if="!(workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 4)">
                                    <button @click.stop="openTransferModal(stage)" 
                                            class="px-2 py-1.5 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-green-400 bg-green-600 text-white flex items-center space-x-1 font-semibold text-xs">
                                        <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                        <span>Перевести</span>
                                    </button>
                                </template>
                                <template x-if="!(workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 4)">
                                    <button @click.stop="openNoTransferModal(stage)" 
                                            class="px-2 py-1.5 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-red-400 bg-red-500 text-white flex items-center space-x-1 font-semibold text-xs">
                                        <i data-lucide="slash" class="w-3 h-3"></i>
                                        <span>Не переводить</span>
                                    </button>
                                </template>
                                <!-- Кнопка отметки выполнения для цеха 4 (Пресс) - простое подтверждение -->
                                <template x-if="(workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 4)">
                                    <button @click.stop="openSimpleCompletionModal(stage)" 
                                            class="px-2 py-1.5 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 bg-yellow-500 text-white flex items-center justify-center space-x-1 font-semibold text-xs">
                                        <i data-lucide="check-square" class="w-3 h-3"></i>
                                        <span>Выполнено</span>
                                    </button>
                                </template>
                                <!-- Кнопка отметки выполнения для цехов 8 и 10 - с назначениями -->
                                <template x-if="(workshops[selectedWorkshopIdx] && (workshops[selectedWorkshopIdx].id === 8 || workshops[selectedWorkshopIdx].id === 10))">
                                    <button @click.stop="openMarkCompletionModal(stage)" 
                                            class="px-2 py-1.5 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 bg-yellow-500 text-white flex items-center justify-center space-x-1 font-semibold text-xs">
                                        <i data-lucide="check-square" class="w-3 h-3"></i>
                                        <span>Выполнено</span>
                                    </button>
                                </template>
                            </div>
                        </div>
                        
                                                        <!-- Индикатор статуса -->
                                <div class="mt-3 pt-3 border-t border-gray-100">
                                    <div class="flex items-center justify-between text-xs">
                                        <div class="flex items-center space-x-2">
                                            <template x-if="stage.assigned && stage.assigned.length > 0">
                                                <span class="text-gray-600">
                                                    <i data-lucide="users" class="w-3 h-3 inline mr-1"></i>
                                                    <span x-text="stage.assigned.length"></span> сотрудников
                                                </span>
                                            </template>
                                            <template x-if="stage.assigned && stage.assigned.length === 0">
                                                <span class="text-gray-400">
                                                    <i data-lucide="user-x" class="w-3 h-3 inline mr-1"></i>
                                                    Не назначено
                                                </span>
                                            </template>
                                        </div>
                                        <div class="text-gray-500">
                                            <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                            Нажмите для подробностей
                                        </div>
                                    </div>
                                    
                                    <!-- Время до дедлайна -->
                                    <template x-if="stage.deadline">
                                        <div class="mt-2 pt-2 border-t border-gray-100">
                                            <div class="flex items-center justify-between text-xs">
                                                <span class="text-gray-500">Дедлайн:</span>
                                                <span :class="getTimeUntilDeadline(stage.deadline).isOverdue ? 'text-red-600 font-semibold' : getTimeUntilDeadline(stage.deadline).isUrgent ? 'text-orange-600 font-semibold' : 'text-gray-600'" 
                                                      x-text="getTimeUntilDeadline(stage.deadline).text"></span>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <!-- Комментарий этапа -->
                                    <template x-if="stage.comment">
                                        <div class="mt-2 pt-2 border-t border-gray-100">
                                            <div class="text-xs text-gray-500">
                                                <span class="font-medium">Комментарий:</span>
                                                <span class="text-gray-700 ml-1" x-text="stage.comment"></span>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <!-- Дата создания этапа -->
                                    <template x-if="stage.created_at">
                                        <div class="mt-2 pt-2 border-t border-gray-100">
                                            <div class="text-xs text-gray-500">
                                                <span class="font-medium">Создан:</span>
                                                <span class="text-gray-700 ml-1" x-text="new Date(stage.created_at).toLocaleDateString('ru-RU')"></span>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <!-- Дата обновления этапа -->
                                    <template x-if="stage.updated_at && stage.updated_at !== stage.created_at">
                                        <div class="mt-2 pt-2 border-t border-gray-100">
                                            <div class="text-xs text-gray-500">
                                                <span class="font-medium">Обновлен:</span>
                                                <span class="text-gray-700 ml-1" x-text="new Date(stage.updated_at).toLocaleDateString('ru-RU')"></span>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <!-- Дата этапа -->
                                    <template x-if="stage.date">
                                        <div class="mt-2 pt-2 border-t border-gray-100">
                                            <div class="text-xs text-gray-500">
                                                <span class="font-medium">Дата этапа:</span>
                                                <span class="text-gray-700 ml-1" x-text="new Date(stage.date).toLocaleDateString('ru-RU')"></span>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <!-- Готовая продукция -->
                                    <template x-if="stage.finished_good">
                                        <div class="mt-2 pt-2 border-t border-gray-100">
                                            <div class="text-xs text-gray-500">
                                                <span class="font-medium">Готовая продукция:</span>
                                                <span class="text-gray-700 ml-1" x-text="stage.finished_good.name || stage.finished_good"></span>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <!-- Спецификации этапа -->
                                    <template x-if="stage.cnc_specs || stage.cutting_specs || stage.preparation_specs || stage.paint_type || stage.paint_color">
                                        <div class="mt-2 pt-2 border-t border-gray-100">
                                            <div class="text-xs text-gray-500">
                                                <span class="font-medium">Спецификации:</span>
                                                <div class="text-gray-700 ml-1 mt-1 space-y-1">
                                                    <template x-if="stage.cnc_specs">
                                                        <div class="flex items-center">
                                                            <i data-lucide="cpu" class="w-3 h-3 mr-1 text-green-500"></i>
                                                            <span x-text="stage.cnc_specs"></span>
                                                        </div>
                                                    </template>
                                                    <template x-if="stage.cutting_specs">
                                                        <div class="flex items-center">
                                                            <i data-lucide="scissors" class="w-3 h-3 mr-1 text-orange-500"></i>
                                                            <span x-text="stage.cutting_specs"></span>
                                                        </div>
                                                    </template>
                                                    <template x-if="stage.preparation_specs">
                                                        <div class="flex items-center">
                                                            <i data-lucide="settings" class="w-3 h-3 mr-1 text-purple-500"></i>
                                                            <span x-text="stage.preparation_specs"></span>
                                                        </div>
                                                    </template>
                                                    <template x-if="stage.paint_type">
                                                        <div class="flex items-center">
                                                            <i data-lucide="palette" class="w-3 h-3 mr-1 text-purple-500"></i>
                                                            <span x-text="stage.paint_type"></span>
                                                            <template x-if="stage.paint_color">
                                                                <span class="ml-1">(<span x-text="stage.paint_color"></span>)</span>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <!-- Информация о цехе -->
                                    <template x-if="stage.workshop_info && (stage.workshop_info.cutting_specs || stage.workshop_info.cnc_specs || stage.workshop_info.preparation_specs || stage.workshop_info.paint_type || stage.workshop_info.paint_color)">
                                        <div class="mt-2 pt-2 border-t border-gray-100">
                                            <div class="text-xs text-gray-500">
                                                <span class="font-medium">Спецификации цеха:</span>
                                                <div class="text-gray-700 ml-1 mt-1 space-y-1">
                                                    <template x-if="stage.workshop_info.cutting_specs">
                                                        <div class="flex items-center">
                                                            <i data-lucide="scissors" class="w-3 h-3 mr-1 text-orange-500"></i>
                                                            <span x-text="stage.workshop_info.cutting_specs"></span>
                                                        </div>
                                                    </template>
                                                    <template x-if="stage.workshop_info.cnc_specs">
                                                        <div class="flex items-center">
                                                            <i data-lucide="cpu" class="w-3 h-3 mr-1 text-green-500"></i>
                                                            <span x-text="stage.workshop_info.cnc_specs"></span>
                                                        </div>
                                                    </template>
                                                    <template x-if="stage.workshop_info.preparation_specs">
                                                        <div class="flex items-center">
                                                            <i data-lucide="settings" class="w-3 h-3 mr-1 text-purple-500"></i>
                                                            <span x-text="stage.workshop_info.preparation_specs"></span>
                                                        </div>
                                                    </template>
                                                    <template x-if="stage.workshop_info.paint_type">
                                                        <div class="flex items-center">
                                                            <i data-lucide="palette" class="w-3 h-3 mr-1 text-purple-500"></i>
                                                            <span x-text="stage.workshop_info.paint_type"></span>
                                                            <template x-if="stage.workshop_info.paint_color">
                                                                <span class="ml-1">(<span x-text="stage.workshop_info.paint_color"></span>)</span>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <!-- Назначения в карточке -->
                                    <template x-if="stage.assigned && stage.assigned.length > 0">
                                        <div class="mt-2 pt-2 border-t border-gray-100">
                                            <div class="text-xs text-gray-500">
                                                <span class="font-medium">Назначения:</span>
                                                <div class="text-gray-700 mt-1 space-y-1">
                                                    <template x-for="assign in stage.assigned.slice(0, 3)" :key="assign.id">
                                                        <div class="flex items-center justify-between">
                                                            <div class="flex-1">
                                                                <span x-text="assign.employee_name"></span>
                                                                <span class="text-gray-500 ml-2" x-text="assign.quantity + ' шт.'"></span>
                                                                <template x-if="assign.completed_quantity !== undefined">
                                                                    <span class="text-green-600 ml-2" x-text="'✓ ' + assign.completed_quantity"></span>
                                                                </template>
                                                                <template x-if="assign.defective_quantity && assign.defective_quantity > 0">
                                                                    <span class="text-red-600 ml-2" x-text="'✗ ' + assign.defective_quantity"></span>
                                                                </template>
                                                            </div>
                                                            <div class="flex space-x-1">
                                                                <button @click.stop="openEditAssignModal(stage, assign)" 
                                                                        class="text-blue-600 hover:text-blue-700 p-1 rounded hover:bg-blue-50 transition-colors mobile-touch-target" 
                                                                        title="Редактировать">
                                                                    <i data-lucide="edit-3" class="w-3 h-3"></i>
                                                                </button>
                                                                <button @click.stop="deleteAssign(stage, assign)" 
                                                                        class="text-red-500 hover:text-red-600 p-1 rounded hover:bg-red-50 transition-colors mobile-touch-target" 
                                                                        title="Удалить">
                                                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </template>
                                                    <template x-if="stage.assigned.length > 3">
                                                        <div class="text-xs text-gray-500 text-center">
                                                            <i data-lucide="more-horizontal" class="w-3 h-3 inline mr-1"></i>
                                                            И еще <span x-text="stage.assigned.length - 3"></span> назначений
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <!-- Браки в карточке -->
                                    <template x-if="stage.defects && stage.defects.length > 0">
                                        <div class="mt-2 pt-2 border-t border-gray-100">
                                            <div class="text-xs text-gray-500">
                                                <span class="font-medium text-red-600">Браки:</span>
                                                <div class="text-red-600 ml-1 mt-1 space-y-1">
                                                    <template x-for="defect in stage.defects.slice(0, 2)" :key="defect.id">
                                                        <div class="flex items-center justify-between">
                                                            <span x-text="defect.quantity + ' шт.'"></span>
                                                            <template x-if="defect.comment">
                                                                <span class="text-gray-500 text-xs" x-text="defect.comment.length > 15 ? defect.comment.substring(0, 15) + '...' : defect.comment"></span>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <template x-if="stage.defects.length > 2">
                                                        <div class="text-xs text-gray-500 text-center">
                                                            <i data-lucide="more-horizontal" class="w-3 h-3 inline mr-1"></i>
                                                            И еще <span x-text="stage.defects.length - 2"></span> браков
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                    </div>
                </template>
            </div>
        </template>
    </main>
    
    <!-- Stage Details Modal -->
    <template x-if="showStageModal">
        <div class="fixed inset-0 z-50 flex items-end justify-center modal-bg" @click.self="showStageModal = false">
            <div class="bg-white rounded-t-2xl w-full h-[90vh] flex flex-col animate-slide-up shadow-xl overflow-hidden" style="max-width: 100vw;">
                <div class="flex items-center justify-between px-4 pt-3 pb-1 border-b border-gray-100 sticky top-0 bg-white z-10 min-h-[48px]">
                    <h2 class="text-base font-bold text-gray-900 truncate">
                        Этап: <span x-text="selectedStage ? selectedStage.operation : ''"></span>
                    </h2>
                    <button @click="showStageModal = false" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="flex-1 px-4 py-2 overflow-y-auto" style="scroll-behavior: smooth;">
                    <template x-if="selectedStage">
                        <!-- Основная информация -->
                        <div class="mb-6">
                            <div class="bg-blue-50 rounded-xl p-4 border-l-4 border-blue-400">
                                <h3 class="font-semibold text-blue-900 mb-3">Информация о заказе</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-blue-700 font-medium">Заказ:</span>
                                        <span class="text-blue-900" x-text="selectedStage.order_name"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-700 font-medium">Операция:</span>
                                        <span class="text-blue-900" x-text="selectedStage.operation"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-700 font-medium">Статус этапа:</span>
                                        <span class="text-blue-900 font-semibold" x-text="selectedStage.status_display || selectedStage.status || 'Не указан'"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-700 font-medium">План:</span>
                                        <span class="text-blue-900" x-text="(() => {
                                            let totalOrderItemsQuantity = 0;
                                            if (selectedStage.order_item && selectedStage.order_item.order && selectedStage.order_item.order.items) {
                                                totalOrderItemsQuantity = selectedStage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                            }
                                            return totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : selectedStage.plan_quantity;
                                        })()"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-700 font-medium">Брак:</span>
                                        <span class="text-blue-900" x-text="selectedStage.defective_count || 0"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-700 font-medium">Последовательность:</span>
                                        <span class="text-blue-900" x-text="selectedStage.sequence || 1"></span>
                                    </div>
                                    <template x-if="selectedStage.parallel_group">
                                        <div class="flex justify-between">
                                            <span class="text-blue-700 font-medium">Параллельная группа:</span>
                                            <span class="text-blue-900" x-text="selectedStage.parallel_group"></span>
                                        </div>
                                    </template>
                                    <template x-if="selectedStage.finished_good">
                                        <div class="flex justify-between">
                                            <span class="text-blue-700 font-medium">Готовая продукция:</span>
                                            <span class="text-blue-900" x-text="selectedStage.finished_good.name || selectedStage.finished_good"></span>
                                        </div>
                                    </template>
                                    <template x-if="selectedStage.cnc_specs || selectedStage.cutting_specs || selectedStage.preparation_specs || selectedStage.paint_type || selectedStage.paint_color">
                                        <div class="mt-3 pt-3 border-t border-blue-200">
                                            <div class="text-blue-800 font-medium mb-2">Спецификации этапа:</div>
                                            <template x-if="selectedStage.cnc_specs">
                                                <div class="flex justify-between">
                                                    <span class="text-blue-700 font-medium">ЧПУ:</span>
                                                    <span class="text-blue-900" x-text="selectedStage.cnc_specs"></span>
                                                </div>
                                            </template>
                                            <template x-if="selectedStage.cutting_specs">
                                                <div class="flex justify-between">
                                                    <span class="text-blue-700 font-medium">Распил:</span>
                                                    <span class="text-blue-900" x-text="selectedStage.cutting_specs"></span>
                                                </div>
                                            </template>
                                            <template x-if="selectedStage.preparation_specs">
                                                <div class="flex justify-between">
                                                    <span class="text-blue-700 font-medium">Заготовка:</span>
                                                    <span class="text-blue-900" x-text="selectedStage.preparation_specs"></span>
                                                </div>
                                            </template>
                                            <template x-if="selectedStage.paint_type">
                                                <div class="flex justify-between">
                                                    <span class="text-blue-700 font-medium">Краска:</span>
                                                    <span class="text-blue-900" x-text="selectedStage.paint_type"></span>
                                                    <template x-if="selectedStage.paint_color">
                                                        <span class="ml-1">(<span x-text="selectedStage.paint_color"></span>)</span>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                    <template x-if="selectedStage.deadline">
                                        <div class="flex justify-between">
                                            <span class="text-blue-700 font-medium">Срок:</span>
                                            <span class="text-blue-900" x-text="new Date(selectedStage.deadline).toLocaleDateString('ru-RU')"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-blue-700 font-medium">Время до дедлайна:</span>
                                            <span class="text-blue-900" :class="getTimeUntilDeadline(selectedStage.deadline).isOverdue ? 'text-red-600 font-semibold' : getTimeUntilDeadline(selectedStage.deadline).isUrgent ? 'text-orange-600 font-semibold' : ''" 
                                                  x-text="getTimeUntilDeadline(selectedStage.deadline).text"></span>
                                        </div>
                                    </template>
                                    <template x-if="selectedStage.date">
                                        <div class="flex justify-between">
                                            <span class="text-blue-700 font-medium">Дата этапа:</span>
                                            <span class="text-blue-900" x-text="new Date(selectedStage.date).toLocaleString('ru-RU')"></span>
                                        </div>
                                    </template>
                                    <template x-if="selectedStage.comment">
                                        <div class="flex justify-between">
                                            <span class="text-blue-700 font-medium">Комментарий:</span>
                                            <span class="text-blue-900" x-text="selectedStage.comment"></span>
                                        </div>
                                    </template>
                                    <template x-if="selectedStage.created_at">
                                        <div class="flex justify-between">
                                            <span class="text-blue-700 font-medium">Создан:</span>
                                            <span class="text-blue-900" x-text="new Date(selectedStage.created_at).toLocaleString('ru-RU')"></span>
                                        </div>
                                    </template>
                                    <template x-if="selectedStage.updated_at">
                                        <div class="flex justify-between">
                                            <span class="text-blue-700 font-medium">Обновлен:</span>
                                            <span class="text-blue-900" x-text="new Date(selectedStage.updated_at).toLocaleString('ru-RU')"></span>
                                        </div>
                                    </template>
                                    
                                    <template x-if="selectedStage.order_item && selectedStage.order_item.order">
                                        <div class="mt-3 pt-3 border-t border-blue-200">
                                            <div class="text-blue-800 font-medium mb-2">Детали заявки:</div>
                                            <div class="space-y-2">
                                                <div class="flex justify-between">
                                                    <span class="text-blue-700 font-medium">Заявка:</span>
                                                    <span class="text-blue-900" x-text="selectedStage.order_item.order.name || 'Не указано'"></span>
                                                </div>
                                                <template x-if="selectedStage.order_item.order.client">
                                                    <div class="flex justify-between">
                                                        <span class="text-blue-700 font-medium">Клиент:</span>
                                                        <span class="text-blue-900" x-text="selectedStage.order_item.order.client.name || 'Не указан'"></span>
                                                    </div>
                                                    <template x-if="selectedStage.order_item.order.client.company">
                                                        <div class="flex justify-between">
                                                            <span class="text-blue-700 font-medium">Компания:</span>
                                                            <span class="text-blue-900" x-text="selectedStage.order_item.order.client.company"></span>
                                                        </div>
                                                    </template>
                                                    <template x-if="selectedStage.order_item.order.client.phone">
                                                        <div class="flex justify-between">
                                                            <span class="text-blue-700 font-medium">Телефон:</span>
                                                            <span class="text-blue-900" x-text="selectedStage.order_item.order.client.phone"></span>
                                                        </div>
                                                    </template>
                                                    <template x-if="selectedStage.order_item.order.client.email">
                                                        <div class="flex justify-between">
                                                            <span class="text-blue-700 font-medium">Email:</span>
                                                            <span class="text-blue-900" x-text="selectedStage.order_item.order.client.email"></span>
                                                        </div>
                                                    </template>
                                                </template>
                                                <div class="flex justify-between">
                                                    <span class="text-blue-700 font-medium">Дата создания:</span>
                                                    <span class="text-blue-900" x-text="selectedStage.order_item.order.created_at ? new Date(selectedStage.order_item.order.created_at).toLocaleDateString('ru-RU') : 'Не указана'"></span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-blue-700 font-medium">Статус:</span>
                                                    <span class="text-blue-900" x-text="selectedStage.order_item.order.status_display || selectedStage.order_item.order.status || 'Не указан'"></span>
                                                </div>
                                                <template x-if="selectedStage.order_item.order.comment">
                                                    <div class="flex justify-between">
                                                        <span class="text-blue-700 font-medium">Комментарий:</span>
                                                        <span class="text-blue-900" x-text="selectedStage.order_item.order.comment"></span>
                                                    </div>
                                                </template>
                                                <template x-if="selectedStage.order_item.order.expenses">
                                                    <div class="flex justify-between">
                                                        <span class="text-blue-700 font-medium">Расходы:</span>
                                                        <span class="text-blue-900" x-text="selectedStage.order_item.order.expenses.toLocaleString() + ' ⃀'"></span>
                                                    </div>
                                                </template>
                                                <template x-if="selectedStage.order_item.order.total_quantity || selectedStage.order_item.order.quantity">
                                                    <div class="flex justify-between">
                                                        <span class="text-blue-700 font-medium">Общее количество:</span>
                                                        <span class="text-blue-900" x-text="selectedStage.order_item.order.total_quantity || selectedStage.order_item.order.quantity"></span>
                                                    </div>
                                                </template>
                                                <template x-if="selectedStage.order_item.order.total_done_count !== undefined">
                                                    <div class="flex justify-between">
                                                        <span class="text-blue-700 font-medium">Выполнено всего:</span>
                                                        <span class="text-blue-900" x-text="selectedStage.order_item.order.total_done_count"></span>
                                                    </div>
                                                </template>
                                                <template x-if="selectedStage.order_item.order.total_defective_count !== undefined">
                                                    <div class="flex justify-between">
                                                        <span class="text-blue-700 font-medium">Брак всего:</span>
                                                        <span class="text-blue-900" x-text="selectedStage.order_item.order.total_defective_count"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Информация о товаре -->
                        <template x-if="selectedStage.order_item && selectedStage.order_item !== null">
                            <div class="mb-6">
                                <div class="bg-gray-50 rounded-xl p-4 border-l-4 border-gray-400">
                                    <h3 class="font-semibold text-gray-900 mb-3">Текущий товар</h3>
                                    <div class="space-y-3">
                                        <!-- Фото товара -->
                                        <template x-if="selectedStage.order_item.product && selectedStage.order_item.product.img">
                                            <div class="text-center">
                                                <img :src="selectedStage.order_item.product.img" 
                                                     :alt="selectedStage.order_item.product.name"
                                                     class="w-32 h-32 object-cover rounded-lg mx-auto border border-gray-200">
                                            </div>
                                        </template>
                                        
                                        <!-- Основные характеристики -->
                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span class="text-gray-600 font-medium">Название:</span>
                                                <div class="text-gray-900 font-semibold" x-text="selectedStage.order_item.product ? selectedStage.order_item.product.name : 'Не указан'"></div>
                                            </div>
                                            <div>
                                                <span class="text-gray-600 font-medium">Количество:</span>
                                                <div class="text-gray-900 font-semibold" x-text="selectedStage.order_item.quantity"></div>
                                            </div>
                                            <template x-if="selectedStage.order_item.size">
                                                <div>
                                                    <span class="text-gray-600 font-medium">Размер:</span>
                                                    <div class="text-gray-900 font-semibold" x-text="selectedStage.order_item.size"></div>
                                                </div>
                                            </template>
                                            <template x-if="selectedStage.order_item.color">
                                                <div>
                                                    <span class="text-gray-600 font-medium">Цвет:</span>
                                                    <div class="text-gray-900 font-semibold" x-text="selectedStage.order_item.color"></div>
                                                </div>
                                            </template>
                                            <template x-if="selectedStage.order_item.product && selectedStage.order_item.product.type">
                                                <div>
                                                    <span class="text-gray-600 font-medium">Тип:</span>
                                                    <div class="text-gray-900 font-semibold" x-text="selectedStage.order_item.product.type"></div>
                                                </div>
                                            </template>
                                            <template x-if="selectedStage.order_item.product && selectedStage.order_item.product.description">
                                                <div class="col-span-2">
                                                    <span class="text-gray-600 font-medium">Описание:</span>
                                                    <div class="text-gray-900 font-semibold" x-text="selectedStage.order_item.product.description"></div>
                                                </div>
                                            </template>
                                            <template x-if="selectedStage.order_item.product && selectedStage.order_item.product.price">
                                                <div>
                                                    <span class="text-gray-600 font-medium">Цена:</span>
                                                    <div class="text-gray-900 font-semibold" x-text="selectedStage.order_item.product.price + ' ⃀'"></div>
                                                </div>
                                            </template>
                                        </div>
                                        
                                        <!-- Специальные характеристики -->
                                        <template x-if="selectedStage.order_item.product && selectedStage.order_item.product.is_glass">
                                            <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                                                <div class="flex items-center text-blue-800">
                                                    <i data-lucide="droplets" class="w-4 h-4 mr-2"></i>
                                                    <span class="font-medium">Стекло</span>
                                                </div>
                                                <div class="text-blue-700 text-sm mt-1" x-text="selectedStage.order_item.glass_type_display || 'Тип не указан'"></div>
                                            </div>
                                        </template>
                                        
                                        <template x-if="selectedStage.order_item.paint_type">
                                            <div class="bg-purple-50 rounded-lg p-3 border border-purple-200">
                                                <div class="flex items-center text-purple-800">
                                                    <i data-lucide="palette" class="w-4 h-4 mr-2"></i>
                                                    <span class="font-medium">Краска</span>
                                                </div>
                                                <div class="text-purple-700 text-sm mt-1">
                                                    <span x-text="selectedStage.order_item.paint_type"></span>
                                                    <template x-if="selectedStage.order_item.paint_color">
                                                        <span> (<span x-text="selectedStage.order_item.paint_color"></span>)</span>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                        
                                        <template x-if="selectedStage.order_item.cnc_specs">
                                            <div class="bg-green-50 rounded-lg p-3 border border-green-200">
                                                <div class="flex items-center text-green-800">
                                                    <i data-lucide="cpu" class="w-4 h-4 mr-2"></i>
                                                    <span class="font-medium">ЧПУ</span>
                                                </div>
                                                <div class="text-green-700 text-sm mt-1" x-text="selectedStage.order_item.cnc_specs"></div>
                                            </div>
                                        </template>
                                        
                                        <template x-if="selectedStage.order_item.cutting_specs">
                                            <div class="bg-orange-50 rounded-lg p-3 border border-orange-200">
                                                <div class="flex items-center text-orange-800">
                                                    <i data-lucide="scissors" class="w-4 h-4 mr-2"></i>
                                                    <span class="font-medium">Распил</span>
                                                </div>
                                                <div class="text-orange-700 text-sm mt-1" x-text="selectedStage.order_item.cutting_specs"></div>
                                            </div>
                                        </template>
                                        
                                        <template x-if="selectedStage.order_item.preparation_specs">
                                            <div class="bg-purple-50 rounded-lg p-3 border border-purple-200">
                                                <div class="flex items-center text-purple-800">
                                                    <i data-lucide="settings" class="w-4 h-4 mr-2"></i>
                                                    <span class="font-medium">Заготовка</span>
                                                </div>
                                                <div class="text-purple-700 text-sm mt-1" x-text="selectedStage.order_item.preparation_specs"></div>
                                            </div>
                                        </template>
                                        
                                        <template x-if="selectedStage.order_item.packaging_notes">
                                            <div class="bg-indigo-50 rounded-lg p-3 border border-indigo-200">
                                                <div class="flex items-center text-indigo-800">
                                                    <i data-lucide="package" class="w-4 h-4 mr-2"></i>
                                                    <span class="font-medium">Упаковка</span>
                                                </div>
                                                <div class="text-indigo-700 text-sm mt-1" x-text="selectedStage.order_item.packaging_notes"></div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Все товары заказа -->
                        <template x-if="selectedStage.order_item && selectedStage.order_item !== null && selectedStage.order_item.order && selectedStage.order_item.order.items && Array.isArray(selectedStage.order_item.order.items)">
                            <div class="mb-6">
                                <div class="bg-green-50 rounded-xl p-4 border-l-4 border-green-400">
                                    <h3 class="font-semibold text-green-900 mb-3">
                                        <span x-text="selectedStage.order_item.order.items.length > 1 ? 'Все товары заказа' : 'Товар заказа'"></span>
                                        <span class="text-sm font-normal text-green-700 ml-2">(<span x-text="selectedStage.order_item.order.items.length"></span> <span x-text="selectedStage.order_item.order.items.length === 1 ? 'товар' : selectedStage.order_item.order.items.length < 5 ? 'товара' : 'товаров'"></span>)</span>
                                    </h3>
                                    <div class="space-y-2">
                                        <template x-for="item in selectedStage.order_item.order.items" :key="item.id">
                                            <div class="bg-white rounded-lg p-3 border-2" :class="item.id === selectedStage.order_item.id ? 'border-green-500 bg-green-50' : 'border-gray-200'">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex-1">
                                                        <!-- Фото товара -->
                                                        <template x-if="item.product && item.product.img">
                                                            <div class="mb-2">
                                                                <img :src="item.product.img" 
                                                                     :alt="item.product.name"
                                                                     class="w-12 h-12 object-cover rounded border border-gray-200">
                                                            </div>
                                                        </template>
                                                        <div class="font-medium text-gray-900" x-text="item.product && item.product.name ? item.product.name : 'Не указан'"></div>
                                                <div class="text-gray-600 text-sm mt-1">
                                                    <span class="font-medium" x-text="item.quantity"></span> шт.
                                                    <template x-if="item.size"> • <span x-text="item.size"></span></template>
                                                    <template x-if="item.color"> • <span x-text="item.color"></span></template>
                                                    <template x-if="item.product && item.product.is_glass">
                                                        <span class="text-blue-600"> • Стекло</span>
                                                    </template>
                                                </div>
                                                <!-- Дополнительные характеристики -->
                                                <template x-if="item.glass_type || item.paint_type || item.cnc_specs || item.cutting_specs || item.preparation_specs || item.packaging_notes">
                                                    <div class="text-xs text-gray-500 mt-1 space-y-1">
                                                        <template x-if="item.glass_type">
                                                            <div class="flex items-center">
                                                                <i data-lucide="droplets" class="w-3 h-3 mr-1 text-blue-500"></i>
                                                                <span x-text="item.glass_type"></span>
                                                            </div>
                                                        </template>
                                                        <template x-if="item.paint_type">
                                                            <div class="flex items-center">
                                                                <i data-lucide="palette" class="w-3 h-3 mr-1 text-purple-500"></i>
                                                                <span x-text="item.paint_type"></span>
                                                                <template x-if="item.paint_color">
                                                                    <span class="ml-1">(<span x-text="item.paint_color"></span>)</span>
                                                                </template>
                                                            </div>
                                                        </template>
                                                        <template x-if="item.cnc_specs">
                                                            <div class="flex items-center">
                                                                <i data-lucide="cpu" class="w-3 h-3 mr-1 text-green-500"></i>
                                                                <span x-text="item.cnc_specs"></span>
                                                            </div>
                                                        </template>
                                                        <template x-if="item.cutting_specs">
                                                            <div class="flex items-center">
                                                                <i data-lucide="scissors" class="w-3 h-3 mr-1 text-orange-500"></i>
                                                                <span x-text="item.cutting_specs"></span>
                                                            </div>
                                                        </template>
                                                        <template x-if="item.preparation_specs">
                                                            <div class="flex items-center">
                                                                <i data-lucide="settings" class="w-3 h-3 mr-1 text-purple-500"></i>
                                                                <span x-text="item.preparation_specs"></span>
                                                            </div>
                                                        </template>
                                                        <template x-if="item.packaging_notes">
                                                            <div class="flex items-center">
                                                                <i data-lucide="package" class="w-3 h-3 mr-1 text-indigo-500"></i>
                                                                <span x-text="item.packaging_notes"></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                                    <div class="ml-3">
                                                        <template x-if="item.id === selectedStage.order_item.id">
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                                <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                                                                Текущий
                                                            </span>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Все этапы заказа -->
                        <template x-if="selectedStage.order_item && selectedStage.order_item.order && selectedStage.order_item.order.stages">
                            <div class="mb-6">
                                <div class="bg-orange-50 rounded-xl p-4 border-l-4 border-orange-400">
                                    <h3 class="font-semibold text-orange-900 mb-3">Все этапы заказа</h3>
                                    <div class="space-y-2">
                                        <template x-for="orderStage in selectedStage.order_item.order.stages" :key="orderStage.id">
                                            <div class="bg-white rounded-lg p-3 border-2" :class="orderStage.id === selectedStage.id ? 'border-orange-500 bg-orange-50' : 'border-gray-200'">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex-1">
                                                        <!-- Фото товара для этапа -->
                                                        <template x-if="selectedStage.order_item.product && selectedStage.order_item.product.img">
                                                            <div class="mb-2">
                                                                <img :src="selectedStage.order_item.product.img" 
                                                                     :alt="selectedStage.order_item.product.name"
                                                                     class="w-12 h-12 object-cover rounded border border-gray-200">
                                                            </div>
                                                        </template>
                                                        <div class="font-medium text-gray-900" x-text="orderStage.workshop ? orderStage.workshop.name : 'Цех не указан'"></div>
                                                        <div class="text-sm text-gray-600 mt-1">
                                                            <span x-text="orderStage.operation || 'Операция не указана'"></span>
                                                            <template x-if="orderStage.sequence">
                                                                <span class="ml-2 text-gray-500">• Последовательность: <span x-text="orderStage.sequence"></span></span>
                                                            </template>
                                                        </div>
                                                        <div class="text-xs text-gray-500 mt-1">
                                                            План: <span x-text="orderStage.plan_quantity || 0"></span> •
                                                            Выполнено: <span class="text-green-600" x-text="orderStage.done_count || 0"></span> •
                                                            Брак: <span class="text-red-600" x-text="orderStage.defective_count || 0"></span>
                                                        </div>
                                                    </div>
                                                    <div class="ml-3">
                                                        <template x-if="orderStage.id === selectedStage.id">
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                                                <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                                                                Текущий
                                                            </span>
                                                        </template>
                                                        <template x-if="orderStage.id !== selectedStage.id">
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" :class="orderStage.status === 'done' ? 'bg-green-100 text-green-800' : orderStage.status === 'in_progress' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'">
                                                                <span x-text="orderStage.status === 'done' ? 'Завершен' : orderStage.status === 'in_progress' ? 'В работе' : orderStage.status"></span>
                                                            </span>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Браки по заказу -->
                        <template x-if="selectedStage.order_item && selectedStage.order_item.order && selectedStage.order_item.order.defects && selectedStage.order_item.order.defects.length > 0">
                            <div class="mb-6">
                                <div class="bg-red-50 rounded-xl p-4 border-l-4 border-red-400">
                                    <h3 class="font-semibold text-red-900 mb-3">Браки по заказу</h3>
                                    <div class="space-y-2">
                                        <template x-for="defect in selectedStage.order_item.order.defects" :key="defect.id">
                                            <div class="bg-white rounded-lg p-3 border border-red-200">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex-1">
                                                        <!-- Фото товара для брака -->
                                                        <template x-if="selectedStage.order_item.product && selectedStage.order_item.product.img">
                                                            <div class="mb-2">
                                                                <img :src="selectedStage.order_item.product.img" 
                                                                     :alt="selectedStage.order_item.product.name"
                                                                     class="w-12 h-12 object-cover rounded border border-gray-200">
                                                            </div>
                                                        </template>
                                                        <div class="font-medium text-gray-900" x-text="defect.workshop ? defect.workshop.name : 'Цех не указан'"></div>
                                                        <div class="text-sm text-red-600 mt-1">
                                                            Количество: <span class="font-medium" x-text="defect.quantity"></span> шт.
                                                            <template x-if="defect.comment">
                                                                <span class="ml-2 text-gray-600">• <span x-text="defect.comment"></span></span>
                                                            </template>
                                                        </div>
                                                        <template x-if="defect.date">
                                                            <div class="text-xs text-gray-500 mt-1">
                                                                Дата: <span x-text="new Date(defect.date).toLocaleDateString('ru-RU')"></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Назначения -->
                        <div class="mb-6">
                            <div class="bg-yellow-50 rounded-xl p-4 border-l-4 border-yellow-400">
                                <h3 class="font-semibold text-yellow-900 mb-3">Назначения сотрудников</h3>
                                <template x-if="selectedStage.assigned && selectedStage.assigned.length > 0">
                                    <div class="space-y-3">
                                        <template x-for="assign in selectedStage.assigned" :key="assign.id">
                                            <div class="bg-white rounded-lg p-3 border border-yellow-200">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex-1">
                                                        <!-- Фото товара для назначения -->
                                                        <template x-if="selectedStage.order_item.product && selectedStage.order_item.product.img">
                                                            <div class="mb-2">
                                                                <img :src="selectedStage.order_item.product.img" 
                                                                     :alt="selectedStage.order_item.product.name"
                                                                     class="w-12 h-12 object-cover rounded border border-gray-200">
                                                            </div>
                                                        </template>
                                                        <div class="font-medium text-gray-900" x-text="assign.employee_name"></div>
                                                        <div class="text-sm text-gray-600 mt-1">
                                                            Назначено: <span class="font-medium" x-text="assign.quantity"></span> шт.
                                                            <template x-if="assign.completed_quantity !== undefined">
                                                                <span class="ml-3 text-green-600">
                                                                    Выполнено: <span class="font-medium" x-text="assign.completed_quantity"></span> шт.
                                                                </span>
                                                            </template>
                                                            <template x-if="assign.defective_quantity && assign.defective_quantity > 0">
                                                                <span class="ml-3 text-red-600">
                                                                    Брак: <span class="font-medium" x-text="assign.defective_quantity"></span> шт.
                                                                </span>
                                                            </template>
                                                        </div>
                                                    </div>
                                                    <div class="flex space-x-2 ml-3">
                                                        <button @click="openEditAssignModal(selectedStage, assign)" 
                                                                class="text-blue-600 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50 transition-colors mobile-touch-target"
                                                                title="Редактировать">
                                                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                                                        </button>
                                                        <button @click="deleteAssign(selectedStage, assign)" 
                                                                class="text-red-500 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition-colors mobile-touch-target"
                                                                title="Удалить">
                                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                <template x-if="!selectedStage.assigned || selectedStage.assigned.length === 0">
                                    <div class="text-center py-6 text-gray-500">
                                        <i data-lucide="user-x" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                                        <div>Сотрудники не назначены</div>
                                        <div class="text-sm">Нажмите "Распределить" для назначения задач</div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Информация о цехе -->
                        <div class="mb-6">
                            <div class="bg-indigo-50 rounded-xl p-4 border-l-4 border-indigo-400">
                                <h3 class="font-semibold text-indigo-900 mb-3">Информация о цехе</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-indigo-700 font-medium">Название:</span>
                                        <span class="text-indigo-900" x-text="selectedStage.workshop ? selectedStage.workshop.name : 'Не указан'"></span>
                                    </div>
                                    <template x-if="selectedStage.workshop && selectedStage.workshop.description">
                                        <div class="flex justify-between">
                                            <span class="text-indigo-700 font-medium">Описание:</span>
                                            <span class="text-indigo-900" x-text="selectedStage.workshop.description"></span>
                                        </div>
                                    </template>
                                    <template x-if="selectedStage.workshop_info">
                                        <div class="mt-3 pt-3 border-t border-indigo-200">
                                            <div class="text-indigo-800 font-medium mb-2">Спецификации цеха:</div>
                                            <template x-if="selectedStage.workshop_info.cutting_specs">
                                                <div class="flex justify-between">
                                                    <span class="text-indigo-700 font-medium">Распил:</span>
                                                    <span class="text-indigo-900" x-text="selectedStage.workshop_info.cutting_specs"></span>
                                                </div>
                                            </template>
                                            <template x-if="selectedStage.workshop_info.cnc_specs">
                                                <div class="flex justify-between">
                                                    <span class="text-indigo-700 font-medium">ЧПУ:</span>
                                                    <span class="text-indigo-900" x-text="selectedStage.workshop_info.cnc_specs"></span>
                                                </div>
                                            </template>
                                            <template x-if="selectedStage.workshop_info.paint_type">
                                                <div class="flex justify-between">
                                                    <span class="text-indigo-700 font-medium">Краска:</span>
                                                    <span class="text-indigo-900" x-text="selectedStage.workshop_info.paint_type"></span>
                                                    <template x-if="selectedStage.workshop_info.paint_color">
                                                        <span class="ml-1">(<span x-text="selectedStage.workshop_info.paint_color"></span>)</span>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Общая статистика по заказу -->
                        <template x-if="selectedStage.order_item && selectedStage.order_item.order">
                            <div class="mb-6">
                                <div class="bg-teal-50 rounded-xl p-4 border-l-4 border-teal-400">
                                    <h3 class="font-semibold text-teal-900 mb-3">Общая статистика по заказу</h3>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div class="text-center">
                                            <div class="text-teal-600 font-medium">Всего товаров</div>
                                            <div class="text-2xl font-bold text-teal-900" x-text="selectedStage.order_item.order.total_quantity || selectedStage.order_item.order.quantity || 0"></div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-teal-600 font-medium">Выполнено всего</div>
                                            <div class="text-2xl font-bold text-green-600" x-text="selectedStage.order_item.order.total_done_count || 0"></div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-teal-600 font-medium">Брак всего</div>
                                            <div class="text-2xl font-bold text-red-600" x-text="selectedStage.order_item.order.total_defective_count || 0"></div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-teal-600 font-medium">Этапов</div>
                                            <div class="text-2xl font-bold text-teal-900" x-text="selectedStage.order_item.order.stages ? selectedStage.order_item.order.stages.length : 0"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Прогресс выполнения заказа -->
                                    <template x-if="selectedStage.order_item.order.total_quantity || selectedStage.order_item.order.quantity">
                                        <div class="mt-4 pt-4 border-t border-teal-200">
                                            <div class="flex justify-between text-sm text-teal-700 mb-2">
                                                <span>Прогресс выполнения</span>
                                                <span x-text="Math.round(((selectedStage.order_item.order.total_done_count || 0) / (selectedStage.order_item.order.total_quantity || selectedStage.order_item.order.quantity)) * 100) + '%'"></span>
                                            </div>
                                            <div class="w-full bg-teal-200 rounded-full h-3">
                                                <div class="bg-teal-600 h-3 rounded-full transition-all duration-300" 
                                                     :style="'width: ' + Math.min(100, Math.max(0, ((selectedStage.order_item.order.total_done_count || 0) / (selectedStage.order_item.order.total_quantity || selectedStage.order_item.order.quantity)) * 100)) + '%'"></div>
                                            </div>
                                            <div class="flex justify-between text-xs text-teal-600 mt-1">
                                                <span>0</span>
                                                <span x-text="selectedStage.order_item.order.total_quantity || selectedStage.order_item.order.quantity"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Статистика этапа -->
                        <div class="mb-6">
                            <div class="bg-purple-50 rounded-xl p-4 border-l-4 border-purple-400">
                                <h3 class="font-semibold text-purple-900 mb-3">Статистика этапа</h3>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div class="text-center">
                                        <div class="text-purple-600 font-medium">План</div>
                                        <div class="text-2xl font-bold text-purple-900" x-text="(() => {
                                            let totalOrderItemsQuantity = 0;
                                            if (selectedStage.order_item && selectedStage.order_item.order && selectedStage.order_item.order.items) {
                                                totalOrderItemsQuantity = selectedStage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                            }
                                            return totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : selectedStage.plan_quantity;
                                        })()"></div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-purple-600 font-medium">Назначено</div>
                                        <div class="text-2xl font-bold" :class="(() => {
                                            let totalOrderItemsQuantity = 0;
                                            if (selectedStage.order_item && selectedStage.order_item.order && selectedStage.order_item.order.items) {
                                                totalOrderItemsQuantity = selectedStage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                            }
                                            const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : selectedStage.plan_quantity;
                                            return (selectedStage.assigned && selectedStage.assigned.length > 0 ? selectedStage.assigned.reduce((sum, a) => sum + a.quantity, 0) >= planQuantity ? 'text-red-600' : 'text-green-600' : 'text-purple-900');
                                        })()">
                                            <span x-text="selectedStage.assigned && selectedStage.assigned.length > 0 ? selectedStage.assigned.reduce((sum, a) => sum + a.quantity, 0) : 0"></span>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-purple-600 font-medium">Выполнено</div>
                                        <div class="text-2xl font-bold text-green-600" x-text="selectedStage.done_count || 0"></div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-purple-600 font-medium">Брак</div>
                                        <div class="text-2xl font-bold text-red-600" x-text="selectedStage.defective_count || 0"></div>
                                    </div>
                                </div>
                                
                                <!-- Прогресс выполнения этапа -->
                                <div class="mt-4 pt-4 border-t border-purple-200">
                                    <div class="flex justify-between text-sm text-purple-700 mb-2">
                                        <span>Прогресс выполнения этапа</span>
                                        <span x-text="(() => {
                                            let totalOrderItemsQuantity = 0;
                                            if (selectedStage.order_item && selectedStage.order_item.order && selectedStage.order_item.order.items) {
                                                totalOrderItemsQuantity = selectedStage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                            }
                                            const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : selectedStage.plan_quantity;
                                            return Math.round(((selectedStage.done_count || 0) / planQuantity) * 100) + '%';
                                        })()"></span>
                                    </div>
                                    <div class="w-full bg-purple-200 rounded-full h-3">
                                        <div class="bg-purple-600 h-3 rounded-full transition-all duration-300" 
                                             :style="(() => {
                                                let totalOrderItemsQuantity = 0;
                                                if (selectedStage.order_item && selectedStage.order_item.order && selectedStage.order_item.order.items) {
                                                    totalOrderItemsQuantity = selectedStage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                                }
                                                const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : selectedStage.plan_quantity;
                                                return 'width: ' + Math.min(100, Math.max(0, ((selectedStage.done_count || 0) / planQuantity) * 100)) + '%';
                                             })()"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-purple-600 mt-1">
                                        <span>0</span>
                                        <span x-text="selectedStage.plan_quantity"></span>
                                    </div>
                                </div>
                                
                                <!-- Прогресс назначения задач -->
                                <div class="mt-4 pt-4 border-t border-purple-200">
                                    <div class="flex justify-between text-sm text-purple-700 mb-2">
                                        <span>Прогресс назначения задач</span>
                                        <span x-text="(() => {
                                            let totalOrderItemsQuantity = 0;
                                            if (selectedStage.order_item && selectedStage.order_item.order && selectedStage.order_item.order.items) {
                                                totalOrderItemsQuantity = selectedStage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                            }
                                            const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : selectedStage.plan_quantity;
                                            return Math.round(((selectedStage.assigned && selectedStage.assigned.length > 0 ? selectedStage.assigned.reduce((sum, a) => sum + a.quantity, 0) : 0) / planQuantity) * 100) + '%';
                                        })()"></span>
                                    </div>
                                    <div class="w-full bg-purple-200 rounded-full h-3">
                                        <div class="h-3 rounded-full transition-all duration-300" 
                                             :class="(() => {
                                                let totalOrderItemsQuantity = 0;
                                                if (selectedStage.order_item && selectedStage.order_item.order && selectedStage.order_item.order.items) {
                                                    totalOrderItemsQuantity = selectedStage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                                }
                                                const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : selectedStage.plan_quantity;
                                                return (selectedStage.assigned && selectedStage.assigned.length > 0 ? selectedStage.assigned.reduce((sum, a) => sum + a.quantity, 0) : 0) >= planQuantity ? 'bg-red-600' : 'bg-purple-600';
                                             })()"
                                             :style="(() => {
                                                let totalOrderItemsQuantity = 0;
                                                if (selectedStage.order_item && selectedStage.order_item.order && selectedStage.order_item.order.items) {
                                                    totalOrderItemsQuantity = selectedStage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                                }
                                                const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : selectedStage.plan_quantity;
                                                return 'width: ' + Math.min(100, Math.max(0, ((selectedStage.assigned && selectedStage.assigned.length > 0 ? selectedStage.assigned.reduce((sum, a) => sum + a.quantity, 0) : 0) / planQuantity) * 100)) + '%';
                                             })()"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-purple-600 mt-1">
                                        <span>0</span>
                                        <span x-text="selectedStage.plan_quantity"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Кнопки действий -->
                <div class="p-4 border-t border-gray-100 bg-white sticky bottom-0">
                    <div class="flex flex-wrap gap-2">
                        <button @click="openAssignModal(selectedStage)" 
                                class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                            <i data-lucide="user-plus" class="w-4 h-4 inline mr-2"></i>
                            Распределить
                        </button>
                        <!-- Кнопки перевода - скрываем для цеха 4 (Пресс) -->
                        <template x-if="!(workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 4)">
                            <button @click="openTransferModal(selectedStage)" 
                                    class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors">
                                <i data-lucide="arrow-right" class="w-4 h-4 inline mr-2"></i>
                                Перевести
                            </button>
                        </template>
                        <template x-if="!(workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 4)">
                            <button @click="openNoTransferModal(selectedStage)" 
                                    class="flex-1 px-4 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition-colors">
                                <i data-lucide="slash" class="w-4 h-4 inline mr-2"></i>
                                Не переводить
                            </button>
                        </template>
                        <!-- Кнопка отметки выполнения для цеха 4 (Пресс) - простое подтверждение -->
                        <template x-if="(workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 4)">
                            <button @click="openSimpleCompletionModal(selectedStage)" 
                                    class="flex-1 px-4 py-3 bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600 transition-colors">
                                <i data-lucide="check-square" class="w-4 h-4 inline mr-2"></i>
                                Выполнено
                            </button>
                        </template>
                        <!-- Кнопка отметки выполнения для цехов 8 и 10 - с назначениями -->
                        <template x-if="(workshops[selectedWorkshopIdx] && (workshops[selectedWorkshopIdx].id === 8 || workshops[selectedWorkshopIdx].id === 10))">
                            <button @click="openMarkCompletionModal(selectedStage)" 
                                    class="flex-1 px-4 py-3 bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600 transition-colors">
                                <i data-lucide="check-square" class="w-4 h-4 inline mr-2"></i>
                                Выполнено
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Assign Modal (Bulk like mark completion) -->
    <template x-if="showAssignModal">
        <div class="fixed inset-0 z-50 flex items-end justify-center modal-bg" @click.self="showAssignModal = false">
            <div class="modal-content bg-white rounded-t-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-900">Распределить работу</h2>
                    <button @click="showAssignModal = false" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <form @submit.prevent="submitAssign" class="space-y-4">
                    <!-- Инфо по заказу -->
                    <template x-if="assignForm.stage_id">
                        <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                            <div class="text-sm font-semibold text-blue-800 mb-2">Информация о заказе</div>
                            <div class="text-xs text-blue-700">
                                <div class="flex justify-between">
                                    <span class="font-medium">План:</span>
                                    <span x-text="getPlanQuantity(stages.find(s => s.id === assignForm.stage_id))"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">Уже назначено:</span>
                                    <span x-text="(stages.find(s => s.id === assignForm.stage_id)?.assigned || []).reduce((sum,a)=>sum+a.quantity,0)"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">Доступно:</span>
                                    <span x-text="maxAssignableQuantity"></span>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Список сотрудников с вводом количества -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Сотрудники</label>
                        <template x-if="filteredEmployees.length === 0">
                            <div class="text-gray-400 text-sm">Нет доступных сотрудников</div>
                        </template>
                        <div class="space-y-2">
                            <template x-for="emp in filteredEmployees" :key="emp.id">
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200">
                                    <div class="text-sm font-medium text-gray-900" x-text="emp.name"></div>
                                    <div class="flex items-center space-x-2">
                                        <button type="button" @click="bulkAssign[emp.id] = Math.max(0, (parseInt(bulkAssign[emp.id])||0) - 1)" class="w-8 h-8 rounded bg-white border border-gray-300 text-blue-600">-</button>
                                        <input type="number" class="w-16 text-center px-2 py-1 border border-gray-300 rounded"
                                            x-model="bulkAssign[emp.id]"
                                            @blur="bulkAssign[emp.id] = Math.max(0, parseInt(bulkAssign[emp.id]) || 0)"
                                            min="0" placeholder="0">
                                        <button type="button" @click="bulkAssign[emp.id] = Math.min(maxAssignableQuantity - totalBulkAssign, (parseInt(bulkAssign[emp.id])||0) + 1)" class="w-8 h-8 rounded bg-white border border-gray-300 text-blue-600">+</button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="text-xs mt-2" :class="totalBulkAssign > maxAssignableQuantity ? 'text-red-600' : 'text-gray-500'">
                            Выбрано к назначению: <span x-text="totalBulkAssign"></span> / <span x-text="maxAssignableQuantity"></span>
                            <template x-if="totalBulkAssign > maxAssignableQuantity">
                                <span class="ml-1">— превышает доступное</span>
                            </template>
                        </div>
                    </div>

                    <template x-if="workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 7">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Слоёв на единицу</label>
                            <input type="number" min="1" x-model="assignForm.layers_per_unit" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="1">
                            <div class="text-xs text-gray-500 mt-1">Укажите сколько слоёв выполняется на одну единицу товара.</div>
                        </div>
                    </template>

                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 text-xs text-blue-800">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                        Назначения будут созданы одним действием. Нельзя превышать план.
                    </div>

                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" @click="showAssignModal = false" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700">Отмена</button>
                        <button type="submit" data-submit-assign class="px-6 py-3 bg-blue-600 text-white rounded-lg"
                                :disabled="isSubmitting || totalBulkAssign < 1 || totalBulkAssign > maxAssignableQuantity">
                            <template x-if="isSubmitting">
                                <i data-lucide="loader" class="w-5 h-5 animate-spin mr-2"></i>
                            </template>
                            <span x-text="isSubmitting ? 'Назначается...' : 'Назначить'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </template>
    <!-- Edit Assign Modal -->
    <template x-if="showEditAssignModal">
        <div class="fixed inset-0 z-50 flex items-center justify-center modal-bg">
            <div class="modal-content bg-white rounded-xl p-6 w-full max-w-sm mx-4">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Редактировать назначение</h3>
                    <p class="text-gray-600 mb-2" x-text="editAssignForm.employee_name"></p>
                    
                    <!-- Детальная информация о заказе -->
                    <template x-if="editAssignForm.stage_id">
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg text-left text-sm border-l-4 border-blue-400">
                            <div class="text-sm font-semibold text-blue-800 mb-2">Информация о заказе:</div>
                            <template x-if="stages.find(s => s.id === editAssignForm.stage_id)">
                                <div class="space-y-1 text-xs text-blue-700">
                                    <template x-if="stages.find(s => s.id === editAssignForm.stage_id).order_item && stages.find(s => s.id === editAssignForm.stage_id).order_item.order">
                                        <div><span class="font-medium">Заявка:</span> <span x-text="stages.find(s => s.id === editAssignForm.stage_id).order_item.order.name || 'Не указано'"></span></div>
                                        <template x-if="stages.find(s => s.id === editAssignForm.stage_id).order_item.order.client">
                                            <div><span class="font-medium">Клиент:</span> <span x-text="stages.find(s => s.id === editAssignForm.stage_id).order_item.order.client.name || 'Не указан'"></span></div>
                                        </template>
                                        <div><span class="font-medium">Дата создания:</span> <span x-text="stages.find(s => s.id === editAssignForm.stage_id).order_item.order.created_at ? new Date(stages.find(s => s.id === editAssignForm.stage_id).order_item.order.created_at).toLocaleDateString('ru-RU') : 'Не указана'"></span></div>
                                        <div><span class="font-medium">Статус заказа:</span> <span x-text="stages.find(s => s.id === editAssignForm.stage_id).order_item.order.status_display || 'Не указан'"></span></div>
                                        <template x-if="stages.find(s => s.id === editAssignForm.stage_id).order_item.order.comment">
                                            <div><span class="font-medium">Комментарий:</span> <span x-text="stages.find(s => s.id === editAssignForm.stage_id).order_item.order.comment"></span></div>
                                        </template>
                                    </template>
                                    <template x-if="stages.find(s => s.id === editAssignForm.stage_id).order_item && stages.find(s => s.id === editAssignForm.stage_id).order_item !== null">
                                        <div class="mt-2 pt-2 border-t border-blue-200">
                                            <div><span class="font-medium">Товар:</span> <span x-text="stages.find(s => s.id === editAssignForm.stage_id).order_item.product ? stages.find(s => s.id === editAssignForm.stage_id).order_item.product.name : 'Не указан'"></span></div>
                                            
                                            <!-- Фото товара -->
                                            <template x-if="stages.find(s => s.id === editAssignForm.stage_id).order_item.product && stages.find(s => s.id === editAssignForm.stage_id).order_item.product.img">
                                                <div class="mt-2 text-center">
                                                    <img :src="stages.find(s => s.id === editAssignForm.stage_id).order_item.product.img" 
                                                         :alt="stages.find(s => s.id === editAssignForm.stage_id).order_item.product.name"
                                                         class="w-16 h-16 object-cover rounded border border-gray-200 mx-auto">
                                                </div>
                                            </template>
                                            <template x-if="stages.find(s => s.id === editAssignForm.stage_id).order_item.size">
                                                <div><span class="font-medium">Размер:</span> <span x-text="stages.find(s => s.id === editAssignForm.stage_id).order_item.size"></span></div>
                                            </template>
                                            <template x-if="stages.find(s => s.id === editAssignForm.stage_id).order_item.color">
                                                <div><span class="font-medium">Цвет:</span> <span x-text="stages.find(s => s.id === editAssignForm.stage_id).order_item.color"></span></div>
                                            </template>
                                            
                                            <!-- Все товары заказа в модальном окне редактирования -->
                                                                                         <template x-if="stages.find(s => s.id === editAssignForm.stage_id).order_item && stages.find(s => s.id === editAssignForm.stage_id).order_item !== null && stages.find(s => s.id === editAssignForm.stage_id).order_item.order && stages.find(s => s.id === editAssignForm.stage_id).order_item.order.items && Array.isArray(stages.find(s => s.id === editAssignForm.stage_id).order_item.order.items) && stages.find(s => s.id === editAssignForm.stage_id).order_item.order.items.length > 1">
                                                <div class="mt-2 pt-2 border-t border-blue-200">
                                                    <div class="text-xs font-semibold text-blue-800 mb-1">Все товары заказа:</div>
                                                    <div class="space-y-1">
                                                        <template x-for="item in stages.find(s => s.id === editAssignForm.stage_id).order_item.order.items" :key="item.id">
                                                            <div class="text-xs border-l-2 border-blue-300 pl-2 py-1" :class="item.id === stages.find(s => s.id === editAssignForm.stage_id).order_item.id ? 'border-l-blue-600 bg-blue-100' : ''">
                                                                <div class="flex items-center justify-between">
                                                                    <div class="flex-1">
                                                                        <!-- Фото товара -->
                                                                        <template x-if="item.product && item.product.img">
                                                                            <div class="mb-1">
                                                                                <img :src="item.product.img" 
                                                                                     :alt="item.product.name"
                                                                                     class="w-8 h-8 object-cover rounded border border-gray-200">
                                                                            </div>
                                                                        </template>
                                                                        <div class="font-medium text-blue-700" x-text="item.product && item.product.name ? item.product.name : 'Не указан'"></div>
                                                                        <div class="text-blue-600 text-xs">
                                                                            <span x-text="item.quantity"></span> шт.
                                                                            <template x-if="item.size"> • <span x-text="item.size"></span></template>
                                                                            <template x-if="item.color"> • <span x-text="item.color"></span></template>
                                                                            <template x-if="item.product && item.product.is_glass">
                                                                                <span class="text-blue-600"> • Стекло</span>
                                            </template>
                                        </div>
                                                                    </div>
                                                                    <div class="ml-2 text-xs text-blue-500">
                                                                        <template x-if="item.id === stages.find(s => s.id === editAssignForm.stage_id).order_item.id">
                                                                            <span class="font-semibold">← Текущий</span>
                                    </template>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
                <form @submit.prevent="submitEditAssign" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Количество <span class="text-red-500">*</span></label>
                        <div class="flex items-center space-x-2">
                            <button type="button" @click="editAssignForm.quantity = Math.max(1, editAssignForm.quantity - 1)" class="w-10 h-10 rounded-full bg-gray-100 text-2xl font-bold text-blue-600 flex items-center justify-center hover:bg-gray-200 transition-colors">-</button>
                            <input type="number" 
                                   x-model="editAssignForm.quantity" 
                                   class="w-20 text-center px-2 py-2 border border-gray-300 rounded-lg text-lg font-bold focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   required 
                                   placeholder="1"
                                   @blur="editAssignForm.quantity = Math.max(1, Math.min(parseInt(editAssignForm.quantity) || 1, maxEditableQuantity))">
                            <button type="button" @click="editAssignForm.quantity = Math.min(maxEditableQuantity, editAssignForm.quantity + 1)" class="w-10 h-10 rounded-full bg-gray-100 text-2xl font-bold text-blue-600 flex items-center justify-center hover:bg-gray-200 transition-colors">+</button>
                        </div>
                        <div class="text-xs mt-1" :class="maxEditableQuantity <= 5 ? 'text-red-500 font-semibold' : 'text-gray-500'">
                            Доступно для назначения: <span x-text="maxEditableQuantity"></span>
                            <template x-if="editAssignForm.stage_id && stages.find(s => s.id === editAssignForm.stage_id)">
                                <template x-if="stages.find(s => s.id === editAssignForm.stage_id).order_item && stages.find(s => s.id === editAssignForm.stage_id).order_item.order && stages.find(s => s.id === editAssignForm.stage_id).order_item.order.items">
                                    <span class="ml-1 text-blue-600">
                                        (из <span x-text="(() => {
                                            const stage = stages.find(s => s.id === editAssignForm.stage_id);
                                            let totalOrderItemsQuantity = 0;
                                            if (stage && stage.order_item && stage.order_item.order && stage.order_item.order.items) {
                                                totalOrderItemsQuantity = stage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                            }
                                            return totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : stage.plan_quantity;
                                        })()"></span> товаров заказа)
                                    </span>
                                </template>
                            </template>
                            <template x-if="maxEditableQuantity <= 5 && maxEditableQuantity > 0">
                                <span class="ml-1">⚠️ Осталось мало!</span>
                            </template>
                            <template x-if="maxEditableQuantity === 1">
                                <span class="ml-1">⚠️ Минимальное количество!</span>
                            </template>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Цена за единицу (опционально)</label>
                        <input type="number" step="0.01" min="0" x-model="editAssignForm.custom_unit_price" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Например: 120.00">
                        <div class="text-xs text-gray-500 mt-1">Если указать, оплата пойдёт по этой цене вместо цены услуги.</div>
                    </div>

                    <template x-if="workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 7">
                        <div class="mt-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Слоёв на единицу</label>
                            <input type="number" min="1" x-model="editAssignForm.layers_per_unit" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="1">
                            <div class="text-xs text-gray-500 mt-1">Укажите сколько слоёв выполняется на одну единицу товара.</div>
                        </div>
                    </template>

                    <div class="flex space-x-3 mt-4">
                        <button type="button" @click="showEditAssignModal = false" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700">Отмена</button>
                        <button type="submit" data-submit-edit-assign class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg" :disabled="editAssignForm.quantity > maxEditableQuantity || editAssignForm.quantity < 1 || isSubmitting">
                            <template x-if="isSubmitting">
                                <i data-lucide="loader" class="w-5 h-5 animate-spin mr-2"></i>
                            </template>
                            <span x-text="isSubmitting ? 'Сохраняется...' : 'Сохранить'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </template>
    <!-- Модалка подтверждения перевода дальше -->
    <template x-if="showTransferModal">
        <div class="fixed inset-0 z-50 flex items-center justify-center modal-bg">
            <div class="modal-content bg-white p-6 mx-4">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Перевести этап дальше?</h3>
                    <template x-if="workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 1">
                        <p class="text-gray-600 mb-2">Выполненная работа будет передана на следующий этап. Для цеха распила можно переводить даже неполное количество.</p>
                    </template>
                    <template x-if="!(workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 1)">
                        <p class="text-gray-600 mb-2">Выполненная работа будет передана на следующий этап. Для перевода необходимо выполнить план полностью.</p>
                    </template>
                    
                    <!-- Детальная информация о заказе -->
                    <template x-if="transferStageId">
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg text-left text-sm border-l-4 border-blue-400">
                            <div class="text-sm font-semibold text-blue-800 mb-2">Информация о заказе:</div>
                            <template x-if="stages.find(s => s.id === transferStageId)">
                                <div class="space-y-1 text-xs text-blue-700">
                                    <template x-if="stages.find(s => s.id === transferStageId).order_item && stages.find(s => s.id === transferStageId).order_item !== null && stages.find(s => s.id === transferStageId).order_item.order">
                                        <div><span class="font-medium">Заявка:</span> <span x-text="stages.find(s => s.id === transferStageId).order_item.order.name || 'Не указано'"></span></div>
                                        <template x-if="stages.find(s => s.id === transferStageId).order_item.order.client">
                                            <div><span class="font-medium">Клиент:</span> <span x-text="stages.find(s => s.id === transferStageId).order_item.order.client.name || 'Не указан'"></span></div>
                                        </template>
                                        <div><span class="font-medium">Товар:</span> <span x-text="stages.find(s => s.id === transferStageId).order_item.product ? stages.find(s => s.id === transferStageId).order_item.product.name : 'Не указан'"></span></div>
                                        
                                        <!-- Фото товара -->
                                        <template x-if="stages.find(s => s.id === transferStageId).order_item.product && stages.find(s => s.id === transferStageId).order_item.product.img">
                                            <div class="mt-2 text-center">
                                                <img :src="stages.find(s => s.id === transferStageId).order_item.product.img" 
                                                     :alt="stages.find(s => s.id === transferStageId).order_item.product.name"
                                                     class="w-16 h-16 object-cover rounded border border-gray-200 mx-auto">
                                            </div>
                                        </template>
                                        <div><span class="font-medium">План:</span> <span x-text="(() => {
                                            const stage = stages.find(s => s.id === transferStageId);
                                            let totalOrderItemsQuantity = 0;
                                            if (stage && stage.order_item && stage.order_item.order && stage.order_item.order.items) {
                                                totalOrderItemsQuantity = stage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                            }
                                            return totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : stage.plan_quantity;
                                        })()"></span></div>
                                        <div><span class="font-medium">Выполнено:</span> <span x-text="stages.find(s => s.id === transferStageId).done_count"></span></div>
                                        
                                        <!-- Все товары заказа в модальном окне перевода -->
                                        <template x-if="stages.find(s => s.id === transferStageId).order_item && stages.find(s => s.id === transferStageId).order_item !== null && stages.find(s => s.id === transferStageId).order_item.order && stages.find(s => s.id === transferStageId).order_item.order.items && Array.isArray(stages.find(s => s.id === transferStageId).order_item.order.items) && stages.find(s => s.id === transferStageId).order_item.order.items.length > 1">
                                            <div class="mt-2 pt-2 border-t border-blue-200">
                                                <div class="text-xs font-semibold text-blue-800 mb-1">Все товары заказа:</div>
                                                <div class="space-y-1">
                                                    <template x-for="item in stages.find(s => s.id === transferStageId).order_item.order.items" :key="item.id">
                                                        <div class="text-xs border-l-2 border-blue-300 pl-2 py-1" :class="item.id === stages.find(s => s.id === transferStageId).order_item.id ? 'border-l-blue-600 bg-blue-100' : ''">
                                                            <div class="flex items-center justify-between">
                                                                <div class="flex-1">
                                                                    <!-- Фото товара -->
                                                                    <template x-if="item.product && item.product.img">
                                                                        <div class="mb-1">
                                                                            <img :src="item.product.img" 
                                                                                 :alt="item.product.name"
                                                                                 class="w-8 h-8 object-cover rounded border border-gray-200">
                                                                        </div>
                                                                    </template>
                                                                    <div class="font-medium text-blue-700" x-text="item.product && item.product.name ? item.product.name : 'Не указан'"></div>
                                                                    <div class="text-blue-600 text-xs">
                                                                        <span x-text="item.quantity"></span> шт.
                                                                        <template x-if="item.size"> • <span x-text="item.size"></span></template>
                                                                        <template x-if="item.color"> • <span x-text="item.color"></span></template>
                                                                        <template x-if="item.product && item.product.is_glass">
                                                                            <span class="text-blue-600"> • Стекло</span>
                                    </template>
                                </div>
                                                                </div>
                                                                <div class="ml-2 text-xs text-blue-500">
                                                                    <template x-if="item.id === stages.find(s => s.id === transferStageId).order_item.id">
                                                                        <span class="font-semibold">← Текущий</span>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
                <div class="flex responsive-btn-row flex-wrap gap-2 mt-4">
                    <button type="button" @click="cancelTransfer()" class="flex-1 px-4 py-3 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 border border-gray-300 text-gray-700 font-semibold text-base">Отмена</button>
                    <button type="button" @click="confirmTransferFirst()" class="flex-1 px-4 py-3 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-green-400 bg-green-600 text-white font-semibold text-base">Перевести</button>
                </div>
            </div>
        </div>
    </template>
    <!-- Второе подтверждение перевода дальше -->
    <template x-if="showTransferConfirmModal">
        <div class="fixed inset-0 z-50 flex items-center justify-center modal-bg">
            <div class="modal-content bg-white p-6 mx-4">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Вы уверены?</h3>
                    <p class="text-gray-600 mb-2">Это действие нельзя отменить. Перевести этап дальше?</p>
                </div>
                <div class="flex responsive-btn-row flex-wrap gap-2 mt-4">
                    <button type="button" @click="cancelTransfer()" class="flex-1 px-4 py-3 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 border border-gray-300 text-gray-700 font-semibold text-base" :disabled="loadingAction === 'transfer'">Нет, отменить</button>
                    <button type="button" @click="selectTransferWorkshop()" class="flex-1 px-4 py-3 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-green-400 bg-green-600 text-white font-semibold text-base flex items-center justify-center" :disabled="loadingAction === 'transfer'">
                        <span>Выбрать цех</span>
                    </button>
                    <button type="button" @click="confirmTransferFinal()" class="flex-1 px-4 py-3 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 bg-blue-600 text-white font-semibold text-base flex items-center justify-center" :disabled="loadingAction === 'transfer'">
                        <span>Да, я уверен</span>
                    </button>
                </div>
            </div>
        </div>
    </template>
    <!-- Выбор целевого цеха для перевода -->
    <template x-if="showTransferDestinationModal">
        <div class="fixed inset-0 z-50 flex items-end justify-center modal-bg" @click.self="showTransferDestinationModal = false">
            <div class="modal-content bg-white rounded-t-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-900">В какой цех переводим?</h2>
                    <button @click="showTransferDestinationModal = false" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <!-- Информация о товаре -->
                    <template x-if="transferStageId && stages.find(s => s.id === transferStageId)">
                        <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                            <div class="text-sm font-semibold text-blue-800 mb-2">Информация о товаре:</div>
                            <template x-if="stages.find(s => s.id === transferStageId).order_item && stages.find(s => s.id === transferStageId).order_item.product">
                                <div class="text-center">
                                    <!-- Фото товара -->
                                    <template x-if="stages.find(s => s.id === transferStageId).order_item.product.img">
                                        <div class="mb-2">
                                            <img :src="stages.find(s => s.id === transferStageId).order_item.product.img" 
                                                 :alt="stages.find(s => s.id === transferStageId).order_item.product.name"
                                                 class="w-20 h-20 object-cover rounded border border-gray-200 mx-auto">
                                        </div>
                                    </template>
                                    <div class="text-sm font-medium text-blue-900" x-text="stages.find(s => s.id === transferStageId).order_item.product.name"></div>
                                    <div class="text-xs text-blue-700" x-text="stages.find(s => s.id === transferStageId).order_item.order ? stages.find(s => s.id === transferStageId).order_item.order.name : ''"></div>
                                </div>
                            </template>
                        </div>
                    </template>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Цех <span class="text-red-500">*</span></label>
                        <select x-model.number="transferTargetWorkshopId" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled>Выберите цех</option>
                            <template x-for="ws in allWorkshops" :key="ws.id">
                                <option :value="ws.id" x-text="ws.name"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Сколько передаём</label>
                        <div class="flex items-center space-x-2">
                            <button type="button" @click="transferQuantity = Math.max(0, transferQuantity - 1)" class="w-10 h-10 rounded-full bg-gray-100 text-2xl font-bold text-blue-600 flex items-center justify-center">-</button>
                            <input type="number" x-model="transferQuantity" class="w-20 text-center px-2 py-2 border border-gray-300 rounded-lg text-lg font-bold" placeholder="0" @blur="transferQuantity = Math.max(0, Math.min(parseInt(transferQuantity) || 0, transferMaxQuantity))">
                            <button type="button" @click="transferQuantity = Math.min(transferMaxQuantity, transferQuantity + 1)" class="w-10 h-10 rounded-full bg-gray-100 text-2xl font-bold text-blue-600 flex items-center justify-center">+</button>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Доступно к передаче: <span x-text="transferMaxQuantity"></span>
                            <template x-if="workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 1 && transferMaxQuantity < stages.find(s => s.id === transferStageId)?.plan_quantity">
                                <span class="ml-2 text-orange-600">⚠️ Неполное выполнение плана (разрешено для цеха распила)</span>
    </template>
                            <template x-if="!(workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 1) && transferMaxQuantity < stages.find(s => s.id === transferStageId)?.plan_quantity">
                                <span class="ml-2 text-red-600">❌ Необходимо выполнить план полностью</span>
                                        </template>
                            <template x-if="transferMaxQuantity === 0 && (workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 1)">
                                <span class="ml-2 text-orange-600">⚠️ Нет выполненной работы (разрешено для цеха распила)</span>
                                    </template>
                            <template x-if="transferMaxQuantity === 0 && !(workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 1)">
                                <span class="ml-2 text-red-600">❌ Нет выполненной работы для передачи</span>
                            </template>
                        </div>
                </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" @click="cancelTransfer()" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700">Отмена</button>
                    <button type="button" @click="confirmTransferFirst()" class="px-6 py-3 bg-green-600 text-white rounded-lg" :disabled="!transferTargetWorkshopId || transferQuantity < 1 || (transferMaxQuantity === 0 && !(workshops[selectedWorkshopIdx] && workshops[selectedWorkshopIdx].id === 1))">Перевести</button>
            </div>
        </div>
                </div>
                        </template>

    <!-- Модалка подтверждения не переводить -->
    <template x-if="showNoTransferModal">
        <div class="fixed inset-0 z-50 flex items-center justify-center modal-bg">
            <div class="modal-content bg-white p-6 mx-4">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Не переводить этап?</h3>
                    <p class="text-gray-600 mb-2">Этап останется в текущем цеху без перевода на следующий этап. Продолжить?</p>
                    
                    <!-- Детальная информация о заказе -->
                    <template x-if="noTransferStageId">
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg text-left text-sm border-l-4 border-blue-400">
                            <div class="text-sm font-semibold text-blue-800 mb-2">Информация о заказе:</div>
                            <template x-if="stages.find(s => s.id === noTransferStageId)">
                                <div class="space-y-1 text-xs text-blue-700">
                                    <template x-if="stages.find(s => s.id === noTransferStageId).order_item && stages.find(s => s.id === noTransferStageId).order_item !== null && stages.find(s => s.id === noTransferStageId).order_item.order">
                                        <div><span class="font-medium">Заявка:</span> <span x-text="stages.find(s => s.id === noTransferStageId).order_item.order.name || 'Не указано'"></span></div>
                                        <template x-if="stages.find(s => s.id === noTransferStageId).order_item.order.client">
                                            <div><span class="font-medium">Клиент:</span> <span x-text="stages.find(s => s.id === noTransferStageId).order_item.order.client.name || 'Не указан'"></span></div>
                                        </template>
                                        <div><span class="font-medium">Товар:</span> <span x-text="stages.find(s => s.id === noTransferStageId).order_item.product ? stages.find(s => s.id === noTransferStageId).order_item.product.name : 'Не указан'"></span></div>
                                        
                                        <!-- Фото товара -->
                                        <template x-if="stages.find(s => s.id === noTransferStageId).order_item.product && stages.find(s => s.id === noTransferStageId).order_item.product.img">
                                            <div class="mt-2 text-center">
                                                <img :src="stages.find(s => s.id === noTransferStageId).order_item.product.img" 
                                                     :alt="stages.find(s => s.id === noTransferStageId).order_item.product.name"
                                                     class="w-16 h-16 object-cover rounded border border-gray-200 mx-auto">
                                            </div>
                                        </template>
                                        <div><span class="font-medium">План:</span> <span x-text="(() => {
                                            const stage = stages.find(s => s.id === noTransferStageId);
                                            let totalOrderItemsQuantity = 0;
                                            if (stage && stage.order_item && stage.order_item.order && stage.order_item.order.items) {
                                                totalOrderItemsQuantity = stage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                            }
                                            return totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : stage.plan_quantity;
                                        })()"></span></div>
                                        <div><span class="font-medium">Выполнено:</span> <span x-text="stages.find(s => s.id === noTransferStageId).done_count"></span></div>
                                        
                                        <!-- Все товары заказа в модальном окне "не переводить" -->
                                        <template x-if="stages.find(s => s.id === noTransferStageId).order_item && stages.find(s => s.id === noTransferStageId).order_item !== null && stages.find(s => s.id === noTransferStageId).order_item.order && stages.find(s => s.id === noTransferStageId).order_item.order.items && Array.isArray(stages.find(s => s.id === noTransferStageId).order_item.order.items) && stages.find(s => s.id === noTransferStageId).order_item.order.items.length > 1">
                                            <div class="mt-2 pt-2 border-t border-blue-200">
                                                <div class="text-xs font-semibold text-blue-800 mb-1">Все товары заказа:</div>
                                                <div class="space-y-1">
                                                    <template x-for="item in stages.find(s => s.id === noTransferStageId).order_item.order.items" :key="item.id">
                                                        <div class="text-xs border-l-2 border-blue-300 pl-2 py-1" :class="item.id === stages.find(s => s.id === noTransferStageId).order_item.id ? 'border-l-blue-600 bg-blue-100' : ''">
                                                            <div class="flex items-center justify-between">
                                                                <div class="flex-1">
                                                                    <!-- Фото товара -->
                                                                    <template x-if="item.product && item.product.img">
                                                                        <div class="mb-1">
                                                                            <img :src="item.product.img" 
                                                                                 :alt="item.product.name"
                                                                                 class="w-8 h-8 object-cover rounded border border-gray-200">
                                                                        </div>
                                                                    </template>
                                                                    <div class="font-medium text-blue-700" x-text="item.product && item.product.name ? item.product.name : 'Не указан'"></div>
                                                                    <div class="text-blue-600 text-xs">
                                                                        <span x-text="item.quantity"></span> шт.
                                                                        <template x-if="item.size"> • <span x-text="item.size"></span></template>
                                                                        <template x-if="item.color"> • <span x-text="item.color"></span></template>
                                                                        <template x-if="item.product && item.product.is_glass">
                                                                            <span class="text-blue-600"> • Стекло</span>
                                    </template>
                                </div>
                                                                </div>
                                                                <div class="ml-2 text-xs text-blue-500">
                                                                    <template x-if="item.id === stages.find(s => s.id === noTransferStageId).order_item.id">
                                                                        <span class="font-semibold">← Текущий</span>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
                <div class="flex responsive-btn-row flex-wrap gap-2 mt-4">
                    <button type="button" @click="cancelNoTransfer()" class="flex-1 px-4 py-3 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 border border-gray-300 text-gray-700 font-semibold text-base">Отмена</button>
                    <button type="button" @click="confirmNoTransferFirst" class="flex-1 px-4 py-3 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-red-400 bg-red-500 text-white font-semibold text-base">Не переводить</button>
                </div>
            </div>
        </div>
    </template>
    <!-- Второе подтверждение не переводить -->
    <template x-if="showNoTransferConfirmModal">
        <div class="fixed inset-0 z-50 flex items-center justify-center modal-bg">
            <div class="modal-content bg-white p-6 mx-4">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Вы уверены?</h3>
                    <p class="text-gray-600 mb-2">Это действие нельзя отменить. Не переводить этап?</p>
                </div>
                <div class="flex responsive-btn-row flex-wrap gap-2 mt-4">
                    <button type="button" @click="cancelNoTransfer()" class="flex-1 px-4 py-3 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 border border-gray-300 text-gray-700 font-semibold text-base" :disabled="loadingAction === 'no-transfer'">Нет, отменить</button>
                    <button type="button" @click="confirmNoTransferFinal()" class="flex-1 px-4 py-3 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-red-400 bg-red-500 text-white font-semibold text-base flex items-center justify-center" :disabled="loadingAction === 'no-transfer'">
                        <template x-if="loadingAction === 'no-transfer'">
                            <i data-lucide="loader" class="w-5 h-5 animate-spin mr-2"></i>
                        </template>
                        <span x-text="loadingAction === 'no-transfer' ? 'Выполняется...' : 'Да, уверен'"></span>
                    </button>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Модальное окно простого подтверждения выполнения для цеха 4 (Пресс) -->
    <template x-if="showSimpleCompletionModal">
        <div class="fixed inset-0 z-50 flex items-center justify-center modal-bg">
            <div class="modal-content bg-white p-6 mx-4">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Подтверждение выполнения</h3>
                    <p class="text-gray-600 mb-2">Мастер, подтвердите что работа в цехе Заготовка выполнена и проверена.</p>
                    
                    <!-- Информация о заказе -->
                    <template x-if="simpleCompletionStage">
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg text-left text-sm border-l-4 border-blue-400">
                            <div class="text-sm font-semibold text-blue-800 mb-2">Информация о заказе:</div>
                            <div class="space-y-1 text-xs text-blue-700">
                                <div><span class="font-medium">Заявка:</span> <span x-text="simpleCompletionStage.order_name || 'Не указано'"></span></div>
                                <div><span class="font-medium">Операция:</span> <span x-text="simpleCompletionStage.operation || 'Заготовка'"></span></div>
                                <div><span class="font-medium">Количество:</span> <span x-text="simpleCompletionStage.plan_quantity || 0"></span> шт.</div>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="flex responsive-btn-row flex-wrap gap-2 mt-4">
                    <button type="button" @click="cancelSimpleCompletion()" class="flex-1 px-4 py-3 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 border border-gray-300 text-gray-700 font-semibold text-base">Отмена</button>
                    <button type="button" @click="confirmSimpleCompletion()" class="flex-1 px-4 py-3 rounded-lg shadow transition transform hover:scale-105 focus:ring-2 focus:ring-offset-2 focus:ring-green-400 bg-green-600 text-white font-semibold text-base" :disabled="isSubmittingSimpleCompletion">
                        <template x-if="isSubmittingSimpleCompletion">
                            <i data-lucide="loader" class="w-5 h-5 animate-spin mr-2"></i>
                        </template>
                        <span x-text="isSubmittingSimpleCompletion ? 'Завершается...' : 'Да, работа выполнена'"></span>
                    </button>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Модальное окно отметки выполнения -->
    <template x-if="showMarkCompletionModal">
        <div class="fixed inset-0 z-50 flex items-end justify-center modal-bg" @click.self="showMarkCompletionModal = false">
            <div class="modal-content bg-white rounded-t-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-900">Отметить выполнение</h2>
                    <button @click="showMarkCompletionModal = false" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <!-- Информация о заказе -->
                    <template x-if="markCompletionStage">
                        <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                            <div class="text-sm font-semibold text-blue-800 mb-2">Информация о заказе:</div>
                            <div class="space-y-1 text-xs text-blue-700">
                                <div><span class="font-medium">Заявка:</span> <span x-text="markCompletionStage.order_name || 'Не указано'"></span></div>
                                <div><span class="font-medium">Операция:</span> <span x-text="markCompletionStage.operation || 'Не указано'"></span></div>
                                <div><span class="font-medium">План:</span> <span x-text="(() => {
                                    let totalOrderItemsQuantity = 0;
                                    if (markCompletionStage.order_item && markCompletionStage.order_item.order && markCompletionStage.order_item.order.items) {
                                        totalOrderItemsQuantity = markCompletionStage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                    }
                                    return totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : (markCompletionStage.plan_quantity || 0);
                                })()"></span></div>
                                <div><span class="font-medium">Выполнено:</span> <span x-text="markCompletionStage.done_count || 0"></span></div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Список назначений -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Назначения сотрудников</label>
                        <template x-if="markCompletionStage && markCompletionStage.assigned && markCompletionStage.assigned.length > 0">
                            <div class="space-y-3">
                                <template x-for="assign in markCompletionStage.assigned" :key="assign.id">
                                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="font-medium text-gray-900" x-text="assign.employee_name"></div>
                                            <div class="text-sm text-gray-600">
                                                Назначено: <span x-text="assign.quantity"></span> шт.
                                            </div>
                                        </div>
                                        
                                        <!-- Поля для отметки выполнения -->
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Выполнено</label>
                                                <input type="number" 
                                                       x-model="assign.completed_quantity" 
                                                       class="w-full px-2 py-2 border border-gray-300 rounded text-sm"
                                                       placeholder="0"
                                                       @blur="assign.completed_quantity = Math.max(0, Math.min(parseInt(assign.completed_quantity) || 0, assign.quantity))">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Брак</label>
                                                <input type="number" 
                                                       x-model="assign.defective_quantity" 
                                                       class="w-full px-2 py-2 border border-gray-300 rounded text-sm"
                                                       placeholder="0"
                                                       @blur="assign.defective_quantity = Math.max(0, Math.min(parseInt(assign.defective_quantity) || 0, assign.quantity))">
                                            </div>
                                        </div>
                                        
                                        <!-- Валидация -->
                                        <div class="mt-2 text-xs" :class="(assign.completed_quantity || 0) + (assign.defective_quantity || 0) > assign.quantity ? 'text-red-600' : 'text-gray-500'">
                                            <template x-if="(assign.completed_quantity || 0) + (assign.defective_quantity || 0) > assign.quantity">
                                                ⚠️ Сумма выполненных и брака превышает назначенное количество
                                            </template>
                                            <template x-if="(assign.completed_quantity || 0) + (assign.defective_quantity || 0) <= assign.quantity">
                                                Всего: <span x-text="(assign.completed_quantity || 0) + (assign.defective_quantity || 0)"></span> / <span x-text="assign.quantity"></span>
                                            </template>
                                            <template x-if="assign.completed_quantity < 0 || assign.defective_quantity < 0">
                                                ⚠️ Количество не может быть отрицательным
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="!markCompletionStage || !markCompletionStage.assigned || markCompletionStage.assigned.length === 0">
                            <div class="text-center py-6 text-gray-500">
                                <i data-lucide="user-x" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                                <div>Нет назначений для отметки</div>
                                <div class="text-sm">Сначала назначьте сотрудников на этап</div>
                            </div>
                        </template>
                        
                        <!-- Информация о том, что будет обновлено -->
                        <template x-if="markCompletionStage && markCompletionStage.assigned && markCompletionStage.assigned.length > 0" style="margin-top: 10px;">
                            <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                                <div class="text-xs text-green-800">
                                    <i data-lucide="check-circle" class="w-3 h-3 inline mr-1"></i>
                                    <strong>Будет обновлено:</strong> При сохранении автоматически обновится заработок для 
                                    <span class="font-semibold" x-text="markCompletionStage.assigned.length"></span> 
                                    <span x-text="markCompletionStage.assigned.length === 1 ? 'сотрудника' : markCompletionStage.assigned.length < 5 ? 'сотрудников' : 'сотрудников'"></span>.
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Кнопки действий -->
                <!-- Информация о заработке -->
                <div class="bg-blue-50 p-3 rounded-lg mt-4 border border-blue-200">
                    <div class="text-xs text-blue-800">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                        <strong>Важно:</strong> При сохранении выполнения автоматически обновится заработок сотрудника в системе учета.
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 mt-6">
                    <button type="button" @click="showMarkCompletionModal = false" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700">Отмена</button>
                    <button type="button" @click="submitMarkCompletion()" 
                            class="px-6 py-3 bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600 transition-colors"
                            :disabled="!canSubmitMarkCompletion || isSubmittingMarkCompletion">
                        <template x-if="isSubmittingMarkCompletion">
                            <i data-lucide="loader" class="w-5 h-5 animate-spin mr-2"></i>
                        </template>
                        <span x-text="isSubmittingMarkCompletion ? 'Сохраняется...' : 'Сохранить выполнение'"></span>
                    </button>
                </div>
            </div>
        </div>
    </template>
    
    <nav class="nav-bar fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center h-14 z-40 max-w-md mx-auto w-full">
        <a href="/dashboard/" class="flex flex-col items-center nav-active">
            <i data-lucide="home" class="w-5 h-5"></i>
            <span class="text-xs">Главная</span>
        </a>
        <a href="/employees/" class="flex flex-col items-center">
            <i data-lucide="users" class="w-5 h-5"></i>
            <span class="text-xs">Сотрудники</span>
        </a>
        <a href="/attendance/scan/" class="flex flex-col items-center justify-center w-12 h-12 bg-blue-600 rounded-full -mt-4 shadow-lg">
            <i data-lucide="qr-code" class="w-6 h-6 text-white"></i>
        </a>
        <a href="/orders/plans/master/" class="flex flex-col items-center">
            <i data-lucide="archive" class="w-5 h-5"></i>
            <span class="text-xs">Планы</span>
        </a>
        <a href="/settings/" class="flex flex-col items-center">
            <i data-lucide="settings" class="w-5 h-5"></i>
            <span class="text-xs">Настройки</span>
        </a>
    </nav>
    <!-- PWA Install Button -->
    <div x-data="{ showInstall: false, deferredPrompt: null }" x-init="
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            this.deferredPrompt = e;
            this.showInstall = true;
        });
    " class="fixed bottom-32 left-1/2 transform -translate-x-1/2 z-50">
        <button x-show="showInstall" @click="deferredPrompt.prompt(); showInstall = false;" class="px-6 py-3 bg-blue-600 text-white rounded-xl shadow-lg flex items-center space-x-2 text-base font-semibold">
            <i data-lucide='download' class='w-5 h-5'></i>
            <span>Установить приложение</span>
        </button>
    </div>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/static/sw.js');
        });
    }
    function masterPlansPage() {
        return {
            loading: true,
            workshops: [],
            selectedWorkshopIdx: 0,
            stages: [],
            employees: [],
            showStageModal: false,
            selectedStage: null,
            showAssignModal: false,
            assignForm: { stage_id: null, order_item_id: null, employee_id: '', quantity: 1, custom_unit_price: '', layers_per_unit: 1 },
            bulkAssign: {},
            showEditAssignModal: false,
            editAssignForm: { id: null, stage_id: null, employee_id: '', employee_name: '', quantity: 1 },
            showTransferModal: false,
            showTransferConfirmModal: false,
            showTransferDestinationModal: false,
            transferStageId: null,
            transferTargetWorkshopId: null,
            transferQuantity: 0,
            get transferMaxQuantity() {
                const s = this.stages.find(x => x.id === this.transferStageId);
                if (!s) return 0;
                
                // Получаем общее количество всех товаров заказа как план
                let totalOrderItemsQuantity = 0;
                if (s.order_item && s.order_item.order && s.order_item.order.items) {
                    totalOrderItemsQuantity = s.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                }
                const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : s.plan_quantity;
                
                const currentWorkshop = this.workshops[this.selectedWorkshopIdx];
                if (currentWorkshop && currentWorkshop.id === 1) {
                    // Для цеха распила можно переводить даже 0
                    return Math.max(0, s.done_count);
                } else {
                    // Для остальных цехов - только если план выполнен полностью
                    if (s.done_count >= planQuantity) {
                        return s.done_count;
                    } else {
                        return 0; // Нельзя переводить неполный план
                    }
                }
            },
            get canSubmitMarkCompletion() {
                if (!this.markCompletionStage || !this.markCompletionStage.assigned) return false;
                
                // Проверяем, что все назначения имеют корректные значения
                return this.markCompletionStage.assigned.every(assign => {
                    const completed = parseInt(assign.completed_quantity) || 0;
                    const defective = parseInt(assign.defective_quantity) || 0;
                    const assigned = parseInt(assign.quantity) || 0;
                    
                    // Проверяем корректность значений
                    if (completed < 0 || defective < 0) return false;
                    if ((completed + defective) > assigned) return false;
                    
                    return true;
                });
            },
            get quickAssignmentsMaxQuantity() {
                if (!this.quickAssignmentsStage) return 1;
                
                // Получаем общее количество всех товаров заказа
                let totalOrderItemsQuantity = 0;
                if (this.quickAssignmentsStage.order_item && this.quickAssignmentsStage.order_item.order && this.quickAssignmentsStage.order_item.order.items) {
                    totalOrderItemsQuantity = this.quickAssignmentsStage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                }
                
                // Используем общее количество товаров заказа как план
                const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : this.quickAssignmentsStage.plan_quantity;
                const otherAssigned = (this.quickAssignmentsStage.assigned || []).filter(a => a.id !== this.editingAssignId).reduce((sum, a) => sum + a.quantity, 0);
                const available = Math.max(1, planQuantity - otherAssigned);
                
                return available;
            },
            allWorkshops: [],
            showNoTransferModal: false,
            showNoTransferConfirmModal: false,
            noTransferStageId: null,
            showMarkCompletionModal: false,
            markCompletionStage: null,
            isSubmittingMarkCompletion: false,
            showSimpleCompletionModal: false,
            simpleCompletionStage: null,
            isSubmittingSimpleCompletion: false,
            showQuickAssignmentsModal: false,
            quickAssignmentsStage: null,
            editingAssignId: null,
            showProductsModal: false,
            selectedProductsStage: null,
            toast: { show: false, message: '', type: 'success', timeout: null },
            showToast(msg, type = 'success') {
                this.toast.message = msg;
                this.toast.type = type;
                this.toast.show = true;
                lucide.createIcons();
                if (this.toast.timeout) clearTimeout(this.toast.timeout);
                this.toast.timeout = setTimeout(() => { this.toast.show = false; }, 2500);
            },
            hideToast() {
                this.toast.show = false;
                if (this.toast.timeout) clearTimeout(this.toast.timeout);
            },
            loadingAction: null,
            isSubmitting: false,
            lastActionStageId: null,
            tooltip: null,
            isOnline: navigator.onLine,
            init() {
                window.addEventListener('online', () => { this.isOnline = true; });
                window.addEventListener('offline', () => { this.isOnline = false; });
                this.loadWorkshops();
                lucide.createIcons();
            },
            async loadWorkshops() {
                this.loading = true;
                const resp = await fetch('/api/workshops/api/my-workshops/');
                const data = await resp.json();
                this.workshops = Array.isArray(data) ? data : (data.results || data.workshops || []);
                // Сортируем цеха по возрастанию ID
                this.workshops = this.workshops.slice().sort((a, b) => ((a && a.id) || 0) - ((b && b.id) || 0));
                if (this.workshops.length > 0) {
                    const savedWorkshopId = parseInt(localStorage.getItem('master_selected_workshop_id'));
                    const savedIdx = this.workshops.findIndex(w => w && w.id === savedWorkshopId);
                    this.selectedWorkshopIdx = savedIdx >= 0 ? savedIdx : 0;
                    // Сохраняем текущий выбранный цех, чтобы закрепить поведение по умолчанию
                    const currentWorkshop = this.workshops[this.selectedWorkshopIdx];
                    if (currentWorkshop) {
                        localStorage.setItem('master_selected_workshop_id', currentWorkshop.id);
                    }
                    await this.loadStages();
                }
                
                // Закрываем модальное окно быстрого управления назначениями при загрузке цехов
                if (this.showQuickAssignmentsModal) {
                    this.showQuickAssignmentsModal = false;
                }
                
                this.loading = false;
            },
            async loadAllWorkshops() {
                const resp = await fetch('/api/workshops/api/all/');
                const data = await resp.json();
                this.allWorkshops = Array.isArray(data) ? data : (data.results || []);
                // Сортируем все цеха по возрастанию ID
                this.allWorkshops = this.allWorkshops.slice().sort((a, b) => ((a && a.id) || 0) - ((b && b.id) || 0));
                
                // Закрываем модальное окно быстрого управления назначениями при загрузке всех цехов
                if (this.showQuickAssignmentsModal) {
                    this.showQuickAssignmentsModal = false;
                }
            },
            async loadStages() {
                this.loading = true;
                const workshop = this.workshops[this.selectedWorkshopIdx];
                if (!workshop) return;
                const resp = await fetch(`/orders/api/stages/?workshop=${workshop.id}&status=in_progress`);
                const data = await resp.json();
                this.stages = Array.isArray(data) ? data : (data.results || []);
                
                // DEBUG: Log raw stage data
                console.log('Raw Stage Data:', JSON.stringify(this.stages, null, 2));
                if (this.stages.length > 0) {
                    console.log('First stage:', this.stages[0]);
                    console.log('First stage order_item:', this.stages[0].order_item);
                    if (this.stages[0].order_item) {
                        console.log('First stage order_item.product:', this.stages[0].order_item.product);
                        console.log('First stage order_item.order:', this.stages[0].order_item.order);
                    }
                }
                
                // Закрываем модальное окно быстрого управления назначениями при обновлении этапов
                if (this.showQuickAssignmentsModal) {
                    this.showQuickAssignmentsModal = false;
                }
                
                this.loading = false;
                lucide.createIcons();
                // Автоскролл к этапу после действия
                this.$nextTick(() => {
                    if (this.lastActionStageId) {
                        const el = document.querySelector(`[data-stage-id='${this.lastActionStageId}']`);
                        if (el) {
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        this.lastActionStageId = null;
                    }
                });
            },
            async loadEmployees() {
                const workshop = this.workshops[this.selectedWorkshopIdx];
                if (!workshop) return;
                const resp = await fetch(`/api/workshops/api/employees/?workshop=${workshop.id}`);
                this.employees = await resp.json();
                
                // Закрываем модальное окно быстрого управления назначениями при загрузке сотрудников
                if (this.showQuickAssignmentsModal) {
                    this.showQuickAssignmentsModal = false;
                }
            },
            get filteredEmployees() {
                const stage = this.stages.find(s => s.id === this.assignForm.stage_id);
                if (!stage) return this.employees;
                const assignedIds = (stage.assigned || []).map(a => a.employee_id);
                return this.employees.filter(emp => !assignedIds.includes(emp.id));
            },
            get maxAssignableQuantity() {
                const stage = this.stages.find(s => s.id === this.assignForm.stage_id);
                if (!stage) return 1;
                
                // Получаем общее количество всех товаров заказа
                let totalOrderItemsQuantity = 0;
                if (stage.order_item && stage.order_item.order && stage.order_item.order.items) {
                    totalOrderItemsQuantity = stage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                }
                
                // Используем общее количество товаров заказа как план
                const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : stage.plan_quantity;
                const assigned = (stage.assigned || []).reduce((sum, a) => sum + a.quantity, 0);
                const available = Math.max(0, planQuantity - assigned);
                
                // Нельзя назначать больше плана
                return available;
            },
            get totalBulkAssign() {
                if (!this.bulkAssign) return 0;
                return Object.values(this.bulkAssign).reduce((sum, v) => sum + (parseInt(v) || 0), 0);
            },
            get maxEditableQuantity() {
                const stage = this.stages.find(s => s.id === this.editAssignForm.stage_id);
                if (!stage) return 1;
                
                // Получаем общее количество всех товаров заказа
                let totalOrderItemsQuantity = 0;
                if (stage.order_item && stage.order_item.order && stage.order_item.order.items) {
                    totalOrderItemsQuantity = stage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                }
                
                // Используем общее количество товаров заказа как план
                const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : stage.plan_quantity;
                const otherAssigned = (stage.assigned || []).filter(a => a.id !== this.editAssignForm.id).reduce((sum, a) => sum + a.quantity, 0);
                const available = Math.max(1, planQuantity - otherAssigned);
                
                // Нельзя редактировать больше плана
                return available;
            },
            get nowHour() {
                return new Date().getHours();
            },
            canAssign(stage) {
                // Всегда разрешаем назначать задачи
                return true;
            },
            canTransfer(stage) {
                // Для стеклянных изделий разрешаем перевод только из цеха 12 в цех 2
                const isGlass = !!(stage && stage.order_item && stage.order_item.product && stage.order_item.product.is_glass);
                if (!isGlass) {
                    return true;
                }
                const currentWorkshop = this.workshops[this.selectedWorkshopIdx];
                if (!currentWorkshop) return true;
                // Разрешаем только когда находимся в цехе 12 (целевой выбор будет ограничен до 2)
                return currentWorkshop.id === 12;
            },

            openStageModal(stage) {
                this.selectedStage = stage;
                
                // Закрываем модальное окно быстрого управления назначениями, если оно открыто
                if (this.showQuickAssignmentsModal) {
                    this.showQuickAssignmentsModal = false;
                }
                
                this.showStageModal = true;
                lucide.createIcons();
            },
            
            async openAssignModal(stage) {
                // Получаем общее количество всех товаров заказа
                let totalOrderItemsQuantity = 0;
                if (stage.order_item && stage.order_item.order && stage.order_item.order.items) {
                    totalOrderItemsQuantity = stage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                }
                
                // Используем общее количество товаров заказа как план
                const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : stage.plan_quantity;
                
                // Проверяем, можно ли еще назначать задачи
                const assigned = (stage.assigned || []).reduce((sum, a) => sum + a.quantity, 0);
                if (assigned >= planQuantity) {
                    this.showToast('Все задачи уже назначены!', 'error');
                    return;
                }
                
                // Инициализируем форму и bulkAssign
                this.assignForm = { stage_id: stage.id, employee_id: '', quantity: 1, custom_unit_price: '', layers_per_unit: 1 };
                this.bulkAssign = {};
                
                // Закрываем модальное окно быстрого управления назначениями, если оно открыто
                if (this.showQuickAssignmentsModal) {
                    this.showQuickAssignmentsModal = false;
                }
                
                await this.loadEmployees();
                this.showAssignModal = true;
                lucide.createIcons();
            },
                        async submitAssign() {
                const stage = this.stages.find(s => s.id === this.assignForm.stage_id);
                if (!stage) {
                    this.showToast('Ошибка: этап не найден', 'error');
                    return;
                }
                if (this.totalBulkAssign < 1) {
                    this.showToast('Ошибка: укажите количество для хотя бы одного сотрудника', 'error');
                    return;
                }
                if (this.totalBulkAssign > this.maxAssignableQuantity) {
                    this.showToast('Ошибка: превышено доступное количество к назначению', 'error');
                    return;
                }
                
                // Блокируем кнопку во время выполнения
                this.isSubmitting = true;
                const submitBtn = document.querySelector('[data-submit-assign]');
                if (submitBtn) submitBtn.disabled = true;
                
                try {
                    const entries = Object.entries(this.bulkAssign)
                        .map(([employeeId, qty]) => ({ employee: parseInt(employeeId), quantity: parseInt(qty) || 0 }))
                        .filter(e => e.quantity > 0);
                    
                    // Последовательно или параллельно отправляем назначения
                    const promises = entries.map(e => fetch('/employee_tasks/assign/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCsrfToken() },
                        body: JSON.stringify({ stage: this.assignForm.stage_id, employee: e.employee, quantity: e.quantity, custom_unit_price: this.assignForm.custom_unit_price, layers_per_unit: (this.workshops[this.selectedWorkshopIdx] && this.workshops[this.selectedWorkshopIdx].id === 7) ? (parseInt(this.assignForm.layers_per_unit) || 1) : 1 })
                    }));
                    const results = await Promise.all(promises);
                    const anyFailed = results.some(r => !r.ok);
                    if (anyFailed) {
                        this.showToast('Часть назначений не удалось выполнить', 'error');
                    } else {
                        this.showToast('Назначения успешно созданы!', 'success');
                    }
                    await this.loadStages();
                    this.showAssignModal = false;
                    lucide.createIcons();
                } catch (e) {
                    this.showToast('Ошибка сети при назначении задач', 'error');
                } finally {
                    this.isSubmitting = false;
                    if (submitBtn) submitBtn.disabled = false;
                }
            },
            openEditAssignModal(stage, assign) {
                // Проверяем, можно ли редактировать назначение
                // Редактировать можно всегда, кроме случаев когда сотрудник уже выполнил задачу
                if (assign.completed_quantity && assign.completed_quantity > 0) {
                    this.showToast('Невозможно редактировать: сотрудник уже выполнил часть задачи!', 'error');
                    return;
                }
                
                this.editAssignForm = { id: assign.id, stage_id: stage.id, employee_id: assign.employee_id, employee_name: assign.employee_name, quantity: assign.quantity, custom_unit_price: assign.custom_unit_price || '', layers_per_unit: assign.layers_per_unit || 1 };
                
                // Закрываем модальное окно быстрого управления назначениями, если оно открыто
                if (this.showQuickAssignmentsModal) {
                    this.showQuickAssignmentsModal = false;
                }
                
                this.showEditAssignModal = true;
                lucide.createIcons();
            },
            async submitEditAssign() {
                // Строгая валидация перед отправкой
                const stage = this.stages.find(s => s.id === this.editAssignForm.stage_id);
                if (!stage) {
                    this.showToast('Ошибка: этап не найден', 'error');
                    return;
                }
                
                // Получаем общее количество всех товаров заказа
                let totalOrderItemsQuantity = 0;
                if (stage.order_item && stage.order_item.order && stage.order_item.order.items) {
                    totalOrderItemsQuantity = stage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                }
                
                // Используем общее количество товаров заказа как план
                const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : stage.plan_quantity;
                const otherAssigned = (stage.assigned || []).filter(a => a.id !== this.editAssignForm.id).reduce((sum, a) => sum + a.quantity, 0);
                const availableQuantity = planQuantity - otherAssigned;
                
                if (this.editAssignForm.quantity > availableQuantity) {
                    this.showToast(`Ошибка: превышено плановое количество. Доступно: ${availableQuantity}`, 'error');
                    return;
                }
                
                if (this.editAssignForm.quantity <= 0) {
                    this.showToast('Ошибка: количество должно быть больше 0', 'error');
                    return;
                }
                
                // Блокируем кнопку во время выполнения
                const submitBtn = document.querySelector('[data-submit-edit-assign]');
                if (submitBtn) submitBtn.disabled = true;
                
                try {
                const payload = { quantity: this.editAssignForm.quantity, custom_unit_price: this.editAssignForm.custom_unit_price, layers_per_unit: (this.workshops[this.selectedWorkshopIdx] && this.workshops[this.selectedWorkshopIdx].id === 7) ? (parseInt(this.editAssignForm.layers_per_unit) || 1) : undefined };
                const resp = await fetch(`/employee_tasks/assign/${this.editAssignForm.id}/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCsrfToken() },
                    body: JSON.stringify(payload)
                });
                    
                if (resp.ok) {
                    await this.loadStages();
                    this.showEditAssignModal = false;
                        this.showToast('Назначение успешно обновлено!', 'success');
                    lucide.createIcons();
                    } else {
                        const data = await resp.json();
                        this.showToast(data.error || data.message || 'Ошибка при обновлении назначения', 'error');
                    }
                } catch (e) {
                    this.showToast('Ошибка сети при обновлении назначения', 'error');
                } finally {
                    this.isSubmitting = false;
                    if (submitBtn) submitBtn.disabled = false;
                }
            },
            async deleteAssign(stage, assign) {
                if (!confirm('Удалить назначение?')) return;
                
                // Блокируем кнопку во время выполнения
                const deleteBtn = event.target;
                if (deleteBtn) deleteBtn.disabled = true;
                
                try {
                const resp = await fetch(`/employee_tasks/assign/${assign.id}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': this.getCsrfToken() }
                });
                if (resp.ok) {
                    await this.loadStages();
                        this.showToast('Назначение удалено!', 'success');
                    lucide.createIcons();
                    } else {
                        const data = await resp.json();
                        this.showToast(data.error || data.message || 'Ошибка при удалении назначения', 'error');
                    }
                } catch (e) {
                    this.showToast('Ошибка сети при удалении назначения', 'error');
                } finally {
                    if (deleteBtn) deleteBtn.disabled = false;
                }
            },
            async tabChanged(idx) {
                this.selectedWorkshopIdx = idx;
                const currentWorkshop = this.workshops[this.selectedWorkshopIdx];
                if (currentWorkshop) {
                    localStorage.setItem('master_selected_workshop_id', currentWorkshop.id);
                }
                
                // Закрываем модальное окно быстрого управления назначениями при смене цеха
                if (this.showQuickAssignmentsModal) {
                    this.showQuickAssignmentsModal = false;
                }
                
                await this.loadStages();
                lucide.createIcons();
            },
            openTransferModal(stage) {
                this.transferStageId = stage.id;
                
                // Получаем общее количество всех товаров заказа как план
                let totalOrderItemsQuantity = 0;
                if (stage.order_item && stage.order_item.order && stage.order_item.order.items) {
                    totalOrderItemsQuantity = stage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                }
                const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : stage.plan_quantity;
                
                // Ограничение для стеклянных изделий: перевод только из 12 в 2
                const isGlass = !!(stage && stage.order_item && stage.order_item.product && stage.order_item.product.is_glass);
                const currentWorkshop = this.workshops[this.selectedWorkshopIdx];
                if (isGlass && currentWorkshop && currentWorkshop.id !== 12) {
                    this.showToast('Для стеклянных изделий перевод доступен только из цеха 12 в цех 2', 'error');
                    return;
                }
                
                // Для цеха с ID 1 (распил) можно переводить даже 0, для остальных - только выполненное количество
                if (currentWorkshop && currentWorkshop.id === 1) {
                    this.transferQuantity = Math.max(0, stage.done_count);
                } else {
                    // Для остальных цехов - только если план выполнен полностью
                    if (stage.done_count >= planQuantity) {
                        this.transferQuantity = stage.done_count;
                    } else {
                        this.showToast('Для перевода необходимо выполнить план полностью!', 'error');
                        return;
                    }
                }
                
                // Закрываем модальное окно быстрого управления назначениями, если оно открыто
                if (this.showQuickAssignmentsModal) {
                    this.showQuickAssignmentsModal = false;
                }
                
                // Сначала открываем выбор цеха
                this.openTransferDestination();
            },
            confirmTransferFirst() {
                this.showTransferDestinationModal = false;
                this.showTransferConfirmModal = true;
            },
            
            async selectTransferWorkshop() {
                this.showTransferConfirmModal = false;
                await this.openTransferDestination();
            },
            async openTransferDestination() {
                await this.loadAllWorkshops();
                const currentWorkshop = this.workshops[this.selectedWorkshopIdx];
                const stage = this.stages.find(s => s.id === this.transferStageId);
                const isGlass = !!(stage && stage.order_item && stage.order_item.product && stage.order_item.product.is_glass);
                if (isGlass) {
                    // Для стеклянных изделий целевой цех только 2
                    this.allWorkshops = this.allWorkshops.filter(w => w.id === 2);
                } else {
                    this.allWorkshops = this.allWorkshops.filter(w => !currentWorkshop || w.id !== currentWorkshop.id);
                }
                this.transferTargetWorkshopId = this.allWorkshops.length ? this.allWorkshops[0].id : null;
                this.showTransferDestinationModal = true;
                lucide.createIcons();
            },
            async confirmTransferFinal() {
                // Дополнительная валидация перед отправкой
                const stage = this.stages.find(s => s.id === this.transferStageId);
                const currentWorkshop = this.workshops[this.selectedWorkshopIdx];
                
                if (!stage) {
                    this.showToast('Ошибка: этап не найден', 'error');
                    return;
                }
                
                // Получаем общее количество всех товаров заказа как план
                let totalOrderItemsQuantity = 0;
                if (stage.order_item && stage.order_item.order && stage.order_item.order.items) {
                    totalOrderItemsQuantity = stage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                }
                const planQuantity = totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : stage.plan_quantity;
                
                // Ограничение для стеклянных изделий: перевод только из 12 в 2
                const isGlass = !!(stage && stage.order_item && stage.order_item.product && stage.order_item.product.is_glass);
                if (isGlass) {
                    if (!(currentWorkshop && currentWorkshop.id === 12)) {
                        this.showToast('Для стеклянных изделий перевод возможен только из цеха 12', 'error');
                        return;
                    }
                    if (this.transferTargetWorkshopId !== 2) {
                        this.showToast('Для стеклянных изделий целевой цех должен быть 2', 'error');
                        return;
                    }
                }
                
                // Для цехов кроме распила проверяем выполнение плана
                if (!(currentWorkshop && currentWorkshop.id === 1)) {
                    if (stage.done_count < planQuantity) {
                        this.showToast('Ошибка: для перевода необходимо выполнить план полностью!', 'error');
                        return;
                    }
                }
                
                this.showTransferDestinationModal = false;
                this.loadingAction = 'transfer';
                this.lastActionStageId = this.transferStageId;
                try {
                    const resp = await fetch(`/orders/api/stages/${this.transferStageId}/transfer/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ target_workshop_id: this.transferTargetWorkshopId, completed_quantity: this.transferQuantity })
                    });
                    if (!resp.ok) {
                        const data = await resp.json();
                        this.showToast(data.error || 'Ошибка при переводе этапа!', 'error');
                    } else {
                        // Успешный перевод — закрываем модальные окна подтверждения/выбора
                        this.showTransferConfirmModal = false;
                        this.showTransferDestinationModal = false;
                        this.showTransferModal = false;
                        this.showToast('Этап успешно переведён!', 'success');
                    }
                } catch (e) {
                    this.showToast('Ошибка сети при переводе этапа!', 'error');
                }
                await this.loadStages();
                this.loadingAction = null;
            },
            cancelTransfer() {
                this.showTransferDestinationModal = false;
                this.showTransferConfirmModal = false;
            },

            openNoTransferModal(stage) {
                this.noTransferStageId = stage.id;
                
                // Закрываем модальное окно быстрого управления назначениями, если оно открыто
                if (this.showQuickAssignmentsModal) {
                    this.showQuickAssignmentsModal = false;
                }
                
                this.showNoTransferModal = true;
            },
            confirmNoTransferFirst() {
                this.showNoTransferModal = false;
                this.showNoTransferConfirmModal = true;
            },
            async confirmNoTransferFinal() {
                this.showNoTransferConfirmModal = false;
                this.loadingAction = 'no-transfer';
                this.lastActionStageId = this.noTransferStageId;
                try {
                    const resp = await fetch(`/orders/api/stages/${this.noTransferStageId}/no-transfer/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.getCsrfToken() }
                    });
                    if (!resp.ok) {
                        const data = await resp.json();
                        this.showToast(data.error || 'Ошибка при действии "не переводить"!', 'error');
                    } else {
                        this.showToast('Этап отмечен как "не переводить"', 'success');
                    }
                } catch (e) {
                    this.showToast('Ошибка сети при действии "не переводить"!', 'error');
                }
                await this.loadStages();
                this.loadingAction = null;
            },
            cancelNoTransfer() {
                this.showNoTransferModal = false;
                this.showNoTransferConfirmModal = false;
            },
            
            // Функции для отметки выполнения
            openMarkCompletionModal(stage) {
                this.markCompletionStage = { ...stage };
                // Инициализируем значения для каждого назначения
                if (this.markCompletionStage.assigned) {
                    this.markCompletionStage.assigned = this.markCompletionStage.assigned.map(assign => ({
                        ...assign,
                        completed_quantity: parseInt(assign.completed_quantity) || 0,
                        defective_quantity: parseInt(assign.defective_quantity) || 0
                    }));
                }
                
                // Закрываем модальное окно быстрого управления назначениями, если оно открыто
                if (this.showQuickAssignmentsModal) {
                    this.showQuickAssignmentsModal = false;
                }
                
                this.showMarkCompletionModal = true;
                lucide.createIcons();
            },
            
            async submitMarkCompletion() {
                if (!this.canSubmitMarkCompletion) {
                    this.showToast('Проверьте корректность введенных данных', 'error');
                    return;
                }
                
                this.isSubmittingMarkCompletion = true;
                
                try {
                    // Обновляем каждое назначение
                    const updatePromises = this.markCompletionStage.assigned.map(async (assign) => {
                        const payload = {
                            completed_quantity: assign.completed_quantity || 0,
                            defective_quantity: assign.defective_quantity || 0
                        };
                        
                        const resp = await fetch(`/employee_tasks/assign/${assign.id}/`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!resp.ok) {
                            throw new Error(`Ошибка обновления назначения ${assign.id}`);
                        }
                        
                        return resp.json();
                    });
                    
                    await Promise.all(updatePromises);
                    
                    // Теперь обновляем соответствующие задачи сотрудников для правильного расчета заработка
                    const employeeTaskPromises = this.markCompletionStage.assigned.map(async (assign) => {
                        try {
                            console.log(`Обновляем задачи для сотрудника ${assign.employee_id} на этапе ${this.markCompletionStage.id}`);
                            
                            // Находим соответствующую задачу сотрудника
                            // Сначала пробуем найти по stage ID
                            let employeeTaskResp = await fetch(`/employee_tasks/api/employee-tasks/?employee=${assign.employee_id}&stage=${this.markCompletionStage.id}`);
                            let employeeTasks = [];
                            
                            if (employeeTaskResp.ok) {
                                const employeeTaskData = await employeeTaskResp.json();
                                employeeTasks = Array.isArray(employeeTaskData) ? employeeTaskData : (employeeTaskData.results || []);
                                console.log(`Найдено ${employeeTasks.length} задач для сотрудника ${assign.employee_id} по stage ID`);
                            }
                            
                            // Если не нашли по stage ID, пробуем найти по order_item
                            if (employeeTasks.length === 0 && this.markCompletionStage.order_item) {
                                employeeTaskResp = await fetch(`/employee_tasks/api/employee-tasks/?employee=${assign.employee_id}&order_item=${this.markCompletionStage.order_item.id}`);
                                if (employeeTaskResp.ok) {
                                    const employeeTaskData = await employeeTaskResp.json();
                                    employeeTasks = Array.isArray(employeeTaskData) ? employeeTaskData : (employeeTaskData.results || []);
                                    console.log(`Найдено ${employeeTasks.length} задач для сотрудника ${assign.employee_id} по order_item ID`);
                                }
                            }
                            
                            // Если все еще не нашли, пробуем найти все задачи сотрудника и фильтровать по названию операции
                            if (employeeTasks.length === 0) {
                                employeeTaskResp = await fetch(`/employee_tasks/api/employee-tasks/?employee=${assign.employee_id}`);
                                if (employeeTaskResp.ok) {
                                    const employeeTaskData = await employeeTaskResp.json();
                                    const allTasks = Array.isArray(employeeTaskData) ? employeeTaskData : (employeeTaskData.results || []);
                                    employeeTasks = allTasks.filter(task => 
                                        task.stage_name === this.markCompletionStage.operation ||
                                        task.title === this.markCompletionStage.operation
                                    );
                                    console.log(`Найдено ${employeeTasks.length} задач для сотрудника ${assign.employee_id} по названию операции`);
                                }
                            }
                            
                            console.log(`Итого найдено ${employeeTasks.length} задач для сотрудника ${assign.employee_id}`);
                            
                            // Обновляем каждую найденную задачу сотрудника
                            for (const employeeTask of employeeTasks) {
                                const taskPayload = {
                                    completed_quantity: assign.completed_quantity || 0,
                                    defective_quantity: assign.defective_quantity || 0
                                };
                                
                                console.log(`Обновляем задачу ${employeeTask.id} с данными:`, taskPayload);
                                
                                const updateTaskResp = await fetch(`/employee_tasks/api/employee-tasks/${employeeTask.id}/`, {
                                    method: 'PATCH',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': this.getCsrfToken()
                                    },
                                    body: JSON.stringify(taskPayload)
                                });
                                
                                if (updateTaskResp.ok) {
                                    console.log(`Задача ${employeeTask.id} успешно обновлена`);
                                } else {
                                    console.warn(`Не удалось обновить задачу сотрудника ${employeeTask.id}, статус: ${updateTaskResp.status}`);
                                }
                            }
                            
                            if (employeeTasks.length === 0) {
                                console.warn(`Не найдено задач для сотрудника ${assign.employee_id} на этапе ${this.markCompletionStage.id}`);
                            }
                        } catch (error) {
                            console.warn('Ошибка при обновлении задач сотрудников:', error);
                        }
                    });
                    
                    await Promise.all(employeeTaskPromises);
                    
                    // Специальная логика для цеха 4 (Пресс) - завершаем заказ
                    if (this.workshops[this.selectedWorkshopIdx] && this.workshops[this.selectedWorkshopIdx].id === 4) {
                        try {
                            // Завершаем этап в цехе 4
                            const stageResp = await fetch(`/orders/api/stages/${this.markCompletionStage.id}/confirm/`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': this.getCsrfToken()
                                },
                                body: JSON.stringify({
                                    completed_quantity: this.markCompletionStage.plan_quantity
                                })
                            });
                            
                            if (stageResp.ok) {
                                // Завершаем весь заказ
                                const orderResp = await fetch(`/orders/api/orders/${this.markCompletionStage.order}/`, {
                                    method: 'PATCH',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': this.getCsrfToken()
                                    },
                                    body: JSON.stringify({
                                        status: 'completed'
                                    })
                                });
                                
                                if (orderResp.ok) {
                                    this.showToast('Заказ успешно завершен!', 'success');
                                } else {
                                    this.showToast('Выполнение отмечено, но не удалось завершить заказ', 'warning');
                                }
                            } else {
                                this.showToast('Выполнение отмечено, но не удалось завершить этап', 'warning');
                            }
                        } catch (error) {
                            console.error('Ошибка при завершении заказа:', error);
                            this.showToast('Выполнение отмечено, но произошла ошибка при завершении заказа', 'warning');
                        }
                    }
                    
                    // Обновляем список этапов
                    await this.loadStages();
                    
                    this.showMarkCompletionModal = false;
                    
                    if (!(this.workshops[this.selectedWorkshopIdx] && this.workshops[this.selectedWorkshopIdx].id === 4)) {
                        this.showToast('Выполнение успешно отмечено! Заработок обновлен.', 'success');
                    }
                    
                } catch (error) {
                    console.error('Ошибка при отметке выполнения:', error);
                    this.showToast('Ошибка при сохранении выполнения', 'error');
                } finally {
                    this.isSubmittingMarkCompletion = false;
                }
            },
            
            // Функции для простого подтверждения выполнения (цех 4)
            openSimpleCompletionModal(stage) {
                this.simpleCompletionStage = { ...stage };
                this.showSimpleCompletionModal = true;
                lucide.createIcons();
            },
            
            cancelSimpleCompletion() {
                this.showSimpleCompletionModal = false;
                this.simpleCompletionStage = null;
            },
            
            async confirmSimpleCompletion() {
                if (!this.simpleCompletionStage) return;
                
                this.isSubmittingSimpleCompletion = true;
                
                try {
                    // Завершаем этап в цехе 4
                    const stageResp = await fetch(`/orders/api/stages/${this.simpleCompletionStage.id}/confirm/`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify({
                            completed_quantity: this.simpleCompletionStage.plan_quantity
                        })
                    });
                    
                    if (stageResp.ok) {
                        // Завершаем весь заказ
                        const orderResp = await fetch(`/orders/api/orders/${this.simpleCompletionStage.order}/`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify({
                                status: 'completed'
                            })
                        });
                        
                        if (orderResp.ok) {
                            this.showToast('Заказ успешно завершен!', 'success');
                        } else {
                            this.showToast('Работа выполнена, но не удалось завершить заказ', 'warning');
                        }
                    } else {
                        this.showToast('Ошибка при завершении этапа', 'error');
                    }
                    
                    // Обновляем список этапов
                    await this.loadStages();
                    
                    this.showSimpleCompletionModal = false;
                    this.simpleCompletionStage = null;
                    
                } catch (error) {
                    console.error('Ошибка при завершении заказа:', error);
                    this.showToast('Ошибка при завершении заказа', 'error');
                } finally {
                    this.isSubmittingSimpleCompletion = false;
                }
            },
            
            getTimeUntilDeadline(deadline) {
                if (!deadline) return { text: 'Не указан', isOverdue: false, isUrgent: false };
                
                const now = new Date();
                const deadlineDate = new Date(deadline);
                const diffTime = deadlineDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) {
                    return { 
                        text: `Просрочен на ${Math.abs(diffDays)} дн.`, 
                        isOverdue: true, 
                        isUrgent: false 
                    };
                } else if (diffDays === 0) {
                    return { 
                        text: 'Сегодня', 
                        isOverdue: false, 
                        isUrgent: true 
                    };
                } else if (diffDays === 1) {
                    return { 
                        text: 'Завтра', 
                        isOverdue: false, 
                        isUrgent: true 
                    };
                } else if (diffDays <= 3) {
                    return { 
                        text: `Через ${diffDays} дн.`, 
                        isOverdue: false, 
                        isUrgent: true 
                    };
                } else {
                    return { 
                        text: `Через ${diffDays} дн.`, 
                        isOverdue: false, 
                        isUrgent: false 
                    };
                }
            },
            
            // Функции для быстрого управления назначениями
            openQuickAssignmentsModal(stage) {
                this.quickAssignmentsStage = { ...stage };
                // Инициализируем значения для каждого назначения
                if (this.quickAssignmentsStage.assigned) {
                    this.quickAssignmentsStage.assigned = this.quickAssignmentsStage.assigned.map(assign => ({
                        ...assign,
                        completed_quantity: parseInt(assign.completed_quantity) || 0,
                        defective_quantity: parseInt(assign.defective_quantity) || 0
                    }));
                }
                this.showQuickAssignmentsModal = true;
                lucide.createIcons();
            },
            
            async saveQuickAssignment(assign) {
                try {
                    // Валидация перед сохранением
                    if ((assign.completed_quantity || 0) + (assign.defective_quantity || 0) > assign.quantity) {
                        this.showToast('Ошибка: сумма выполненных и брака превышает назначенное количество', 'error');
                        return;
                    }
                    
                    // Проверяем, не уменьшаем ли мы количество, когда уже есть выполненные задачи
                    const originalAssign = this.stages.find(s => s.id === this.quickAssignmentsStage.id)?.assigned?.find(a => a.id === assign.id);
                    if (originalAssign && originalAssign.completed_quantity > 0 && assign.quantity < originalAssign.quantity) {
                        this.showToast('Ошибка: нельзя уменьшить количество, когда уже есть выполненные задачи!', 'error');
                        return;
                    }
                    
                    // Обновляем назначение
                    const payload = { 
                        quantity: assign.quantity,
                        completed_quantity: assign.completed_quantity || 0,
                        defective_quantity: assign.defective_quantity || 0
                    };
                    const resp = await fetch(`/employee_tasks/assign/${assign.id}/`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCsrfToken() },
                        body: JSON.stringify(payload)
                    });
                    
                    if (resp.ok) {
                        // Обновляем задачи сотрудников для правильного расчета заработка
                        await this.updateEmployeeTasksForAssignment(assign);
                        
                        // Обновляем список этапов
                        await this.loadStages();
                        
                        this.showToast('Назначение успешно обновлено!', 'success');
                        lucide.createIcons();
                    } else {
                        const data = await resp.json();
                        this.showToast(data.error || data.message || 'Ошибка при обновлении назначения', 'error');
                    }
                } catch (e) {
                    this.showToast('Ошибка сети при обновлении назначения', 'error');
                }
            },
            
            async deleteQuickAssignment(stage, assign) {
                if (!confirm('Удалить назначение?')) return;
                
                try {
                    const resp = await fetch(`/employee_tasks/assign/${assign.id}/`, {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': this.getCsrfToken() }
                    });
                    
                    if (resp.ok) {
                        // Обновляем список этапов
                        await this.loadStages();
                        
                        // Обновляем текущий этап в модальном окне
                        if (this.quickAssignmentsStage) {
                            this.quickAssignmentsStage.assigned = this.quickAssignmentsStage.assigned.filter(a => a.id !== assign.id);
                        }
                        
                        this.showToast('Назначение удалено!', 'success');
                        lucide.createIcons();
                    } else {
                        const data = await resp.json();
                        this.showToast(data.error || data.message || 'Ошибка при удалении назначения', 'error');
                    }
                } catch (e) {
                    this.showToast('Ошибка сети при удалении назначения', 'error');
                }
            },
            
            async updateEmployeeTasksForAssignment(assign) {
                try {
                    console.log(`Обновляем задачи для сотрудника ${assign.employee_id} на этапе ${this.quickAssignmentsStage.id}`);
                    
                    // Находим соответствующую задачу сотрудника
                    let employeeTaskResp = await fetch(`/employee_tasks/api/employee-tasks/?employee=${assign.employee_id}&stage=${this.quickAssignmentsStage.id}`);
                    let employeeTasks = [];
                    
                    if (employeeTaskResp.ok) {
                        const employeeTaskData = await employeeTaskResp.json();
                        employeeTasks = Array.isArray(employeeTaskData) ? employeeTaskData : (employeeTaskData.results || []);
                        console.log(`Найдено ${employeeTasks.length} задач для сотрудника ${assign.employee_id} по stage ID`);
                    }
                    
                    // Если не нашли по stage ID, пробуем найти по order_item
                    if (employeeTasks.length === 0 && this.quickAssignmentsStage.order_item) {
                        employeeTaskResp = await fetch(`/employee_tasks/api/employee-tasks/?employee=${assign.employee_id}&order_item=${this.quickAssignmentsStage.order_item.id}`);
                        if (employeeTaskResp.ok) {
                            const employeeTaskData = await employeeTaskResp.json();
                            employeeTasks = Array.isArray(employeeTaskData) ? employeeTaskData : (employeeTaskData.results || []);
                            console.log(`Найдено ${employeeTasks.length} задач для сотрудника ${assign.employee_id} по order_item ID`);
                        }
                    }
                    
                    // Если все еще не нашли, пробуем найти все задачи сотрудника и фильтровать по названию операции
                    if (employeeTasks.length === 0) {
                        employeeTaskResp = await fetch(`/employee_tasks/api/employee-tasks/?employee=${assign.employee_id}`);
                        if (employeeTaskResp.ok) {
                            const employeeTaskData = await employeeTaskResp.json();
                            const allTasks = Array.isArray(employeeTaskData) ? employeeTaskData : (employeeTaskData.results || []);
                            employeeTasks = allTasks.filter(task => 
                                task.stage_name === this.quickAssignmentsStage.operation ||
                                task.title === this.quickAssignmentsStage.operation
                            );
                            console.log(`Найдено ${employeeTasks.length} задач для сотрудника ${assign.employee_id} по названию операции`);
                        }
                    }
                    
                    console.log(`Итого найдено ${employeeTasks.length} задач для сотрудника ${assign.employee_id}`);
                    
                    // Обновляем каждую найденную задачу сотрудника
                    for (const employeeTask of employeeTasks) {
                        const taskPayload = {
                            completed_quantity: assign.completed_quantity || 0,
                            defective_quantity: assign.defective_quantity || 0
                        };
                        
                        console.log(`Обновляем задачу ${employeeTask.id} с данными:`, taskPayload);
                        
                        const updateTaskResp = await fetch(`/employee_tasks/api/employee-tasks/${employeeTask.id}/`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify(taskPayload)
                        });
                        
                        if (updateTaskResp.ok) {
                            console.log(`Задача ${employeeTask.id} успешно обновлена`);
                        } else {
                            console.warn(`Не удалось обновить задачу сотрудника ${employeeTask.id}, статус: ${updateTaskResp.status}`);
                        }
                    }
                    
                    if (employeeTasks.length === 0) {
                        console.warn(`Не найдено задач для сотрудника ${assign.employee_id} на этапе ${this.quickAssignmentsStage.id}`);
                    }
                } catch (error) {
                    console.warn('Ошибка при обновлении задач сотрудников:', error);
                }
            },
            
            getPlanQuantity(stage) {
                let totalOrderItemsQuantity = 0;
                if (stage && stage.order_item && stage.order_item.order && stage.order_item.order.items) {
                    totalOrderItemsQuantity = stage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                }
                return totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : stage.plan_quantity;
            },
            
            getCsrfToken() {
                const name = 'csrftoken';
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        return decodeURIComponent(cookie.substring(name.length + 1));
                    }
                }
                return '';
            },
            openProductsModal(stage) {
                this.selectedProductsStage = stage;
                this.showProductsModal = true;
                lucide.createIcons();
            }
        }
    }
    document.addEventListener('alpine:init', () => {
        Alpine.data('masterPlansPage', masterPlansPage);
    });
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
    });
    </script>
    
    <!-- Quick Assignments Management Modal -->
    <template x-if="showQuickAssignmentsModal">
        <div class="fixed inset-0 z-50 flex items-end justify-center modal-bg" @click.self="showQuickAssignmentsModal = false">
            <div class="modal-content bg-white rounded-t-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-900">Управление назначениями</h2>
                    <button @click="showQuickAssignmentsModal = false" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <!-- Информация о заказе -->
                    <template x-if="quickAssignmentsStage">
                        <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                            <div class="text-sm font-semibold text-blue-800 mb-2">Информация о заказе:</div>
                            <div class="space-y-1 text-xs text-blue-700">
                                <div><span class="font-medium">Заявка:</span> <span x-text="quickAssignmentsStage.order_name || 'Не указано'"></span></div>
                                <div><span class="font-medium">Операция:</span> <span x-text="quickAssignmentsStage.operation || 'Не указано'"></span></div>
                                <div><span class="font-medium">План:</span> <span x-text="(() => {
                                    let totalOrderItemsQuantity = 0;
                                    if (quickAssignmentsStage.order_item && quickAssignmentsStage.order_item.order && quickAssignmentsStage.order_item.order.items) {
                                        totalOrderItemsQuantity = quickAssignmentsStage.order_item.order.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                                    }
                                    return totalOrderItemsQuantity > 0 ? totalOrderItemsQuantity : (quickAssignmentsStage.plan_quantity || 0);
                                })()"></span></div>
                                <div><span class="font-medium">Выполнено:</span> <span x-text="quickAssignmentsStage.done_count || 0"></span></div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Список назначений -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Текущие назначения</label>
                        <template x-if="quickAssignmentsStage && quickAssignmentsStage.assigned && quickAssignmentsStage.assigned.length > 0">
                            <div class="space-y-3">
                                <template x-for="assign in quickAssignmentsStage.assigned" :key="assign.id">
                                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="font-medium text-gray-900" x-text="assign.employee_name"></div>
                                            <div class="text-sm text-gray-600">
                                                Назначено: <span x-text="assign.quantity"></span> шт.
                                            </div>
                                        </div>
                                        
                                        <!-- Поля для быстрого редактирования -->
                                        <div class="grid grid-cols-3 gap-3 mb-2">
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Количество</label>
                                                <input type="number" 
                                                       x-model="assign.quantity" 
                                                       class="w-full px-2 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                       placeholder="1"
                                                       @blur="assign.quantity = Math.max(1, Math.min(parseInt(assign.quantity) || 1, quickAssignmentsMaxQuantity))">
                                                <div class="text-xs text-gray-500 mt-1">
                                                    Максимум: <span x-text="quickAssignmentsMaxQuantity"></span>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Выполнено</label>
                                                <input type="number" 
                                                       x-model="assign.completed_quantity" 
                                                       class="w-full px-2 py-2 border border-gray-300 rounded text-sm"
                                                       placeholder="0"
                                                       @blur="assign.completed_quantity = Math.max(0, Math.min(parseInt(assign.completed_quantity) || 0, assign.quantity))">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Брак</label>
                                                <input type="number" 
                                                       x-model="assign.defective_quantity" 
                                                       class="w-full px-2 py-2 border border-gray-300 rounded text-sm"
                                                       placeholder="0"
                                                       @blur="assign.defective_quantity = Math.max(0, Math.min(parseInt(assign.defective_quantity) || 0, assign.quantity))">
                                            </div>
                                        </div>
                                        
                                        <!-- Валидация -->
                                        <div class="mb-2 text-xs" :class="(assign.completed_quantity || 0) + (assign.defective_quantity || 0) > assign.quantity ? 'text-red-600' : 'text-gray-500'">
                                            <template x-if="(assign.completed_quantity || 0) + (assign.defective_quantity || 0) > assign.quantity">
                                                ⚠️ Сумма выполненных и брака превышает назначенное количество
                                            </template>
                                            <template x-if="(assign.completed_quantity || 0) + (assign.defective_quantity || 0) <= assign.quantity">
                                                Всего: <span x-text="(assign.completed_quantity || 0) + (assign.defective_quantity || 0)"></span> / <span x-text="assign.quantity"></span>
                                            </template>
                                        </div>
                                        
                                        <!-- Кнопки действий -->
                                        <div class="flex space-x-2">
                                            <button @click="saveQuickAssignment(assign)" 
                                                    class="flex-1 px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors font-medium mobile-button">
                                                <i data-lucide="save" class="w-3 h-3 inline mr-1"></i>
                                                Сохранить
                                            </button>
                                            <button @click="deleteQuickAssignment(quickAssignmentsStage, assign)" 
                                                    class="px-4 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors font-medium mobile-button"
                                                    title="Удалить">
                                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="!quickAssignmentsStage || !quickAssignmentsStage.assigned || quickAssignmentsStage.assigned.length === 0">
                            <div class="text-center py-6 text-gray-500">
                                <i data-lucide="user-x" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                                <div>Нет назначений для управления</div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Кнопка добавления нового назначения -->
                    <div class="pt-4 border-t border-gray-200">
                        <button @click="openAssignModal(quickAssignmentsStage)" 
                                class="w-full px-4 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors mobile-button">
                            <i data-lucide="user-plus" class="w-4 h-4 inline mr-2"></i>
                            Добавить новое назначение
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Products Modal -->
    <template x-if="showProductsModal">
        <div class="fixed inset-0 z-50 flex items-end justify-center modal-bg" @click.self="showProductsModal = false">
            <div class="bg-white rounded-t-2xl w-full h-[90vh] flex flex-col animate-slide-up shadow-xl overflow-hidden" style="max-width: 100vw;">
                <div class="flex items-center justify-between px-4 pt-3 pb-1 border-b border-gray-100 sticky top-0 bg-white z-10 min-h-[48px]">
                    <h2 class="text-base font-bold text-gray-900 truncate">
                        Товары заказа: <span x-text="selectedProductsStage ? selectedProductsStage.order_name : ''"></span>
                    </h2>
                    <button @click="showProductsModal = false" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="flex-1 px-4 py-2 overflow-y-auto" style="scroll-behavior: smooth;">
                    <template x-if="selectedProductsStage">
                        <!-- Информация о заказе -->
                        <div class="mb-4">
                            <div class="bg-blue-50 rounded-xl p-4 border-l-4 border-blue-400">
                                <h3 class="font-semibold text-blue-900 mb-2">Информация о заказе</h3>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-blue-700 font-medium">Заказ:</span>
                                        <span class="text-blue-900" x-text="selectedProductsStage.order_name"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-700 font-medium">Операция:</span>
                                        <span class="text-blue-900" x-text="selectedProductsStage.operation"></span>
                                    </div>
                                    <template x-if="selectedProductsStage.order_item && selectedProductsStage.order_item.order && selectedProductsStage.order_item.order.client">
                                        <div class="flex justify-between">
                                            <span class="text-blue-700 font-medium">Клиент:</span>
                                            <span class="text-blue-900" x-text="selectedProductsStage.order_item.order.client.name"></span>
                                        </div>
                                    </template>
                                    <template x-if="selectedProductsStage.order_item && selectedProductsStage.order_item.order && selectedProductsStage.order_item.order.created_at">
                                        <div class="flex justify-between">
                                            <span class="text-blue-700 font-medium">Дата создания:</span>
                                            <span class="text-blue-900" x-text="new Date(selectedProductsStage.order_item.order.created_at).toLocaleDateString('ru-RU')"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Все товары заказа -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900">Все товары заказа</h3>
                            
                            <!-- Debug информация -->
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs">
                                <div class="font-medium text-yellow-800 mb-2">Debug информация:</div>
                                <div x-text="'order_item exists: ' + (selectedProductsStage.order_item ? 'yes' : 'no')"></div>
                                <div x-text="'order exists: ' + (selectedProductsStage.order_item && selectedProductsStage.order_item.order ? 'yes' : 'no')"></div>
                                <div x-text="'items exists: ' + (selectedProductsStage.order_item && selectedProductsStage.order_item.order && selectedProductsStage.order_item.order.items ? 'yes' : 'no')"></div>
                                <div x-text="'items is array: ' + (selectedProductsStage.order_item && selectedProductsStage.order_item.order && selectedProductsStage.order_item.order.items && Array.isArray(selectedProductsStage.order_item.order.items) ? 'yes' : 'no')"></div>
                                <div x-text="'items length: ' + (selectedProductsStage.order_item && selectedProductsStage.order_item.order && selectedProductsStage.order_item.order.items && Array.isArray(selectedProductsStage.order_item.order.items) ? selectedProductsStage.order_item.order.items.length : 'N/A')"></div>
                                <div x-text="'Raw items: ' + JSON.stringify(selectedProductsStage.order_item && selectedProductsStage.order_item.order && selectedProductsStage.order_item.order.items ? selectedProductsStage.order_item.order.items : 'N/A')"></div>
                            </div>
                            
                            <!-- Если есть order_item с items -->
                            <template x-if="selectedProductsStage.order_item && selectedProductsStage.order_item.order && selectedProductsStage.order_item.order.items">
                                <div class="space-y-3">
                                    <!-- Тестовый блок для проверки -->
                                    <div class="bg-red-100 border border-red-300 rounded-lg p-3 text-sm">
                                        <div>Найдено товаров: <span x-text="selectedProductsStage.order_item.order.items.length"></span></div>
                                        <div x-text="'Первый товар: ' + (selectedProductsStage.order_item.order.items[0] ? selectedProductsStage.order_item.order.items[0].product.name : 'нет')"></div>
                                    </div>
                                    
                                    <template x-for="item in selectedProductsStage.order_item.order.items" :key="item.id">
                                        <div class="bg-white border rounded-xl p-4 shadow-sm">
                                            <div class="flex items-start space-x-4">
                                                <!-- Фото товара -->
                                                <template x-if="item.product && item.product.img">
                                                    <div class="flex-shrink-0">
                                                        <img :src="item.product.img" 
                                                             :alt="item.product.name"
                                                             class="w-20 h-20 object-cover rounded-lg border border-gray-200">
                                                    </div>
                                                </template>
                                                
                                                <div class="flex-1">
                                                    <!-- Основная информация -->
                                                    <div class="mb-2">
                                                        <h4 class="font-semibold text-gray-900 text-base" x-text="item.product && item.product.name ? item.product.name : 'Товар'"></h4>
                                                        <div class="text-sm text-gray-600 mt-1">
                                                            <span class="font-medium" x-text="item.quantity"></span> шт.
                                                            <template x-if="item.size"> • <span x-text="item.size"></span></template>
                                                            <template x-if="item.color"> • <span x-text="item.color"></span></template>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Спецификации -->
                                                    <div class="space-y-2">
                                                        <template x-if="item.product && item.product.is_glass">
                                                            <div class="flex items-center text-blue-600 text-sm">
                                                                <i data-lucide="droplets" class="w-4 h-4 mr-2"></i>
                                                                <span>Стекло</span>
                                                            </div>
                                                        </template>
                                                        
                                                        <template x-if="item.paint_type">
                                                            <div class="flex items-center text-purple-600 text-sm">
                                                                <i data-lucide="palette" class="w-4 h-4 mr-2"></i>
                                                                <span x-text="item.paint_type"></span>
                                                                <template x-if="item.paint_color">
                                                                    <span class="ml-1">(<span x-text="item.paint_color"></span>)</span>
                                                                </template>
                                                            </div>
                                                        </template>
                                                        
                                                        <template x-if="item.cnc_specs">
                                                            <div class="flex items-center text-green-600 text-sm">
                                                                <i data-lucide="cpu" class="w-4 h-4 mr-2"></i>
                                                                <span x-text="item.cnc_specs"></span>
                                                            </div>
                                                        </template>
                                                        
                                                        <template x-if="item.cutting_specs">
                                                            <div class="flex items-center text-orange-600 text-sm">
                                                                <i data-lucide="scissors" class="w-4 h-4 mr-2"></i>
                                                                <span x-text="item.cutting_specs"></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                                
                                                <!-- Статус текущего товара -->
                                                <template x-if="item.id === selectedProductsStage.order_item.id">
                                                    <div class="flex-shrink-0">
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                            <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                                                            Текущий
                                                        </span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            
                            <!-- Если есть агрегированные товары -->
                            <template x-if="selectedProductsStage.aggregated_items && Array.isArray(selectedProductsStage.aggregated_items) && selectedProductsStage.aggregated_items.length > 0">
                                <div class="space-y-3">
                                    <template x-for="item in selectedProductsStage.aggregated_items" :key="item.id">
                                        <div class="bg-white border rounded-xl p-4 shadow-sm">
                                            <div class="flex items-start space-x-4">
                                                <!-- Фото товара -->
                                                <template x-if="item.product && item.product.img">
                                                    <div class="flex-shrink-0">
                                                        <img :src="item.product.img" 
                                                             :alt="item.product.name"
                                                             class="w-20 h-20 object-cover rounded-lg border border-gray-200">
                                                    </div>
                                                </template>
                                                
                                                <div class="flex-1">
                                                    <!-- Основная информация -->
                                                    <div class="mb-2">
                                                        <h4 class="font-semibold text-gray-900 text-base" x-text="item.product && item.product.name ? item.product.name : 'Товар'"></h4>
                                                        <div class="text-sm text-gray-600 mt-1">
                                                            <span class="font-medium" x-text="item.quantity"></span> шт.
                                                            <template x-if="item.size"> • <span x-text="item.size"></span></template>
                                                            <template x-if="item.color"> • <span x-text="item.color"></span></template>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Спецификации -->
                                                    <div class="space-y-2">
                                                        <template x-if="item.product && item.product.is_glass">
                                                            <div class="flex items-center text-blue-600 text-sm">
                                                                <i data-lucide="droplets" class="w-4 h-4 mr-2"></i>
                                                                <span>Стекло</span>
                                                            </div>
                                                        </template>
                                                        
                                                        <template x-if="item.paint_type">
                                                            <div class="flex items-center text-purple-600 text-sm">
                                                                <i data-lucide="palette" class="w-4 h-4 mr-2"></i>
                                                                <span x-text="item.paint_type"></span>
                                                                <template x-if="item.paint_color">
                                                                    <span class="ml-1">(<span x-text="item.paint_color"></span>)</span>
                                                                </template>
                                                            </div>
                                                        </template>
                                                        
                                                        <template x-if="item.cnc_specs">
                                                            <div class="flex items-center text-green-600 text-sm">
                                                                <i data-lucide="cpu" class="w-4 h-4 mr-2"></i>
                                                                <span x-text="item.cnc_specs"></span>
                                                            </div>
                                                        </template>
                                                        
                                                        <template x-if="item.cutting_specs">
                                                            <div class="flex items-center text-orange-600 text-sm">
                                                                <i data-lucide="scissors" class="w-4 h-4 mr-2"></i>
                                                                <span x-text="item.cutting_specs"></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            
                            <!-- Альтернативный способ - если товары в другом месте -->
                            <template x-if="selectedProductsStage.order_item && selectedProductsStage.order_item.product">
                                <div class="space-y-3">
                                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                                        <div class="flex items-start space-x-4">
                                            <!-- Фото товара -->
                                            <template x-if="selectedProductsStage.order_item.product.img">
                                                <div class="flex-shrink-0">
                                                    <img :src="selectedProductsStage.order_item.product.img" 
                                                         :alt="selectedProductsStage.order_item.product.name"
                                                         class="w-20 h-20 object-cover rounded-lg border border-gray-200">
                                                </div>
                                            </template>
                                            
                                            <div class="flex-1">
                                                <!-- Основная информация -->
                                                <div class="mb-2">
                                                    <h4 class="font-semibold text-gray-900 text-base" x-text="selectedProductsStage.order_item.product.name || 'Товар'"></h4>
                                                    <div class="text-sm text-gray-600 mt-1">
                                                        <span class="font-medium" x-text="selectedProductsStage.order_item.quantity || 1"></span> шт.
                                                        <template x-if="selectedProductsStage.order_item.size"> • <span x-text="selectedProductsStage.order_item.size"></span></template>
                                                        <template x-if="selectedProductsStage.order_item.color"> • <span x-text="selectedProductsStage.order_item.color"></span></template>
                                                    </div>
                                                </div>
                                                
                                                <!-- Спецификации -->
                                                <div class="space-y-2">
                                                    <template x-if="selectedProductsStage.order_item.product.is_glass">
                                                        <div class="flex items-center text-blue-600 text-sm">
                                                            <i data-lucide="droplets" class="w-4 h-4 mr-2"></i>
                                                            <span>Стекло</span>
                                                            <template x-if="selectedProductsStage.order_item.glass_type">
                                                                <span class="ml-1">— <span x-text="selectedProductsStage.order_item.glass_type"></span></span>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    
                                                    <template x-if="selectedProductsStage.order_item.paint_type">
                                                        <div class="flex items-center text-purple-600 text-sm">
                                                            <i data-lucide="palette" class="w-4 h-4 mr-2"></i>
                                                            <span x-text="selectedProductsStage.order_item.paint_type"></span>
                                                            <template x-if="selectedProductsStage.order_item.paint_color">
                                                                <span class="ml-1">(<span x-text="selectedProductsStage.order_item.paint_color"></span>)</span>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    
                                                    <template x-if="selectedProductsStage.order_item.cnc_specs">
                                                        <div class="flex items-center text-green-600 text-sm">
                                                            <i data-lucide="cpu" class="w-4 h-4 mr-2"></i>
                                                            <span x-text="selectedProductsStage.order_item.cnc_specs"></span>
                                                        </div>
                                                    </template>
                                                    
                                                    <template x-if="selectedProductsStage.order_item.cutting_specs">
                                                        <div class="flex items-center text-orange-600 text-sm">
                                                            <i data-lucide="scissors" class="w-4 h-4 mr-2"></i>
                                                            <span x-text="selectedProductsStage.order_item.cutting_specs"></span>
                                                        </div>
                                                    </template>
                                                    
                                                    <template x-if="selectedProductsStage.order_item.packaging_notes">
                                                        <div class="flex items-center text-indigo-600 text-sm">
                                                            <i data-lucide="package" class="w-4 h-4 mr-2"></i>
                                                            <span x-text="selectedProductsStage.order_item.packaging_notes"></span>
                                                        </div>
                                                    </template>
                                                </div>
                                                
                                                <!-- Дополнительная информация -->
                                                <template x-if="selectedProductsStage.order_item.product.description">
                                                    <div class="mt-2 text-xs text-gray-500">
                                                        <span x-text="selectedProductsStage.order_item.product.description"></span>
                                                    </div>
                                                </template>
                                            </div>
                                            
                                            <!-- Статус текущего товара -->
                                            <div class="flex-shrink-0">
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    <i data-lucide="check" class="w-3 h-3 mr-1"></i>
                                                    Текущий
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Если нет товаров -->
                            <template x-if="(!selectedProductsStage.order_item || !selectedProductsStage.order_item.order || !selectedProductsStage.order_item.order.items || !Array.isArray(selectedProductsStage.order_item.order.items) || selectedProductsStage.order_item.order.items.length === 0) && (!selectedProductsStage.aggregated_items || !Array.isArray(selectedProductsStage.aggregated_items) || selectedProductsStage.aggregated_items.length === 0)">
                                <div class="text-center py-8 text-gray-500">
                                    <i data-lucide="package" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
                                    <div>Товары не указаны</div>
                                    <div class="text-xs mt-2 text-gray-400">
                                        <div>Debug info:</div>
                                        <div x-text="'order_item: ' + (selectedProductsStage.order_item ? 'yes' : 'no')"></div>
                                        <div x-text="'order: ' + (selectedProductsStage.order_item && selectedProductsStage.order_item.order ? 'yes' : 'no')"></div>
                                        <div x-text="'items: ' + (selectedProductsStage.order_item && selectedProductsStage.order_item.order && selectedProductsStage.order_item.order.items ? selectedProductsStage.order_item.order.items.length : 'no')"></div>
                                        <div x-text="'aggregated_items: ' + (selectedProductsStage.aggregated_items ? selectedProductsStage.aggregated_items.length : 'no')"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>
</body>
</html> 