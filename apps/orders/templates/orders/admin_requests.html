<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Администратор заявок</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #e0e7ef; border-radius: 4px; }
        /* .animate-slide-up { animation: slideUp 0.25s cubic-bezier(.4,0,.2,1); } */
        /* @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        aside::-webkit-scrollbar { display: none; } */
        .card-hover { transition: all 0.2s ease-in-out; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="min-h-screen bg-gray-50" x-data="adminData()" x-init="init()">
    {% include 'partials/app_header.html' %}
    {% include 'partials/app_sidebar.html' %}
    
    <!-- Main Content -->
    <main class="flex-1 overflow-hidden ml-64 p-8 pt-32">
        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Администратор заявок</h1>
                    <p class="text-gray-600 text-lg">Управление заявками от бухгалтерии и контроль производственного процесса</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- <a href="/orders/" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-all duration-200 shadow-sm">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                        К заказам
                    </a> -->
                    <button @click="refreshData()" class="inline-flex items-center px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-sm hover:shadow-md">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                        Обновить
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 card-hover">
                <div class="flex items-center">
                    <div class="w-14 h-14 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i data-lucide="clock" class="w-7 h-7 text-white"></i>
                    </div>
                    <div class="ml-5">
                        <p class="text-sm font-medium text-gray-600 mb-1">Ожидают рассмотрения</p>
                        <p class="text-3xl font-bold text-gray-900">{{ stats.pending }}</p>
                        <p class="text-xs text-yellow-600 font-medium">Требуют внимания</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 card-hover">
                <div class="flex items-center">
                    <div class="w-14 h-14 bg-gradient-to-br from-green-400 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i data-lucide="check-circle" class="w-7 h-7 text-white"></i>
                    </div>
                    <div class="ml-5">
                        <p class="text-sm font-medium text-gray-600 mb-1">Одобрены</p>
                        <p class="text-3xl font-bold text-gray-900">{{ stats.approved }}</p>
                        <p class="text-xs text-green-600 font-medium">Переданы в производство</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 card-hover">
                <div class="flex items-center">
                    <div class="w-14 h-14 bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i data-lucide="factory" class="w-7 h-7 text-white"></i>
                    </div>
                    <div class="ml-5">
                        <p class="text-sm font-medium text-gray-600 mb-1">В производстве</p>
                        <p class="text-3xl font-bold text-gray-900">{{ stats.in_production }}</p>
                        <p class="text-xs text-blue-600 font-medium">Активно обрабатываются</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-1">Поиск и фильтрация</h2>
                    <p class="text-gray-600">Найдите нужных клиентов быстро и эффективно</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button @click="toggleView()" class="inline-flex items-center px-3 py-2 text-gray-600 hover:text-gray-900 rounded-lg hover:bg-gray-100 transition-all duration-200">
                        <i data-lucide="grid" x-show="viewMode === 'grid'" class="w-5 h-5"></i>
                        <i data-lucide="list" x-show="viewMode === 'list'" class="w-5 h-5"></i>
                        <span class="ml-2 text-sm font-medium" x-text="viewMode === 'grid' ? 'Сетка' : 'Список'"></span>
                    </button>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="relative flex-1 max-w-md">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                    </div>
                    <input type="text" 
                           x-model="searchTerm" 
                           @input="filterClients()"
                           placeholder="Поиск по имени, компании или телефону..." 
                           class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                </div>
                <select x-model="statusFilter" @change="filterClients()" class="px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white">
                    <option value="">Все статусы</option>
                    <option value="pending">Ожидают</option>
                    <option value="approved">Одобрены</option>
                    <option value="in_production">В производстве</option>
                </select>
            </div>
        </div>

        <!-- Clients Grid -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
            <div class="px-6 py-5 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Клиенты с заявками</h2>
                        <p class="text-gray-600">Выберите клиента для просмотра детальной информации и управления заявками</p>
                    </div>
                    <div class="text-sm text-gray-500 bg-gray-50 px-3 py-2 rounded-lg">
                        Показано: <span x-text="filteredClients.length"></span> из <span x-text="clientsWithRequests.length"></span>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <template x-if="filteredClients.length > 0">
                    <div :class="viewMode === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' : 'space-y-4'">
                        <template x-for="client in filteredClients" :key="client.id">
                            <a :href="`/orders/admin/client/${client.id}/`" class="block">
                                <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl p-6 border border-gray-200 hover:border-blue-300 transition-all duration-300 cursor-pointer group card-hover">
                                    <div class="flex items-start justify-between mb-5">
                                        <div class="flex-1">
                                            <h3 class="text-xl font-bold text-gray-900 group-hover:text-blue-600 transition-colors mb-1" x-text="client.name"></h3>
                                            <div x-show="client.company" class="text-sm text-gray-600 font-medium" x-text="client.company"></div>
                                        </div>
                                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-200 shadow-lg">
                                            <i data-lucide="user" class="w-6 h-6 text-white"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-3 mb-5">
                                        <div x-show="client.phone" class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="phone" class="w-4 h-4 mr-3 text-blue-500"></i>
                                            <span x-text="client.phone"></span>
                                        </div>
                                        
                                        <div x-show="client.email" class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="mail" class="w-4 h-4 mr-3 text-blue-500"></i>
                                            <span x-text="client.email"></span>
                                        </div>
                                        
                                        <div class="flex items-center text-sm text-gray-600">
                                            <i data-lucide="file-text" class="w-4 h-4 mr-3 text-blue-500"></i>
                                            <span x-text="client.requests_count + ' заявок'"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="pt-4 border-t border-gray-200">
                                        <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                                            <span>Последняя заявка:</span>
                                            <span x-text="client.last_request_date"></span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-4">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                    <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                                                    <span x-text="client.pending_count || 0"></span>
                                                </span>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    <i data-lucide="check-circle" class="w-3 h-3 mr-1"></i>
                                                    <span x-text="client.approved_count || 0"></span>
                                                </span>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    <i data-lucide="factory" class="w-3 h-3 mr-1"></i>
                                                    <span x-text="client.in_production_count || 0"></span>
                                                </span>
                                            </div>
                                            <div class="text-blue-600 group-hover:text-blue-700 transition-colors">
                                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </template>
                    </div>
                </template>
                
                <template x-if="filteredClients.length === 0">
                    <div class="text-center py-16">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i data-lucide="users" class="w-10 h-10 text-gray-400"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-900 mb-3">Нет клиентов с заявками</h3>
                        <p class="text-gray-500 max-w-md mx-auto">Заявки от бухгалтерии появятся здесь автоматически. Создайте первую заявку в разделе "Заявки"</p>
                        <div class="mt-6">
                            <a href="{% url 'finance:requests' %}" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                                <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                                Перейти к заявкам
                            </a>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <script>
    function adminData() {
        return {
            searchTerm: '',
            statusFilter: '',
            viewMode: 'grid',
            clientsWithRequests: [],
            filteredClients: [],
            
            init() {
                // Получаем данные из Django контекста
                this.clientsWithRequests = JSON.parse('{{ clients_with_requests_json|escapejs }}');
                this.filterClients();
                this.$nextTick(() => lucide.createIcons());
            },
            
            filterClients() {
                let filtered = this.clientsWithRequests;
                
                // Фильтр по поиску
                if (this.searchTerm) {
                    const term = this.searchTerm.toLowerCase();
                    filtered = filtered.filter(client => 
                        client.name.toLowerCase().includes(term) ||
                        (client.company && client.company.toLowerCase().includes(term)) ||
                        (client.phone && client.phone.includes(term))
                    );
                }
                
                // Фильтр по статусу
                if (this.statusFilter) {
                    filtered = filtered.filter(client => {
                        if (this.statusFilter === 'pending') return client.pending_count > 0;
                        if (this.statusFilter === 'approved') return client.approved_count > 0;
                        if (this.statusFilter === 'in_production') return client.in_production_count > 0;
                        return true;
                    });
                }
                
                this.filteredClients = filtered;
            },
            
            toggleView() {
                this.viewMode = this.viewMode === 'grid' ? 'list' : 'grid';
            },
            
            refreshData() {
                window.location.reload();
            }
        }
    }
    
    document.addEventListener('alpine:init', () => {
        Alpine.data('adminData', adminData);
    });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
</body>
</html> 