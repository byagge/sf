{% extends "admin/base_mobile.html" %}

{% block title %}Активность пользователя - {{ target_user.username }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="fas fa-user-clock"></i> Активность пользователя
                    </h4>
                    <div class="card-tools">
                        <a href="{% url 'online:online_users' %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Назад к списку
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Информация о пользователе -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Информация о пользователе</h6>
                                    <div class="row">
                                        <div class="col-4">
                                            <div class="avatar-lg bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2">
                                                <span class="text-white font-weight-bold h4">
                                                    {{ target_user.first_name|first|upper }}{{ target_user.last_name|first|upper|default:"" }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-8">
                                            <p class="mb-1">
                                                <strong>Имя:</strong> 
                                                {% if target_user.first_name or target_user.last_name %}
                                                    {{ target_user.first_name }} {{ target_user.last_name }}
                                                {% else %}
                                                    Не указано
                                                {% endif %}
                                            </p>
                                            <p class="mb-1">
                                                <strong>Логин:</strong> @{{ target_user.username }}
                                            </p>
                                            <p class="mb-1">
                                                <strong>Email:</strong> {{ target_user.email }}
                                            </p>
                                            <p class="mb-1">
                                                <strong>Роль:</strong>
                                                {% if target_user.is_superuser %}
                                                    <span class="badge badge-danger">Суперпользователь</span>
                                                {% elif target_user.is_staff %}
                                                    <span class="badge badge-warning">Staff</span>
                                                {% else %}
                                                    <span class="badge badge-secondary">Пользователь</span>
                                                {% endif %}
                                            </p>
                                            <p class="mb-0">
                                                <strong>Дата регистрации:</strong> {{ target_user.date_joined|date:"d.m.Y H:i" }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Статистика активности</h6>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="bg-primary text-white rounded p-3 mb-2">
                                                <h4 class="mb-0">{{ total_activities }}</h4>
                                                <small>Всего записей</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="bg-success text-white rounded p-3 mb-2">
                                                <h4 class="mb-0">
                                                    {% for activity in activities %}
                                                        {% if forloop.first %}
                                                            {% if activity.is_online %}
                                                                <i class="fas fa-circle text-success"></i>
                                                            {% else %}
                                                                <i class="fas fa-circle text-secondary"></i>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </h4>
                                                <small>Статус</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <p class="mb-1">
                                            <strong>Последняя активность:</strong><br>
                                            {% for activity in activities %}
                                                {% if forloop.first %}
                                                    <span class="text-muted">
                                                        {{ activity.last_seen|date:"d.m.Y H:i:s" }}
                                                        ({{ activity.last_seen|timesince }} назад)
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- История активности -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-history"></i> История активности
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Дата и время</th>
                                            <th>Время назад</th>
                                            <th>Статус</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for activity in activities %}
                                        <tr>
                                            <td>{{ activity.last_seen|date:"d.m.Y H:i:s" }}</td>
                                            <td>
                                                <span class="text-muted" data-timestamp="{{ activity.last_seen|date:'c' }}">
                                                    {{ activity.last_seen|timesince }} назад
                                                </span>
                                            </td>
                                            <td>
                                                {% if activity.is_online %}
                                                    <span class="badge badge-success">
                                                        <i class="fas fa-circle"></i> Онлайн
                                                    </span>
                                                {% else %}
                                                    <span class="badge badge-secondary">
                                                        <i class="fas fa-circle"></i> Офлайн
                                                    </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">
                                                <i class="fas fa-info-circle"></i> Нет данных об активности
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Обновление времени "назад" каждую минуту
setInterval(() => {
    const timestamps = document.querySelectorAll('[data-timestamp]');
    timestamps.forEach(span => {
        const timestamp = new Date(span.dataset.timestamp);
        span.textContent = formatTimeAgo(timestamp);
    });
}, 60000);

function formatTimeAgo(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diffMs = now - time;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'Только что';
    if (diffMins < 60) return `${diffMins} мин. назад`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours} ч. назад`;
    
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays} дн. назад`;
}
</script>
{% endblock %} 