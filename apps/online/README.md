# Приложение "Онлайн пользователи"

Это приложение отслеживает активность пользователей в системе и отображает всех пользователей, которые находятся в сети.

## Возможности

- Отслеживание активности пользователей в реальном времени
- Отображение списка всех онлайн пользователей
- Детальная информация об активности каждого пользователя
- API для получения данных об онлайн пользователях
- Автоматическое обновление данных каждые 30 секунд
- Доступ только для staff пользователей

## Установка и настройка

### 1. Добавьте приложение в INSTALLED_APPS

В файле `settings.py` добавьте:

```python
INSTALLED_APPS = [
    # ... другие приложения
    'apps.online',
]
```

### 2. Добавьте middleware

В файле `settings.py` добавьте middleware для автоматического отслеживания активности:

```python
MIDDLEWARE = [
    # ... другие middleware
    'apps.online.middleware.UserActivityMiddleware',
]
```

### 3. Выполните миграции

```bash
python manage.py makemigrations online
python manage.py migrate
```

### 4. Инициализируйте активность существующих пользователей

```bash
python manage.py init_user_activity
```

## Использование

### Основные URL

- `/online/` - Список всех онлайн пользователей
- `/online/api/` - API для получения данных об онлайн пользователях
- `/online/user/<id>/` - Детальная информация об активности пользователя

### Команды управления

#### Очистка старых записей активности

```bash
# Показать, что будет удалено (без фактического удаления)
python manage.py cleanup_old_activity --days 30 --dry-run

# Удалить записи старше 30 дней
python manage.py cleanup_old_activity --days 30

# Удалить записи старше 7 дней
python manage.py cleanup_old_activity --days 7
```

#### Инициализация активности пользователей

```bash
# Инициализировать всех пользователей
python manage.py init_user_activity

# Инициализировать конкретных пользователей
python manage.py init_user_activity --users "admin,user1,user2"

# Принудительно обновить существующие записи
python manage.py init_user_activity --force
```

## Модели

### UserActivity

Основная модель для отслеживания активности пользователей:

- `user` - Ссылка на пользователя
- `last_seen` - Время последней активности
- `is_online` - Статус онлайн/офлайн

## API

### GET /online/api/

Возвращает JSON с информацией об онлайн пользователях:

```json
{
    "users": [
        {
            "id": 1,
            "username": "admin",
            "first_name": "Admin",
            "last_name": "User",
            "email": "admin@example.com",
            "last_seen": "2024-01-01T12:00:00Z",
            "is_staff": true,
            "is_superuser": true
        }
    ],
    "total": 1,
    "timestamp": "2024-01-01T12:00:00Z"
}
```

## Безопасность

- Доступ к приложению имеют только staff пользователи
- Все views защищены декораторами `@login_required` и `@user_passes_test`
- API также проверяет права доступа

## Настройка автообновления

По умолчанию данные обновляются каждые 30 секунд. Это можно изменить в JavaScript коде шаблонов.

## Мониторинг и обслуживание

### Рекомендуемые задачи cron

Добавьте в cron задачу для очистки старых записей:

```bash
# Очищать записи старше 30 дней каждый день в 2:00
0 2 * * * cd /path/to/project && python manage.py cleanup_old_activity --days 30
```

### Логирование

Приложение использует стандартное логирование Django. Для отладки можно добавить в `settings.py`:

```python
LOGGING = {
    'loggers': {
        'apps.online': {
            'handlers': ['console'],
            'level': 'DEBUG',
        },
    },
}
```

## Устранение неполадок

### Пользователи не отображаются как онлайн

1. Проверьте, что middleware добавлен в MIDDLEWARE
2. Убедитесь, что пользователи аутентифицированы
3. Проверьте, что записи UserActivity существуют

### Ошибки при миграции

1. Убедитесь, что приложение добавлено в INSTALLED_APPS
2. Проверьте зависимости в миграциях
3. Попробуйте выполнить `python manage.py migrate --fake-initial`

## Разработка

### Добавление новых полей

1. Измените модель в `models.py`
2. Создайте миграцию: `python manage.py makemigrations online`
3. Примените миграцию: `python manage.py migrate`

### Кастомизация шаблонов

Шаблоны находятся в папке `templates/online/` и могут быть переопределены в основном проекте. 