<!DOCTYPE html>
<html lang="ru" x-data="employeeStatsPage()" x-init="init()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Smart Factory">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Статистика (Мастер)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script id="user-id" type="application/json">{{ request.user.id|default:'null' }}</script>
    <script>
      window.user_id = JSON.parse(document.getElementById('user-id').textContent);
      
      // Функция для получения CSRF токена из cookies
      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      
      // Получаем CSRF токен из мета-тега или cookies
      window.csrf_token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || getCookie('csrftoken');
    </script>
    <style>
        body { background: linear-gradient(135deg, #f3f4f6 0%, #dbeafe 100%); }
        .nav-active { color: #2563eb; }
        .nav-bar { box-shadow: 0 -2px 16px 0 rgba(37,99,235,0.08); }
    </style>
</head>
<body class="min-h-screen flex flex-col" style="font-family: system-ui, -apple-system, sans-serif;">
    <!-- AppBar -->
    <header class="fixed top-0 left-0 right-0 z-20 bg-white/90 backdrop-blur border-b border-gray-200 flex items-center justify-between px-4 h-16">
        <div class="flex items-center space-x-3">
            <a href="/employee_tasks/tasks/" class="text-gray-600 hover:text-gray-900">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                <span class="text-white font-bold text-2xl">Z</span>
            </div>
            <span class="text-lg font-semibold text-gray-900">Статистика</span>
        </div>
    </header>
    <!-- Main Content -->
    <main class="flex-1 pt-20 pb-20 px-3 max-w-2xl mx-auto w-full">
        <!-- Overview Cards -->
        <div class="grid grid-cols-2 gap-3 mb-4" x-show="!loading">
            <div class="bg-white rounded-lg p-3 shadow-sm">
                <div class="text-xs text-gray-500 mb-1">Заработок</div>
                <div class="text-lg font-bold text-gray-900" x-text="formatMoney(overview.total_earnings)"></div>
            </div>
            <div class="bg-white rounded-lg p-3 shadow-sm">
                <div class="text-xs text-gray-500 mb-1">Штрафы</div>
                <div class="text-lg font-bold text-gray-900" x-text="formatMoney(overview.total_penalties)"></div>
            </div>
            <div class="bg-white rounded-lg p-3 shadow-sm">
                <div class="text-xs text-gray-500 mb-1">Чистый доход</div>
                <div class="text-lg font-bold text-gray-900" x-text="formatMoney(overview.total_net_earnings)"></div>
            </div>
            <div class="bg-white rounded-lg p-3 shadow-sm">
                <div class="text-xs text-gray-500 mb-1">Задачи</div>
                <div class="text-lg font-bold text-gray-900" x-text="`${overview.completed_tasks}/${overview.total_tasks}`"></div>
            </div>
            <div class="bg-white rounded-lg p-3 shadow-sm col-span-2">
                <div class="text-xs text-gray-500 mb-1">Баланс</div>
                <div class="text-lg font-bold text-gray-900" x-text="formatMoney(balance)"></div>
            </div>
        </div>
        
        <!-- Debug Info and Actions -->
        <!-- <div class="bg-white rounded-lg p-3 shadow-sm mb-4" x-show="!loading">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold text-gray-900">Отладка</h3>
                <button @click="recalculateEarnings()" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                    Пересчитать
                </button>
            </div>
            <div class="text-xs text-gray-600 space-y-1">
                <div>User ID: <span x-text="userId"></span></div>
                <div>Tasks count: <span x-text="tasks.length"></span></div>
                <div>Overview: <span x-text="JSON.stringify(overview)"></span></div>
            </div>
        </div> -->

        <!-- Loading State -->
        <template x-if="loading">
            <div class="space-y-3 animate-pulse">
                <div class="h-24 rounded-lg bg-white"></div>
                <div class="h-40 rounded-lg bg-white"></div>
            </div>
        </template>

        <!-- Monthly Chart-like list (simple) -->
        <div class="bg-white rounded-lg p-3 shadow-sm mb-4" x-show="!loading && monthly.length">
            <div class="flex items-center justify-between mb-2">
                <div class="font-semibold text-gray-900">По месяцам</div>
                <i data-lucide="calendar" class="w-4 h-4 text-gray-400"></i>
            </div>
            <div class="space-y-2">
                <template x-for="m in monthly" :key="m.month">
                    <div class="flex items-center justify-between text-sm">
                        <div class="text-gray-600">Месяц <span x-text="m.month"></span></div>
                        <div class="font-medium text-gray-900" x-text="formatMoney(m.total_net)"></div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Task History -->
        <div class="mb-2 flex items-center justify-between">
            <h2 class="text-lg font-bold text-gray-900">История задач</h2>
            <div class="text-xs text-gray-500" x-text="`Всего: ${tasks.length}`"></div>
        </div>
        <div class="space-y-3">
            <template x-for="task in tasks" :key="task.id">
                <a :href="`/employee_tasks/tasks/${task.id}/`" class="block group">
                    <div class="bg-white rounded-lg p-3 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer border border-transparent hover:border-blue-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-gray-900 text-sm mb-1 group-hover:text-blue-600 transition-colors duration-200" x-text="task.stage_name || ('Этап #' + task.stage)"></div>
                                <div class="text-xs text-gray-600 mb-1" x-text="task.title || ''"></div>
                                <div class="text-xs text-gray-500">
                                    <span>План: <span class="text-gray-900" x-text="getDisplayQuantity(task, 'plan')"></span></span>
                                    <span class="mx-1">•</span>
                                    <span>Выполнено: <span class="text-gray-900" x-text="getDisplayQuantity(task, 'completed')"></span></span>
                                    <template x-if="task.defective_quantity && task.defective_quantity > 0">
                                        <span>
                                            <span class="mx-1">•</span>
                                            <span class="text-red-600">Брак: <span x-text="getDisplayQuantity(task, 'defective')"></span></span>
                                        </span>
                                    </template>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    <span>Создано: <span x-text="formatDate(task.created_at)"></span></span>
                                    <template x-if="task.completed_at">
                                        <span>
                                            <span class="mx-1">•</span>
                                            <span>Завершено: <span x-text="formatDate(task.completed_at)"></span></span>
                                        </span>
                                    </template>
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    <span>Заработок: <span x-text="formatMoney(task.earnings || 0)"></span></span>
                                    <span class="mx-1">•</span>
                                    <span>Штрафы: <span x-text="formatMoney(task.penalties || 0)"></span></span>
                                    <span class="mx-1">•</span>
                                    <span>Чистый: <span x-text="formatMoney(task.net_earnings || 0)"></span></span>
                                </div>
                            </div>
                            <div class="text-right ml-3">
                                <div class="text-xs text-gray-500">Чистый</div>
                                <div class="text-sm font-semibold text-gray-900" x-text="formatMoney(task.net_earnings || 0)"></div>
                                <div class="text-xs text-blue-400 mt-1 group-hover:text-blue-600 transition-colors duration-200">
                                    <i data-lucide="chevron-right" class="w-3 h-3"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </template>
        </div>
    </main>
    <!-- Bottom Navigation -->
    <nav class="nav-bar fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center h-14 z-40 w-full">
        <a href="/employee_tasks/tasks/" class="flex flex-col items-center">
            <i data-lucide="home" class="w-5 h-5"></i>
            <span class="text-xs">Главная</span>
        </a>
        <a href="/notifications/" class="flex flex-col items-center">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span class="text-xs">Уведомления</span>
        </a>
        <a href="/attendance/scan/" class="flex flex-col items-center justify-center w-12 h-12 bg-blue-600 rounded-full -mt-4 shadow-lg">
            <i data-lucide="qr-code" class="w-6 h-6 text-white"></i>
        </a>
        <a href="/employee_tasks/stats/" class="flex flex-col items-center nav-active">
            <i data-lucide="bar-chart" class="w-5 h-5"></i>
            <span class="text-xs">Статистика</span>
        </a>
        <a href="/accounts/profile/" class="flex flex-col items-center">
            <i data-lucide="user" class="w-5 h-5"></i>
            <span class="text-xs">Профиль</span>
        </a>
    </nav>
    <script>
    function employeeStatsPage() {
        return {
            loading: true,
            userId: null,
            overview: { total_earnings: 0, total_penalties: 0, total_net_earnings: 0, total_tasks: 0, completed_tasks: 0 },
            monthly: [],
            tasks: [],
            balance: 0,
            async init() {
                this.userId = JSON.parse(document.getElementById('user-id').textContent) || null;
                await Promise.all([this.loadStats(), this.loadTasks()]);
                this.loading = false;
                lucide.createIcons();
            },
            async loadStats() {
                if (!this.userId) return;
                const resp = await fetch(`/employee_tasks/api/earnings/employee/${this.userId}/`);
                const data = await resp.json();
                this.overview = data.overview || this.overview;
                this.monthly = (data.monthly_stats || []).map(x => ({
                    month: x.month,
                    total_earnings: x.total_earnings,
                    total_penalties: x.total_penalties,
                    total_net: x.total_net
                }));
                this.balance = Number(data.balance || 0);
                console.log('Updated overview:', this.overview);
                console.log('Updated monthly:', this.monthly);
            },
            async loadTasks() {
                if (!this.userId) return;
                const resp = await fetch(`/employee_tasks/api/employee-tasks/?employee=${this.userId}`);
                const data = await resp.json();
                const items = (data.results || data);
                this.tasks = items.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
            },
            formatMoney(v) {
                const num = Number(v || 0);
                return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(num);
            },
            formatDate(iso) {
                if (!iso) return '';
                const d = new Date(iso);
                if (isNaN(d.getTime())) return '';
                return d.toLocaleString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            },
            getDisplayQuantity(task, type) {
                if (!task) return '0';
                
                let quantity = 0;
                if (type === 'plan') {
                    quantity = task.quantity || 0;
                } else if (type === 'completed') {
                    quantity = task.completed_quantity || 0;
                } else if (type === 'defective') {
                    quantity = task.defective_quantity || 0;
                }
                
                return quantity.toString();
            },
            
            // Функция для получения реального количества работы (для расчетов)
            getRealQuantity(task, type) {
                if (!task) return 0;
                
                let quantity = 0;
                if (type === 'plan') {
                    quantity = task.quantity || 0;
                } else if (type === 'completed') {
                    quantity = task.completed_quantity || 0;
                } else if (type === 'defective') {
                    quantity = task.defective_quantity || 0;
                }
                
                return quantity;
            },
            async recalculateEarnings() {
                if (!this.userId) {
                    alert('User ID not available.');
                    return;
                }
                
                // Функция для получения CSRF токена из cookies
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                
                // Получаем актуальный CSRF токен
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                                  getCookie('csrftoken');
                
                if (!csrfToken) {
                    alert('CSRF токен не найден');
                    return;
                }
                
                try {
                    const resp = await fetch(`/employee_tasks/api/earnings/recalculate/${this.userId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        credentials: 'same-origin'
                    });
                    
                    if (resp.ok) {
                        const result = await resp.json();
                        alert(`Заработок пересчитан успешно! ${result.message}`);
                        await this.loadStats(); // Reload stats to update earnings
                    } else {
                        const error = await resp.json();
                        alert(`Ошибка при пересчете заработка: ${error.error || error.detail || 'Неизвестная ошибка'}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert(`Произошла ошибка при пересчете заработка: ${error.message}`);
                }
            }
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
    });
    </script>
</body>
</html>
