<!DOCTYPE html>
<html lang="ru" x-data="mobileProducts()" x-init="init()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>Smart Factory — Продукты</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { background: linear-gradient(135deg, #f3f4f6 0%, #dbeafe 100%); }
        .nav-active { color: #2563eb; }
        .nav-bar { box-shadow: 0 -2px 16px 0 rgba(37,99,235,0.08); }
        .card { box-shadow: 0 2px 12px 0 rgba(0,0,0,0.04); }
        .modal-bg { background: rgba(0,0,0,0.35); }
        .skeleton { background: linear-gradient(90deg, #e0e7ef 25%, #f3f4f6 50%, #e0e7ef 75%); background-size: 200% 100%; animation: skeleton 1.2s infinite linear; }
        @keyframes skeleton { 0% {background-position: 200% 0;} 100% {background-position: -200% 0;} }
    </style>
</head>
<body class="min-h-screen flex flex-col" style="font-family: system-ui, -apple-system, sans-serif;">
    <!-- AppBar -->
    <header class="fixed top-0 left-0 right-0 z-20 bg-white/90 backdrop-blur border-b border-gray-200 flex items-center justify-between px-4 h-16">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                <span class="text-white font-bold text-2xl">S</span>
            </div>
            <span class="text-lg font-semibold text-gray-900">Продукты</span>
        </div>
        <div class="flex items-center space-x-2">
            <!-- <button @click="openAddForm()" class="text-gray-600 hover:text-blue-600" title="Добавить">
                <i data-lucide="plus" class="w-6 h-6"></i>
            </button> -->
            <button @click="window.location.href='/admin/products/product/add/'" class="text-gray-600 hover:text-blue-600" title="Добавить">
                <i data-lucide="plus" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 pt-20 pb-20 px-4 max-w-md mx-auto w-full">
        <!-- Search Bar -->
        <div class="relative mb-6">
            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
            <input type="text" placeholder="Поиск продуктов..." x-model="searchTerm" class="w-full pl-10 pr-4 py-3 bg-white rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- Loading State -->
        <template x-if="loading">
            <div class="space-y-4 animate-pulse">
                <div class="h-20 rounded-xl skeleton"></div>
                <div class="h-20 rounded-xl skeleton"></div>
                <div class="h-20 rounded-xl skeleton"></div>
            </div>
        </template>

        <!-- Products List -->
        <template x-if="!loading">
            <div>
                <template x-if="filteredProducts().length === 0">
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="package" class="w-10 h-10 text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2" x-text="searchTerm ? 'Продукты не найдены' : 'Нет продуктов'"></h3>
                        <p class="text-gray-600" x-text="searchTerm ? 'Попробуйте изменить поиск' : 'Добавьте первый продукт'"></p>
                    </div>
                </template>
                <template x-for="product in filteredProducts()" :key="product.id">
                    <div class="card bg-white rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h3 class="font-semibold text-gray-900 text-base" x-text="product.name"></h3>
                                <p class="text-xs text-gray-500" x-text="product.type_display"></p>
                            </div>
                            <div class="flex space-x-1">
                                <!-- <button @click="openEditForm(product)" class="p-1 text-blue-600 hover:text-blue-800" title="Редактировать">
                                    <i data-lucide="edit-3" class="w-5 h-5"></i>
                                </button>
                                <button @click="deleteProduct(product.id)" class="p-1 text-red-600 hover:text-red-800" title="Удалить">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button> -->
                            </div>
                        </div>
                        <div class="text-sm mb-2"><span class="text-gray-600">Описание:</span> <span x-text="product.description"></span></div>
                        <div class="text-sm mb-2"><span class="text-gray-600">Цена:</span> <span class="text-green-700 font-semibold" x-text="product.price + ' ⃀'"></span></div>
                        <div class="text-sm mb-2"><span class="text-gray-600">Себестоимость:</span> <span class="text-blue-700 font-semibold" x-text="product.cost_price + ' ⃀'"></span></div>
                        <div class="text-sm mb-2"><span class="text-gray-600">Услуги:</span>
                            <template x-for="service in product.services" :key="service.id">
                                <span class="inline-block bg-blue-100 text-blue-800 rounded px-2 py-1 text-xs mr-1 mb-1" x-text="service.name"></span>
                            </template>
                            </div>
                        <div class="text-sm"><span class="text-gray-600">Материалы:</span>
                            <template x-for="mat in product.materials" :key="mat.id">
                                <span class="inline-block bg-gray-100 text-gray-800 rounded px-2 py-1 text-xs mr-1 mb-1" x-text="mat.name + ' (' + mat.amount + ' ' + mat.unit + ')' "></span>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </main>

    <!-- Bottom Navigation -->
    {% include 'partials/bottom_nav_mobile.html' %}



    <!-- Модальное окно редактирования/создания продукта -->
    <template x-if="showForm">
        <div class="fixed inset-0 z-40 flex items-end justify-center modal-bg" @click.self="closeForm()">
            <div class="bg-white rounded-t-2xl w-full max-w-md max-h-[90vh] overflow-hidden">
                <div class="flex items-center justify-between px-4 py-4 border-b border-blue-100 bg-gradient-to-r from-blue-600 to-blue-500">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                            <i data-lucide="box" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-white" x-text="editingProduct ? 'Редактировать продукт' : 'Добавить продукт'"></h2>
                            <p class="text-blue-100 text-xs" x-text="editingProduct ? 'Обновите информацию о продукте' : 'Заполните информацию о новом продукте'"></p>
                        </div>
                    </div>
                    <button @click="closeForm()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20">
                        <i data-lucide="x" class="w-5 h-5 text-white"></i>
                    </button>
                </div>
                <form @submit.prevent="saveProduct()" class="flex-1 flex flex-col justify-between px-4 py-4">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Название продукта *</label>
                            <input type="text" x-model="formData.name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                                    <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Тип продукта *</label>
                            <select x-model="formData.type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="door">Дверь</option>
                                <!-- Можно добавить другие типы -->
                                        </select>
                                    </div>
                                    <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Цена за продукт (⃀) *</label>
                            <input type="number" x-model="formData.price" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                    </div>
                                    <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                            <textarea x-model="formData.description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                                    </div>
                                    <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Услуги</label>
                            <select x-model="formData.service_ids" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <template x-for="service in allServices" :key="service.id">
                                    <option :value="service.id" x-text="service.name"></option>
                                                    </template>
                                                </select>
                                            </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Материалы</label>
                            <template x-for="(mc, idx) in formData.materials_consumption" :key="mc.id || idx">
                                <div class="flex items-center space-x-2 mb-2">
                                    <select x-model.number="mc.material_id" class="border rounded px-2 py-1">
                                        <option value="">Выберите материал</option>
                                        <template x-for="mat in allMaterials" :key="mat.id">
                                            <option :value="mat.id" x-text="mat.name + ' (' + mat.unit + ')' "></option>
                                        </template>
                                    </select>
                                    <input type="number" min="0" step="0.001" x-model="mc.amount" class="border rounded px-2 py-1 w-20" placeholder="Кол-во">
                                    <button type="button" @click="formData.materials_consumption.splice(idx, 1)" class="text-red-600 hover:text-red-800">
                                        <i data-lucide="trash-2"></i>
                                        </button>
                                </div>
                            </template>
                            <button type="button" @click="formData.materials_consumption.push({material_id: '', amount: 0})"
                                class="text-blue-600 hover:text-blue-800 text-sm flex items-center space-x-1 mt-2">
                                <i data-lucide="plus"></i><span>Добавить материал</span>
                            </button>
                                </div>
                            </div>
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 mt-4">
                        <button type="button" @click="closeForm()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 text-sm">Отмена</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm" x-text="editingProduct ? 'Обновить' : 'Добавить'"></button>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <script>
    function mobileProducts() {
        return {
            loading: true,
            products: [],
            allServices: [],
            allMaterials: [],
            searchTerm: '',
            showForm: false,
            editingProduct: null,
            formData: {
                name: '',
                type: 'door',
                description: '',
                price: 0,
                service_ids: [],
                materials_consumption: []
            },
            async init() {
                this.loading = true;
                try {
                    await this.fetchProducts();
                    await this.fetchServices();
                    await this.fetchAllMaterials();
                } catch (e) {}
                this.loading = false;
                lucide.createIcons();
            },
            async fetchProducts() {
                this.loading = true;
                try {
                    const resp = await fetch('/products/api/products/');
                    const data = await resp.json();
                    this.products = Array.isArray(data) ? data : (data.results || []);
                } catch (e) {
                    this.products = [];
                }
                this.loading = false;
            },
            async fetchServices() {
                try {
                    const resp = await fetch('/services/api/services/');
                    const data = await resp.json();
                    this.allServices = data.data || (data.results || []);
                } catch (e) {
                    this.allServices = [];
                }
            },
            async fetchAllMaterials() {
                try {
                    const resp = await fetch('/inventory/api/materials/');
                    const data = await resp.json();
                    this.allMaterials = data.data || [];
                } catch (e) {
                    this.allMaterials = [];
                }
            },
            filteredProducts() {
                if (!this.searchTerm) return this.products;
                const term = this.searchTerm.toLowerCase();
                return this.products.filter(p =>
                    p.name.toLowerCase().includes(term) ||
                    (p.type_display && p.type_display.toLowerCase().includes(term)) ||
                    (p.description && p.description.toLowerCase().includes(term))
                );
            },
            openAddForm() {
                this.formData = { name: '', type: 'door', description: '', price: 0, service_ids: [], materials_consumption: [] };
                this.editingProduct = null;
                this.showForm = true;
                this.$nextTick(() => lucide.createIcons());
            },
            openEditForm(product) {
                let mcs = (product.materials_consumption || []).map(mc => ({
                    id: mc.id,
                    material_id: mc.material_id || mc.material || (mc.material_name ? this.findMaterialIdByName(mc.material_name) : ''),
                    amount: mc.amount
                }));
                if (mcs.length === 0 && product.materials && product.materials.length > 0) {
                    mcs = product.materials.map(mat => ({
                        material_id: mat.id,
                        amount: mat.amount
                    }));
                }
                if (mcs.length === 0) {
                    mcs = [{ material_id: '', amount: 0 }];
                }
                this.formData = {
                    id: product.id,
                    name: product.name,
                    type: product.type,
                    description: product.description,
                    price: product.price,
                    service_ids: product.services.map(s => s.id),
                    materials_consumption: mcs
                };
                this.editingProduct = product;
                this.showForm = true;
                this.$nextTick(() => lucide.createIcons());
            },
            findMaterialIdByName(name) {
                const mat = this.allMaterials.find(m => m.name === name);
                return mat ? mat.id : '';
            },
            closeForm() {
                this.showForm = false;
                this.formData = { name: '', type: 'door', description: '', price: 0, service_ids: [], materials_consumption: [] };
                this.editingProduct = null;
                this.$nextTick(() => lucide.createIcons());
            },
            async saveProduct() {
                this.loading = true;
                const method = this.editingProduct ? 'PUT' : 'POST';
                const url = this.editingProduct ? `/products/api/products/${this.formData.id}/` : '/products/api/products/';
                const body = JSON.stringify({
                    name: this.formData.name,
                    type: this.formData.type,
                    description: this.formData.description,
                    price: this.formData.price,
                    service_ids: this.formData.service_ids,
                    materials_consumption: this.formData.materials_consumption.map(mc => ({
                        id: mc.id,
                        material_id: mc.material_id,
                        amount: mc.amount
                    }))
                });
                try {
                    const resp = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: body
                    });
                    if (resp.ok) {
                        await this.fetchProducts();
                        this.closeForm();
                    }
                } catch (e) {}
                this.loading = false;
            },
            async deleteProduct(id) {
                if (!confirm('Удалить продукт?')) return;
                this.loading = true;
                try {
                    const resp = await fetch(`/products/api/products/${id}/`, { method: 'DELETE' });
                    if (resp.ok) {
                        await this.fetchProducts();
                    }
                } catch (e) {}
                this.loading = false;
            }
        };
    }
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
    });
    </script>
</body>
</html> 