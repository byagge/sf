<!DOCTYPE html>
<html lang="ru" x-data="mobileInventory()" x-init="init()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>Smart Factory — Склад</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { background: linear-gradient(135deg, #f3f4f6 0%, #dbeafe 100%); }
        .nav-active { color: #2563eb; }
        .nav-bar { box-shadow: 0 -2px 16px 0 rgba(37,99,235,0.08); }
        .card { box-shadow: 0 2px 12px 0 rgba(0,0,0,0.04); }
        .modal-bg { background: rgba(0,0,0,0.35); }
        .skeleton { background: linear-gradient(90deg, #e0e7ef 25%, #f3f4f6 50%, #e0e7ef 75%); background-size: 200% 100%; animation: skeleton 1.2s infinite linear; }
        @keyframes skeleton { 0% {background-position: 200% 0;} 100% {background-position: -200% 0;} }
    </style>
</head>
<body class="min-h-screen flex flex-col" style="font-family: system-ui, -apple-system, sans-serif;">
    <!-- AppBar -->
    <header class="fixed top-0 left-0 right-0 z-20 bg-white/90 backdrop-blur border-b border-gray-200 flex items-center justify-between px-4 h-16">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                <span class="text-white font-bold text-2xl">S</span>
            </div>
            <span class="text-lg font-semibold text-gray-900">Склад</span>
        </div>
        <div class="flex items-center space-x-2">
            <button @click="exportToExcel()" class="text-gray-600 hover:text-blue-600" title="Экспорт">
                <i data-lucide="download" class="w-6 h-6"></i>
            </button>
            <button @click="showLowStock = !showLowStock; $nextTick(() => lucide.createIcons())" :class="{'text-red-600': showLowStock}" class="text-gray-600 hover:text-red-600" title="Низкие остатки">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
            </button>
            <button @click="openAddForm()" class="text-gray-600 hover:text-blue-600" title="Добавить">
                <i data-lucide="plus" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 pt-20 pb-20 px-4 max-w-md mx-auto w-full">
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs opacity-90">Общая стоимость</p>
                        <p class="text-xl font-bold" x-text="stats().totalValue.toLocaleString() + ' ⃀'"></p>
                    </div>
                    <i data-lucide="dollar-sign" class="w-6 h-6 opacity-80"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-400 to-blue-500 rounded-xl p-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs opacity-90">Всего материалов</p>
                        <p class="text-xl font-bold" x-text="stats().totalItems"></p>
                    </div>
                    <i data-lucide="package" class="w-6 h-6 opacity-80"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-red-400 to-yellow-500 rounded-xl p-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs opacity-90">Низкие остатки</p>
                        <p class="text-xl font-bold" x-text="stats().lowStockCount"></p>
                    </div>
                    <i data-lucide="alert-triangle" class="w-6 h-6 opacity-80"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-yellow-400 to-pink-500 rounded-xl p-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs opacity-90">Средняя цена</p>
                        <p class="text-xl font-bold" x-text="stats().avgPrice.toLocaleString() + ' ⃀'"></p>
                    </div>
                    <i data-lucide="trending-up" class="w-6 h-6 opacity-80"></i>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="relative mb-6">
            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
            <input type="text" placeholder="Поиск материалов..." x-model="searchTerm" class="w-full pl-10 pr-4 py-3 bg-white rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- Loading State -->
        <template x-if="loading">
            <div class="space-y-4 animate-pulse">
                <div class="h-20 rounded-xl skeleton"></div>
                <div class="h-20 rounded-xl skeleton"></div>
                <div class="h-20 rounded-xl skeleton"></div>
    </div>
        </template>

        <!-- Materials List -->
        <template x-if="!loading">
            <div>
        <template x-if="filteredMaterials().length === 0">
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="package" class="w-10 h-10 text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2" x-text="searchTerm ? 'Материалы не найдены' : 'Нет материалов'"></h3>
                        <p class="text-gray-600" x-text="searchTerm ? 'Попробуйте изменить поиск' : 'Добавьте первый материал'"></p>
            </div>
        </template>
        <template x-for="material in filteredMaterials()" :key="material.id">
                    <div class="card bg-white rounded-xl p-4 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <h3 class="font-semibold text-gray-900 text-base" x-text="material.name"></h3>
                        <p class="text-xs text-gray-500 font-mono" x-text="material.code"></p>
                    </div>
                    <div class="flex space-x-1">
                        <button @click="openEditForm(material)" class="p-1 text-blue-600 hover:text-blue-800" title="Редактировать">
                            <i data-lucide="edit-3" class="w-5 h-5"></i>
                        </button>
                        <button @click="deleteMaterial(material.id)" class="p-1 text-red-600 hover:text-red-800" title="Удалить">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                        <button @click="duplicateMaterial(material)" class="p-1 text-green-600 hover:text-green-800" title="Дублировать">
                            <i data-lucide="copy" class="w-5 h-5"></i>
                        </button>
                                <button @click="openIncomingForm(material)" class="p-1 text-green-600 hover:text-green-800" title="Приход">
                                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                                </button>
                                <button @click="showIncomingHistory(material)" class="p-1 text-blue-600 hover:text-blue-800" title="История приходов">
                                    <i data-lucide="history" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                    <div>
                        <span class="text-gray-400">Размер:</span>
                        <span class="font-medium text-gray-700" x-text="material.size"></span>
                    </div>
                    <div>
                        <span class="text-gray-400">Ед.:</span>
                        <span class="font-medium text-gray-700" x-text="material.unit"></span>
                    </div>
                    <div>
                        <span class="text-gray-400">Кол-во:</span>
                        <span :class="material.quantity <= material.min_quantity ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold'" x-text="material.quantity"></span>
                        <template x-if="material.quantity <= material.min_quantity">
                            <i data-lucide="alert-triangle" class="inline ml-1 text-red-600" style="width: 14px; height: 14px;"></i>
                        </template>
                    </div>
                    <div>
                        <span class="text-gray-400">Мин.:</span>
                        <span class="font-medium text-yellow-600" x-text="material.min_quantity"></span>
                    </div>
                    <div>
                        <span class="text-gray-400">Цена:</span>
                        <span class="font-medium text-gray-700" x-text="material.price.toLocaleString() + ' ⃀'"></span>
                    </div>
                    <div>
                        <span class="text-gray-400">Общая:</span>
                        <span class="font-semibold text-green-600" x-text="material.total_value.toLocaleString() + ' ⃀'"></span>
                    </div>
                </div>
                <div class="text-xs text-gray-400 mt-1" x-text="material.description"></div>
                    </div>
                </template>
            </div>
        </template>
    </main>

    {% include 'partials/bottom_nav_mobile.html' %}

    <!-- Модальные окна (добавление/редактирование/приход) -->
    <!-- Add/Edit Material Modal -->
    <template x-if="showForm">
        <div class="fixed inset-0 z-40 flex items-end justify-center modal-bg" @click.self="closeForm()">
            <div class="bg-white rounded-t-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-900" x-text="editingMaterial ? 'Редактировать материал' : 'Добавить материал'"></h2>
                    <button @click="closeForm()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <form @submit.prevent="saveMaterial()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Название <span class="text-red-500">*</span></label>
                        <input type="text" x-model="formData.name" placeholder="Например: Сталь листовая" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Размер</label>
                        <input type="text" x-model="formData.size" placeholder="2x1000x2000" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Единица <span class="text-red-500">*</span></label>
                            <select x-model="formData.unit" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Выберите...</option>
                                <option value="лист">лист</option>
                                <option value="п.м.">п.м.</option>
                                <option value="кг">кг</option>
                                <option value="шт">шт</option>
                                <option value="м²">м²</option>
                                <option value="м³">м³</option>
                                <option value="л">л</option>
                                <option value="г">г</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Цена (⃀) <span class="text-red-500">*</span></label>
                            <input type="number" x-model="formData.price" min="0" step="0.01" placeholder="0.00" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Количество <span class="text-red-500">*</span></label>
                            <input type="number" x-model="formData.quantity" min="0" step="0.001" placeholder="0" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Мин. остаток <span class="text-red-500">*</span></label>
                            <input type="number" x-model="formData.min_quantity" min="0" step="0.001" placeholder="0" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                        <textarea x-model="formData.description" rows="3" placeholder="Дополнительная информация о материале..." class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" @click="closeForm()" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700">Отмена</button>
                        <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg" x-text="editingMaterial ? 'Обновить' : 'Добавить'"></button>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <!-- Incoming Form Modal -->
    <template x-if="showIncomingForm">
        <div class="fixed inset-0 z-40 flex items-end justify-center modal-bg" @click.self="closeIncomingForm()">
            <div class="bg-white rounded-t-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-900">Приход материала</h2>
                    <button @click="closeIncomingForm()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-gray-900 mb-2" x-text="incomingData.material?.name"></h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div><span class="text-gray-600">Код:</span> <span class="font-medium font-mono" x-text="incomingData.material?.code"></span></div>
                        <div><span class="text-gray-600">Текущее количество:</span> <span class="font-medium text-blue-600" x-text="`${incomingData.material?.quantity || 0} ${incomingData.material?.unit || ''}`"></span></div>
                    </div>
                </div>
                <form @submit.prevent="saveIncoming()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Количество прихода <span class="text-red-500">*</span></label>
                        <input type="number" x-model="incomingData.quantity" min="0.001" step="0.001" placeholder="0" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Цена за единицу (⃀)</label>
                        <input type="number" x-model="incomingData.price_per_unit" min="0" step="0.01" placeholder="0.00" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Примечания</label>
                        <textarea x-model="incomingData.notes" rows="3" placeholder="Дополнительная информация о приходе..." class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" @click="closeIncomingForm()" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700">Отмена</button>
                        <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg">Добавить приход</button>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <!-- Success Modal -->
    <template x-if="showSuccessModal">
        <div class="fixed inset-0 z-50 flex items-center justify-center modal-bg">
            <div class="bg-white rounded-xl p-6 w-full max-w-sm text-center">
                <div class="flex flex-col items-center mb-4">
                    <i data-lucide="check-circle" class="w-12 h-12 text-green-500 mb-3"></i>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Успешно!</h3>
                    <p class="text-gray-700" x-text="successModalText"></p>
                </div>
                <button @click="showSuccessModal = false" class="px-6 py-3 bg-blue-600 text-white rounded-lg">Ок</button>
            </div>
        </div>
    </template>

    <!-- Delete Confirmation Modal -->
    <template x-if="showDeleteModal">
        <div class="fixed inset-0 z-50 flex items-center justify-center modal-bg">
            <div class="bg-white rounded-xl p-6 w-full max-w-sm mx-4">
                <div class="text-center mb-4">
                    <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mx-auto mb-3"></i>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Удалить материал?</h3>
                    <p class="text-gray-600">Это действие нельзя отменить</p>
                </div>
                <div class="flex space-x-3">
                    <button @click="showDeleteModal = false" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700">Отмена</button>
                    <button @click="confirmDeleteMaterial()" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg">Удалить</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Incoming History Modal -->
    <template x-if="showIncomingHistoryModal">
        <div class="fixed inset-0 z-40 flex items-end justify-center modal-bg" @click.self="closeIncomingHistoryModal()">
            <div class="bg-white rounded-t-2xl w-full max-w-md max-h-[90vh] overflow-hidden">
                <div class="flex items-center justify-between p-6 border-b border-gray-200">
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">История приходов</h2>
                        <p class="text-sm text-gray-600" x-text="incomingHistoryData.material?.name"></p>
                    </div>
                    <button @click="closeIncomingHistoryModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="overflow-y-auto max-h-[calc(90vh-80px)]">
                    <template x-if="incomingHistoryData.incomings.length === 0">
                        <div class="text-center py-12">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="package" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Приходов пока нет</h3>
                            <p class="text-gray-600">История приходов будет отображаться здесь</p>
                        </div>
                    </template>
                    <template x-for="(incoming, index) in incomingHistoryData.incomings" :key="incoming.id">
                        <div class="p-4 border-b border-gray-100 last:border-b-0">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                        <i data-lucide="plus" class="w-4 h-4 text-green-600"></i>
                                    </div>
                                    <span class="text-sm font-medium text-gray-900" x-text="`Приход #${index + 1}`"></span>
                                </div>
                                <span class="text-xs text-gray-500" x-text="new Date(incoming.created_at).toLocaleDateString('ru-RU')"></span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm mb-2">
                                <div>
                                    <span class="text-gray-500">Количество:</span>
                                    <span class="font-medium text-green-600 ml-1" x-text="`${incoming.quantity} ${incomingHistoryData.material?.unit}`"></span>
                                </div>
                                <div x-show="incoming.price_per_unit">
                                    <span class="text-gray-500">Цена:</span>
                                    <span class="font-medium text-blue-600 ml-1" x-text="`${incoming.price_per_unit} ⃀`"></span>
                                </div>
                                <div x-show="incoming.total_value" class="col-span-2">
                                    <span class="text-gray-500">Сумма:</span>
                                    <span class="font-semibold text-green-600 ml-1" x-text="`${incoming.total_value} ⃀`"></span>
                                </div>
                            </div>
                            <div x-show="incoming.notes" class="text-sm">
                                <span class="text-gray-500">Примечания:</span>
                                <span class="text-gray-700 ml-1" x-text="incoming.notes"></span>
                            </div>
                            <div class="text-xs text-gray-400 mt-2" x-text="new Date(incoming.created_at).toLocaleString('ru-RU')"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>

    <script>
    function mobileInventory() {
            return {
            loading: true,
            materials: [],
                searchTerm: '',
                sortField: 'name',
                sortDirection: 'asc',
                selectedRows: [],
                editingCell: null,
                editValue: null,
                showForm: false,
                editingMaterial: null,
                formData: {},
                viewMode: 'cards',
                showLowStock: false,
            showSuccessModal: false,
            showDeleteModal: false,
            successModalText: '',
            materialToDelete: null,
                columnLabels: {
                    name: 'Название',
                    code: 'Код',
                    size: 'Размер',
                    unit: 'Единица',
                    quantity: 'Количество',
                    min_quantity: 'Мин. кол-во',
                    price: 'Цена',
                    total_value: 'Общая стоимость'
                },
            // Модальное окно прихода
            showIncomingForm: false,
            incomingData: {
                material: null,
                quantity: 0,
                price_per_unit: '',
                notes: ''
            },
            // Модальное окно истории приходов
            showIncomingHistoryModal: false,
            incomingHistoryData: {
                material: null,
                incomings: []
            },
            // Модальное окно "Другое"
            // showMoreMenu: false, // Removed

            async init() {
                // Инициализируем переменные
                this.materials = [];
                this.searchTerm = '';
                this.sortField = 'name';
                this.sortDirection = 'asc';
                this.selectedRows = [];
                this.editingCell = null;
                this.editValue = null;
                this.showForm = false;
                this.editingMaterial = null;
                this.formData = {};
                this.viewMode = 'cards';
                this.showLowStock = false;
                this.showSuccessModal = false;
                this.showDeleteModal = false;
                this.successModalText = '';
                this.materialToDelete = null;
                this.showIncomingForm = false;
                this.incomingData = {
                    material: null,
                    quantity: 0,
                    price_per_unit: '',
                    notes: ''
                };
                this.showIncomingHistoryModal = false;
                this.incomingHistoryData = {
                    material: null,
                    incomings: []
                };
                // this.showMoreMenu = false; // Removed
                
                await Promise.all([
                    this.fetchMaterials(),
                    this.fetchStats()
                ]);
                this.loading = false;
                lucide.createIcons();
            },

            // Загрузка материалов с API
            async fetchMaterials() {
                try {
                    const resp = await fetch('/inventory/api/materials/');
                    const data = await resp.json();
                    if (data.status === 'success') {
                        this.materials = data.data;
                    }
                } catch (error) {
                    console.error('Error fetching materials:', error);
                    this.materials = [];
                }
            },

            // Загрузка статистики с API
            async fetchStats() {
                try {
                    const resp = await fetch('/inventory/api/materials/stats/');
                    const data = await resp.json();
                    if (data.status === 'success') {
                        this._stats = data.data;
                    }
                } catch (error) {
                    console.error('Error fetching stats:', error);
                    this._stats = null;
                }
            },

            _stats: null,
            stats() {
                return this._stats || { totalValue: 0, lowStockCount: 0, totalItems: 0, avgPrice: 0 };
            },

            // Фильтрация и сортировка материалов
                filteredMaterials() {
                    if (!this.materials || !Array.isArray(this.materials)) {
                        return [];
                    }
                    
                    let filtered = this.materials.filter(material => {
                        if (!material) return false;
                        
                        const searchTerm = this.searchTerm || '';
                        const materialName = material.name || '';
                        const materialCode = material.code || '';
                        const materialSize = material.size || '';
                        
                        const matchesSearch = materialName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            materialCode.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            materialSize.toLowerCase().includes(searchTerm.toLowerCase());
                        const matchesLowStock = !this.showLowStock || (material.quantity <= material.min_quantity);
                        return matchesSearch && matchesLowStock;
                    });
                    
                    if (!this.sortField) return filtered;
                    
                    return filtered.sort((a, b) => {
                        const aValue = a[this.sortField];
                        const bValue = b[this.sortField];
                        
                        if (aValue === null || aValue === undefined) return 1;
                        if (bValue === null || bValue === undefined) return -1;
                        
                        if (typeof aValue === 'string' && typeof bValue === 'string') {
                            return this.sortDirection === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                        }
                        if (typeof aValue === 'number' && typeof bValue === 'number') {
                            return this.sortDirection === 'asc' ? aValue - bValue : bValue - aValue;
                        }
                        return 0;
                    });
                },

            // CRUD операции
            async saveMaterial() {
                try {
                    if (this.editingMaterial) {
                        // update
                        const resp = await fetch(`/inventory/api/materials/${this.formData.id}/update/`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.formData)
                        });
                        const data = await resp.json();
                        if (data.status === 'success') {
                            await this.fetchMaterials();
                            await this.fetchStats();
                            this.closeForm();
                            this.successModalText = 'Материал успешно обновлен!';
                            this.showSuccessModal = true;
                        } else {
                            this.successModalText = 'Ошибка: ' + (data.message || 'Ошибка обновления');
                            this.showSuccessModal = true;
                        }
                    } else {
                        // create
                        const resp = await fetch('/inventory/api/materials/create/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.formData)
                        });
                        const data = await resp.json();
                        if (data.status === 'success') {
                            await this.fetchMaterials();
                            await this.fetchStats();
                            this.closeForm();
                            this.successModalText = 'Материал успешно добавлен!';
                            this.showSuccessModal = true;
                        } else {
                            this.successModalText = 'Ошибка: ' + (data.message || 'Ошибка создания');
                            this.showSuccessModal = true;
                        }
                    }
                } catch (error) {
                    this.successModalText = 'Ошибка сохранения материала';
                    this.showSuccessModal = true;
                }
            },

            async deleteMaterial(id) {
                this.materialToDelete = id;
                this.showDeleteModal = true;
            },

            async confirmDeleteMaterial() {
                if (!this.materialToDelete) return;

                try {
                    const resp = await fetch(`/inventory/api/materials/${this.materialToDelete}/delete/`, { method: 'DELETE' });
                    const data = await resp.json();
                    if (data.status === 'success') {
                        await this.fetchMaterials();
                        await this.fetchStats();
                        this.showDeleteModal = false;
                        this.materialToDelete = null;
                        this.successModalText = 'Материал успешно удален!';
                        this.showSuccessModal = true;
                    } else {
                        this.successModalText = 'Ошибка: ' + (data.message || 'Ошибка удаления');
                        this.showSuccessModal = true;
                    }
                } catch (error) {
                    this.successModalText = 'Ошибка удаления материала';
                    this.showSuccessModal = true;
                }
            },

            // Сортировка
                handleSort(field) {
                    if (this.sortField === field) {
                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortField = field;
                        this.sortDirection = 'asc';
                    }
                },

            // Открытие формы добавления
                openAddForm() {
                    this.formData = {
                        name: '',
                        size: '',
                        unit: '',
                        quantity: 0,
                        min_quantity: 0,
                        price: 0,
                        description: ''
                    };
                    this.editingMaterial = null;
                    this.showForm = true;
                    this.$nextTick(() => lucide.createIcons());
                },

            // Открытие формы редактирования
                openEditForm(material) {
                    this.formData = { ...material };
                    this.editingMaterial = material;
                    this.showForm = true;
                    this.$nextTick(() => lucide.createIcons());
                },

            // Закрытие формы
                closeForm() {
                    this.showForm = false;
                    this.formData = {};
                    this.editingMaterial = null;
                    this.$nextTick(() => lucide.createIcons());
                },

            // Экспорт в Excel
                exportToExcel() {
                    try {
                        // Подготавливаем данные
                        const materials = this.filteredMaterials();
                        if (materials.length === 0) {
                            alert('Нет данных для экспорта');
                            return;
                        }

                        // Создаем рабочую книгу
                        const wb = XLSX.utils.book_new();
                        
                        // Подготавливаем данные для таблицы
                        const excelData = materials.map(material => ({
                            'Название': material.name || '',
                            'Артикул/Код': material.code || '',
                            'Размер': material.size || '',
                            'Единица измерения': material.unit || '',
                            'Количество': material.quantity || 0,
                            'Мин. остаток': material.min_quantity || 0,
                            'Цена за единицу': material.price || 0,
                            'Общая стоимость': material.total_value || 0,
                            'Описание': material.description || '',
                            'Дата создания': material.created_at ? new Date(material.created_at).toLocaleDateString('ru-RU') : '',
                            'Дата обновления': material.updated_at ? new Date(material.updated_at).toLocaleDateString('ru-RU') : ''
                        }));

                        // Создаем лист
                        const ws = XLSX.utils.json_to_sheet(excelData);

                        // Настраиваем ширину столбцов
                        const colWidths = [
                            { wch: 30 }, // Название
                            { wch: 15 }, // Артикул/Код
                            { wch: 15 }, // Размер
                            { wch: 15 }, // Единица измерения
                            { wch: 12 }, // Количество
                            { wch: 12 }, // Мин. остаток
                            { wch: 15 }, // Цена за единицу
                            { wch: 15 }, // Общая стоимость
                            { wch: 40 }, // Описание
                            { wch: 15 }, // Дата создания
                            { wch: 15 }  // Дата обновления
                        ];
                        ws['!cols'] = colWidths;

                        // Добавляем лист в книгу
                        XLSX.utils.book_append_sheet(wb, ws, 'Материалы');

                        // Создаем лист со статистикой
                        const statsData = [
                            { 'Показатель': 'Общее количество материалов', 'Значение': materials.length },
                            { 'Показатель': 'Общая стоимость на складе', 'Значение': this.stats().totalValue.toFixed(2) + ' ⃀' },
                            { 'Показатель': 'Материалы с низким остатком', 'Значение': this.stats().lowStockCount },
                            { 'Показатель': 'Средняя цена', 'Значение': this.stats().avgPrice.toFixed(2) + ' ⃀' },
                            { 'Показатель': 'Дата экспорта', 'Значение': new Date().toLocaleString('ru-RU') }
                        ];
                        
                        const statsWs = XLSX.utils.json_to_sheet(statsData);
                        statsWs['!cols'] = [{ wch: 30 }, { wch: 20 }];
                        XLSX.utils.book_append_sheet(wb, statsWs, 'Статистика');

                        // Экспортируем файл
                        const fileName = `inventory_${new Date().toISOString().split('T')[0]}.xlsx`;
                        XLSX.writeFile(wb, fileName);
                        
                        this.successModalText = 'Экспорт в Excel выполнен успешно!';
                        this.showSuccessModal = true;
                    } catch (error) {
                        console.error('Ошибка экспорта:', error);
                        this.successModalText = 'Ошибка при экспорте: ' + error.message;
                        this.showSuccessModal = true;
                    }
                },

                showHistory(material) {
                    alert(`История изменений для: ${material.name}\n\nСоздано: ${material.created_at}\nПоследнее изменение: ${material.updated_at}`);
                    this.$nextTick(() => lucide.createIcons());
                },

            async duplicateMaterial(material) {
                try {
                    const newMaterial = { ...material };
                    delete newMaterial.id;
                    delete newMaterial.code; // Удаляем код, чтобы он был сгенерирован автоматически
                    delete newMaterial.created_at;
                    delete newMaterial.updated_at;
                    newMaterial.name = material.name + ' (копия)';
                    
                    const resp = await fetch('/inventory/api/materials/create/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newMaterial)
                    });
                    const data = await resp.json();
                    if (data.status === 'success') {
                        await this.fetchMaterials();
                        await this.fetchStats();
                        this.successModalText = 'Материал успешно дублирован!';
                        this.showSuccessModal = true;
                    } else {
                        this.successModalText = 'Ошибка: ' + (data.message || 'Ошибка дублирования');
                        this.showSuccessModal = true;
                    }
                } catch (json) {
                    this.successModalText = 'Ошибка дублирования материала';
                    this.showSuccessModal = true;
                }
            },

            // Модальное окно прихода
            openIncomingForm(material) {
                this.incomingData.material = material;
                this.incomingData.quantity = 0;
                this.incomingData.price_per_unit = '';
                this.incomingData.notes = '';
                this.showIncomingForm = true;
                this.$nextTick(() => lucide.createIcons());
            },

            closeIncomingForm() {
                this.showIncomingForm = false;
                this.incomingData = {
                    material: null,
                    quantity: 0,
                    price_per_unit: '',
                    notes: ''
                };
                this.$nextTick(() => lucide.createIcons());
            },

            async saveIncoming() {
                if (!this.incomingData.material) {
                    this.successModalText = 'Материал не выбран для прихода.';
                    this.showSuccessModal = true;
                    return;
                }
                const quantity = Number(this.incomingData.quantity);
                if (quantity <= 0) {
                    this.successModalText = 'Количество прихода должно быть больше 0.';
                    this.showSuccessModal = true;
                    return;
                }

                try {
                    const data = {
                        material_id: this.incomingData.material.id,
                        quantity: quantity,
                        price_per_unit: this.incomingData.price_per_unit === '' || this.incomingData.price_per_unit === null ? null : Number(this.incomingData.price_per_unit),
                        notes: this.incomingData.notes || null  // Теперь может быть null
                    };

                    const resp = await fetch('/inventory/api/materials/incoming/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await resp.json();

                    if (result.status === 'success') {
                        await this.fetchMaterials();
                        await this.fetchStats();
                        this.closeIncomingForm();
                        this.successModalText = 'Приход успешно добавлен!';
                        this.showSuccessModal = true;
                    } else {
                        this.successModalText = result.message || 'Ошибка добавления прихода';
                        this.showSuccessModal = true;
                    }
                } catch (error) {
                    this.successModalText = 'Ошибка добавления прихода';
                    this.showSuccessModal = true;
                }
                    this.$nextTick(() => lucide.createIcons());
            },

            async showIncomingHistory(material) {
                try {
                    const resp = await fetch(`/inventory/api/materials/${material.id}/incomings/`);
                    const data = await resp.json();
                    
                    if (data.status === 'success') {
                        this.incomingHistoryData.material = material;
                        this.incomingHistoryData.incomings = data.data;
                        this.showIncomingHistoryModal = true;
                    } else {
                        this.successModalText = data.message || 'Ошибка загрузки истории приходов';
                        this.showSuccessModal = true;
                    }
                } catch (error) {
                    this.successModalText = 'Ошибка загрузки истории приходов';
                    this.showSuccessModal = true;
                }
                this.$nextTick(() => lucide.createIcons());
            },

            closeIncomingHistoryModal() {
                this.showIncomingHistoryModal = false;
                this.incomingHistoryData = {
                    material: null,
                    incomings: []
                };
                this.$nextTick(() => lucide.createIcons());
            }
        }
    }

        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
</body>
</html> 