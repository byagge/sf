# Система нескольких мастеров цехов

## Обзор

Система была модифицирована для поддержки назначения нескольких мастеров на один цех. Теперь каждый цех может иметь:

- **Главного мастера** (основной руководитель)
- **Дополнительных мастеров** (помощники руководителя)

## Основные изменения

### 1. Модели

#### Workshop (Цех)
- Поле `manager` теперь называется "Главный руководитель (мастер)"
- Добавлены методы для работы с несколькими мастерами:
  - `get_all_masters()` - возвращает всех мастеров цеха
  - `get_master_names()` - возвращает список имен мастеров
  - `add_master(user)` - добавляет дополнительного мастера
  - `remove_master(user)` - удаляет дополнительного мастера
  - `is_user_master(user)` - проверяет, является ли пользователь мастером

#### WorkshopMaster (Новая модель)
- Связывает мастеров с цехами (многие ко многим)
- Поля:
  - `workshop` - цех
  - `master` - мастер
  - `is_active` - активна ли связь
  - `added_at` - дата назначения
  - `added_by` - кто назначил
  - `notes` - примечания

### 2. Админка

- В админке цеха теперь отображаются все мастера
- Добавлена inline-форма для управления дополнительными мастерами
- Отдельная админка для модели WorkshopMaster

### 3. API

#### Новые endpoints:
- `GET /workshops/api/masters/?workshop={id}` - получить всех мастеров цеха
- `POST /workshops/api/add-master/` - добавить мастера
- `POST /workshops/api/remove-master/` - удалить мастера

#### Обновленные endpoints:
- `GET /workshops/api/my-workshops/` - теперь возвращает роль пользователя в каждом цехе
- `GET /workshops/api/all/` - теперь включает информацию о всех мастерах

### 4. Шаблоны

- Обновлен шаблон `workshops.html` для отображения всех мастеров
- Добавлено модальное окно для управления мастерами
- Кнопки для добавления/удаления мастеров

## Использование

### В админке Django

1. Перейдите в админку → Цеха
2. Выберите цех для редактирования
3. В разделе "Мастера цехов" добавьте дополнительных мастеров
4. Сохраните изменения

### Через API

#### Добавление мастера:
```javascript
const response = await fetch('/workshops/api/add-master/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({
        workshop_id: 1,
        master_id: 5
    })
});
```

#### Удаление мастера:
```javascript
const response = await fetch('/workshops/api/remove-master/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({
        workshop_id: 1,
        master_id: 5
    })
});
```

### В коде Python

#### Получение всех мастеров цеха:
```python
workshop = Workshop.objects.get(id=1)
all_masters = workshop.get_all_masters()
master_names = workshop.get_master_names()
```

#### Проверка, является ли пользователь мастером:
```python
if workshop.is_user_master(user):
    print(f"{user.get_full_name()} является мастером цеха {workshop.name}")
```

#### Добавление мастера:
```python
success, message = workshop.add_master(user)
if success:
    print(message)
else:
    print(f"Ошибка: {message}")
```

#### Удаление мастера:
```python
success, message = workshop.remove_master(user)
if success:
    print(message)
else:
    print(f"Ошибка: {message}")
```

## Права доступа

- **Главный мастер** может:
  - Добавлять дополнительных мастеров
  - Удалять дополнительных мастеров
  - Управлять всеми аспектами цеха

- **Дополнительные мастера** могут:
  - Просматривать информацию о цехе
  - Управлять задачами сотрудников
  - НЕ могут добавлять/удалять других мастеров

## Автоматическое управление ролями

- При назначении мастера роль автоматически меняется на 'master'
- При удалении мастера (если он не является мастером других цехов) роль возвращается к 'worker'
- Система отслеживает все назначения и автоматически управляет ролями

## Миграции

Для применения изменений выполните:

```bash
python manage.py makemigrations
python manage.py migrate
```

## Тестирование

Запустите тестовый скрипт:

```bash
python test_multiple_masters.py
```

## Безопасность

- Только главный мастер может управлять другими мастерами
- Все операции проверяют права доступа
- CSRF-токены обязательны для всех POST-запросов

## Обратная совместимость

- Существующие цеха продолжают работать как прежде
- Поле `manager` остается для главного мастера
- Все существующие API endpoints продолжают работать

## Возможные расширения

1. **Роли мастеров**: разные уровни доступа для дополнительных мастеров
2. **Временные назначения**: мастеры на определенный период
3. **Делегирование полномочий**: временная передача прав главного мастера
4. **Уведомления**: автоматические уведомления при изменении состава мастеров 